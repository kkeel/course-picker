
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 1. Required basics -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary – Planner</title>

  <!-- 2. PWA / App metadata -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#596e5e">

  <!-- iOS support -->
  <link rel="apple-touch-icon" href="./img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- 2.5 MemberStack (must load early to read login state) -->
  <script>
    window.memberstackConfig = {
      useCookies: true,
      setCookieOnRootDomain: true
    };
  </script>
  
  <script
    data-memberstack-app="app_clbb9rspy00160ujl6tsxbsrj"
    src="https://static.memberstack.com/scripts/v1/memberstack.js"
    type="text/javascript">
  </script>

  <!-- 3. Fonts -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
  />

  <!-- 4. CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/schedule.css">
  <link rel="stylesheet" href="css/print-schedule.css">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" type="image/png" href="img/Alveary%20Lt.%20Green.png">
</head>

<body x-data="coursePlanner()" x-init="init()">
  <!-- Auth refresh overlay -->
  <div
    x-show="authRefreshing"
    x-transition.opacity
    x-cloak
    class="fixed inset-0 z-[9999] flex items-center justify-center"
    style="background: rgba(0,0,0,0.25);"
  >
    <div class="bg-white rounded-2xl shadow-xl px-8 py-6 text-center">
      <div class="text-lg font-semibold mb-2">
        Sign in successful
      </div>
      <div class="text-sm opacity-70 mb-4">
        Gathering your schedule info…
      </div>
      <div class="animate-pulse text-sm">
        Loading…
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="app-header mb-8 px-6 md:px-16 py-4 md:py-6 flex flex-col md:flex-row md:items-center gap-4">
    <!-- Logo + wordmark -->
    <a href="https://www.alveary.org/alveary-2026-2027/dashboard" class="logo-link flex items-center gap-3" aria-label="Go to Alveary dashboard">
      <img
        src="img/Alveary%20Lt.%20Green.png"
        alt="Alveary logo"
        class="object-contain"
        style="height: 40px; width: 40px;"
      />
      <div class="logo-text-block">
        <span class="logo-title">Alveary</span>

        <!-- PRINT-ONLY: year under Alveary (left) -->
        <span class="print-year-left">2026–2027</span>
      </div>
    </a>

    <!-- Top-right: staff toggle + nav (screen only) -->
    <div class="mt-3 md:mt-0 md:ml-auto flex items-center justify-end gap-6 text-sm">
      <!-- Auth button: public + members -->
        <button
          id="auth-button"
          class="auth-button text-sm px-3 py-1.5 rounded border border-[#596e5e] text-[#596e5e] hover:bg-[#596e5e] hover:text-white transition"
          x-show="!isAuthed"
          @click="openAuth()"
        >
          Sign in
        </button>
      
      <!-- Staff-only: Edit mode (inline, before nav) -->
      <div
        class="toggle"
        x-show="isStaff"
        style="display:none"
        :class="editMode ? 'toggle--on' : ''"
        @click="toggleEditMode()"
      >
        <div class="toggle-switch">
          <div class="toggle-switch-knob"></div>
        </div>
        <span x-text="editMode ? 'Edit Mode' : 'Published'"></span>
      </div>
    
      <!-- navigation (stepper + menu) -->
      <div id="app-step-nav" class="app-step-nav"></div>
    </div>

    <!-- PRINT-ONLY -->
    <div class="print-header-title-block">
      <div class="print-header-title">Schedule</div>
      <div class="print-header-grade" x-text="gradePrintLabel()"></div>
    </div>
    
  </header>

  <!-- PRINT-ONLY FOOTER -->
  <footer class="print-footer" aria-hidden="true">
    <div class="print-footer-left">Alveary Schedule</div>
    <div class="print-footer-center">©2026 Charlotte Mason Institute® All rights reserved.</div>
    <div class="print-footer-right">
      <span class="print-footer-grade" x-text="gradePrintLabel()"></span>
      <span class="print-page-number"></span>
    </div>
  </footer>

  <!-- Main content -->
  <main class="main-content schedule-main px-6 lg:px-16 pb-16 space-y-10">
    
    <!-- PUBLIC GATE MESSAGE (Course List) -->
    <section x-show="courseGate" x-cloak class="mt-6">
      <h2 class="section-title">Schedule</h2>
    
      <div class="mt-6 p-6 rounded-lg border border-[#d2d6d2] bg-white max-w-2xl">
        <p class="text-sm text-[#596e5e] mb-4">
          This schedule builder is available to Alveary members.
        </p>
        <button
          class="auth-button text-sm px-4 py-2 rounded border border-[#596e5e] text-[#596e5e] hover:bg-[#596e5e] hover:text-white transition"
          @click="openAuth()"
        >
          Sign in to build a schedule
        </button>
      </div>
    </section>

    <div x-show="!courseGate" x-cloak x-data="scheduleBuilder()" x-init="init()">
     <div class="schedule-head">
      <h2 class="section-title">Schedule</h2>
    
      <div class="av-video-inline">
        <a id="avTutorialsInlineLink" class="av-video-row" href="#" target="_blank" rel="noopener">
          <img class="av-play-icon" src="img/icons/play-button.svg" alt="" aria-hidden="true" />
          <span class="av-video-text">Planning App Tutorials</span>
        </a>
      </div>
    </div>

        <div class="schedule-grid mt-6 grid grid-cols-1 lg:grid-cols-[380px_1fr] gap-6">
          
          <!-- Left card rail (Phase 2.5) -->
          <div
            class="sched-rail p-4 rounded-lg border border-[#e5e8e5] bg-white"
          >
            <!-- Sticky / collapsible rail header -->
            <div class="sched-rail-top">
              <div class="sched-rail-head">
                <div class="text-sm font-semibold">Scheduling Cards</div>

                <div class="sched-rail-head-actions">
                  <button type="button" class="sched-rail-btn" @click="openCustomCardModal('create')">
                    + Custom
                  </button>

                  <button
                    type="button"
                    class="sched-rail-collapse-btn"
                    @click="toggleRailTop()"
                    :aria-expanded="(!railTopCollapsed).toString()"
                    :title="railTopCollapsed ? 'Show placement controls' : 'Hide placement controls'"
                  >
                    <svg class="sched-rail-collapse-icon" viewBox="0 0 20 20" aria-hidden="true">
                      <path d="M5.5 7.5l4.5 4.5 4.5-4.5" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Collapsible controls (Place into...) -->
              <div class="sched-rail-top-controls" x-show="!railTopCollapsed" x-transition>
                <div class="sched-rail-sub text-xs opacity-70 mt-1">
                  Place into:
                </div>

                <div class="sched-target mt-2">
                  <select
                    class="sched-target-select"
                    x-model="activeTarget.studentId"
                    @change="ensureStudent(activeTarget.studentId); persistCards()"
                  >
                    <template x-for="s in students" :key="s.id">
                      <option :value="s.id" x-text="s.name"></option>
                    </template>
                  </select>

                  <div class="sched-target-days">
                    <template x-for="(label, i) in dayLabels" :key="i">
                      <button
                        type="button"
                        class="sched-target-day"
                        :class="activeTarget.dayIndex === i ? 'sched-target-day--on' : ''"
                        @click="activeTarget.dayIndex = i; persistCards()"
                        x-text="label"
                      ></button>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scrollable rail content -->
            <div class="sched-rail-body">

              <div class="sched-rail-section-head">Need to schedule:</div>

              <div class="sched-rail-list mt-3">
                <template x-for="entry in railEntriesNeed()" :key="entry.type + ':' + (entry.templateId || entry.courseKey)">
                  <div class="sched-rail-item">
                    <!-- SINGLE template -->
                    <template x-if="entry.type === 'single'">
                      <div>
                        <!-- Row 1: title + minutes -->
                        <div class="sched-rail-row1">
                          <div class="sched-rail-item-title"
                               :title="(templatesById[entry.templateId] || {}).title || ''"
                               x-text="(templatesById[entry.templateId] || {}).title || ''"></div>

                          <div class="sched-rail-row1-right">
                            <div class="sched-rail-item-min"
                                 x-text="`${(templatesById[entry.templateId] || {}).minutes || 0}m`"></div>
                          </div>
                        </div>

                        <!-- Row 2: symbols + (custom edit/delete) + tracker/check -->
                        <div class="sched-rail-row2">
                          <div class="sched-rail-meta-left">
                            <div class="sched-rail-symbols"
                                 x-text="(templatesById[entry.templateId] || {}).symbols || ''"></div>

                            <!-- Custom-only: edit/delete live where symbols normally are -->
                            <div class="sched-rail-custom-inline"
                                 x-show="String(entry.templateId || '').startsWith('u:')">
                              <button type="button"
                                      class="sched-rail-icon-btn"
                                      title="Edit custom card"
                                      @click="openCustomCardModal('edit', entry.templateId)">
                                ✎
                              </button>

                              <button type="button"
                                      class="sched-rail-icon-btn"
                                      title="Remove custom card"
                                      @click="openCustomCardModal('delete', entry.templateId)">
                                ✕
                              </button>
                            </div>
                          </div>

                          <div class="sched-rail-track"
                               x-show="trackingForEntry(entry).show"
                               :class="trackingForEntry(entry).done ? 'is-done' : ''">
                            <template x-if="!trackingForEntry(entry).done">
                              <span x-text="trackingForEntry(entry).label"></span>
                            </template>

                            <template x-if="trackingForEntry(entry).done">
                              <svg class="sched-rail-check" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </template>
                          </div>
                        </div>

                        <!-- Footer: weekdays -->
                        <div class="sched-rail-footer">
                          <div class="sched-rail-daytoggles" aria-label="Scheduled days">
                            <template x-for="(label, i) in dayLabels" :key="i">
                              <button type="button"
                                      class="sched-rail-daytoggle"
                                      :class="isEntryOnDay(activeTarget.studentId, i, entry) ? 'sched-rail-daytoggle--on' : ''"
                                      @click="toggleEntryOnDay(entry, i)"
                                      :title="`Toggle ${label}`">
                                <span x-text="dayShortLabels[i]"></span>
                              </button>
                            </template>
                          </div>
                        </div>
                      </div>
                    </template>

                    <!-- GROUP template (grade-band / choice-based) -->
                    <template x-if="entry.type === 'group'">
                      <div>
                        <!-- Row 1: title + minutes -->
                        <div class="sched-rail-row1">
                          <div class="sched-rail-item-title"
                               :title="railEntryDisplay(entry).title || ''"
                               x-text="railEntryDisplay(entry).title || ''"></div>

                          <div class="sched-rail-row1-right">
                            <div class="sched-rail-item-min"
                                 x-text="`${railEntryDisplay(entry).minutes || 0}m`"></div>
                          </div>
                        </div>

                        <!-- Row 2: symbols + chosen grade text + tracker/check -->
                        <div class="sched-rail-row2">
                          <div class="sched-rail-meta-left">
                            <div class="sched-rail-symbols"
                                 x-text="railEntryDisplay(entry).symbols || ''"></div>

                            <div class="sched-rail-grade"
                                 x-show="railEntryDisplay(entry).sub"
                                 x-text="railEntryDisplay(entry).sub"></div>
                          </div>

                          <div class="sched-rail-track"
                               x-show="trackingForEntry(entry).show"
                               :class="trackingForEntry(entry).done ? 'is-done' : ''">
                            <template x-if="!trackingForEntry(entry).done">
                              <span x-text="trackingForEntry(entry).label"></span>
                            </template>

                            <template x-if="trackingForEntry(entry).done">
                              <svg class="sched-rail-check" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </template>
                          </div>
                        </div>

                        <!-- Footer: choose grades (left) + weekdays (right) -->
                        <div class="sched-rail-footer">
                          <div class="sched-rail-footer-left" aria-label="Choose grades">
                            <div class="sched-rail-grade-select-wrap">
                              <select
                                class="sched-rail-grade-select"
                                x-model="choices.courseOptions[entry.courseKey]"
                                @change="setCourseOption(entry.courseKey, choices.courseOptions[entry.courseKey])"
                                aria-label="Grade band"
                              >
                                <template x-for="opt in entry.options" :key="opt.option">
                                  <option :value="opt.option" x-text="`Grades ${opt.label}`"></option>
                                </template>
                              </select>

                              <svg class="sched-rail-grade-chevron" viewBox="0 0 20 20" aria-hidden="true">
                                <path d="M5.5 7.5l4.5 4.5 4.5-4.5" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </div>
                          </div>

                          <div class="sched-rail-daytoggles" aria-label="Scheduled days">
                            <template x-for="(label, i) in dayLabels" :key="i">
                              <button type="button"
                                      class="sched-rail-daytoggle"
                                      :class="isEntryOnDay(activeTarget.studentId, i, entry) ? 'sched-rail-daytoggle--on' : ''"
                                      @click="toggleEntryOnDay(entry, i)"
                                      :title="`Toggle ${label}`">
                                <span x-text="dayShortLabels[i]"></span>
                              </button>
                            </template>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
              </div>

              <template x-if="railEntriesComplete().length">
                <div class="sched-rail-complete-wrap">
                  <div class="sched-rail-sep"></div>

                  <div class="sched-rail-section-row">
                    <div class="sched-rail-section-head">Complete:</div>
                    <button type="button"
                            class="sched-rail-toggle"
                            @click="toggleCompletedRail()"
                            x-text="completedRailLabel()"></button>
                  </div>

                  <template x-if="showCompleted">
                    <div class="sched-rail-list mt-2">
                      <template x-for="entry in railEntriesComplete()" :key="entry.type + ':' + (entry.templateId || entry.courseKey)">
                        <div class="sched-rail-item">
                          <!-- reuse the same SINGLE/GROUP markup (kept identical for consistency) -->
                          <template x-if="entry.type === 'single'">
                            <div>
                              <div class="sched-rail-row1">
                                <div class="sched-rail-item-title"
                                     :title="(templatesById[entry.templateId] || {}).title || ''"
                                     x-text="(templatesById[entry.templateId] || {}).title || ''"></div>

                                <div class="sched-rail-row1-right">
                                  <div class="sched-rail-item-min"
                                       x-text="`${(templatesById[entry.templateId] || {}).minutes || 0}m`"></div>
                                </div>
                              </div>

                              <div class="sched-rail-row2">
                                <div class="sched-rail-meta-left">
                                  <div class="sched-rail-symbols"
                                       x-text="(templatesById[entry.templateId] || {}).symbols || ''"></div>

                                  <div class="sched-rail-custom-inline"
                                       x-show="String(entry.templateId || '').startsWith('u:')">
                                    <button type="button"
                                            class="sched-rail-icon-btn"
                                            title="Edit custom card"
                                            @click="openCustomCardModal('edit', entry.templateId)">
                                      ✎
                                    </button>

                                    <button type="button"
                                            class="sched-rail-icon-btn"
                                            title="Remove custom card"
                                            @click="openCustomCardModal('delete', entry.templateId)">
                                      ✕
                                    </button>
                                  </div>
                                </div>

                                <div class="sched-rail-track"
                                     x-show="trackingForEntry(entry).show"
                                     :class="trackingForEntry(entry).done ? 'is-done' : ''">
                                  <template x-if="trackingForEntry(entry).done">
                                    <svg class="sched-rail-check" viewBox="0 0 24 24" aria-hidden="true">
                                      <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                  </template>
                                </div>
                              </div>

                              <div class="sched-rail-footer">
                                <div class="sched-rail-daytoggles" aria-label="Scheduled days">
                                  <template x-for="(label, i) in dayLabels" :key="i">
                                    <button type="button"
                                            class="sched-rail-daytoggle"
                                            :class="isEntryOnDay(activeTarget.studentId, i, entry) ? 'sched-rail-daytoggle--on' : ''"
                                            @click="toggleEntryOnDay(entry, i)"
                                            :title="`Toggle ${label}`">
                                      <span x-text="dayShortLabels[i]"></span>
                                    </button>
                                  </template>
                                </div>
                              </div>
                            </div>
                          </template>

                          <template x-if="entry.type === 'group'">
                            <div>
                              <div class="sched-rail-row1">
                                <div class="sched-rail-item-title"
                                     :title="railEntryDisplay(entry).title || ''"
                                     x-text="railEntryDisplay(entry).title || ''"></div>

                                <div class="sched-rail-row1-right">
                                  <div class="sched-rail-item-min"
                                       x-text="`${railEntryDisplay(entry).minutes || 0}m`"></div>
                                </div>
                              </div>

                              <div class="sched-rail-row2">
                                <div class="sched-rail-meta-left">
                                  <div class="sched-rail-symbols"
                                       x-text="railEntryDisplay(entry).symbols || ''"></div>

                                  <div class="sched-rail-grade"
                                       x-show="railEntryDisplay(entry).sub"
                                       x-text="railEntryDisplay(entry).sub"></div>
                                </div>

                                <div class="sched-rail-track"
                                     x-show="trackingForEntry(entry).show"
                                     :class="trackingForEntry(entry).done ? 'is-done' : ''">
                                  <template x-if="trackingForEntry(entry).done">
                                    <svg class="sched-rail-check" viewBox="0 0 24 24" aria-hidden="true">
                                      <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                  </template>
                                </div>
                              </div>

                              <div class="sched-rail-footer">
                                <div class="sched-rail-footer-left" aria-label="Choose grades">
                                  <div class="sched-rail-grade-select-wrap">
                                    <select
                                      class="sched-rail-grade-select"
                                      x-model="choices.courseOptions[entry.courseKey]"
                                      @change="setCourseOption(entry.courseKey, choices.courseOptions[entry.courseKey])"
                                      aria-label="Grade band"
                                    >
                                      <template x-for="opt in entry.options" :key="opt.option">
                                        <option :value="opt.option" x-text="`Grades ${opt.label}`"></option>
                                      </template>
                                    </select>

                                    <svg class="sched-rail-grade-chevron" viewBox="0 0 20 20" aria-hidden="true">
                                      <path d="M5.5 7.5l4.5 4.5 4.5-4.5" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                  </div>
                                </div>

                                <div class="sched-rail-daytoggles" aria-label="Scheduled days">
                                  <template x-for="(label, i) in dayLabels" :key="i">
                                    <button type="button"
                                            class="sched-rail-daytoggle"
                                            :class="isEntryOnDay(activeTarget.studentId, i, entry) ? 'sched-rail-daytoggle--on' : ''"
                                            @click="toggleEntryOnDay(entry, i)"
                                            :title="`Toggle ${label}`">
                                      <span x-text="dayShortLabels[i]"></span>
                                    </button>
                                  </template>
                                </div>
                              </div>
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>

          <!-- Right build area -->
          <div class="sched-work p-4 rounded-lg border border-[#e5e8e5] bg-white">
          
            <!-- Header row -->
            <div class="schedule-topbar">
              <div class="schedule-topbar-left">

                <!-- Global visible days (Student View columns) -->
                <div class="schedule-days-global" x-show="view === 'track'">
                  <div class="schedule-days-global-label">Show days:</div>
                
                  <template x-for="(label, i) in dayLabels" :key="i">
                    <button
                      type="button"
                      class="schedule-day-chip"
                      :class="visibleDays.includes(i) ? 'schedule-day-chip--on' : ''"
                      @click="toggleDay(i)"
                      :aria-pressed="visibleDays.includes(i)"
                      x-text="label"
                    ></button>
                  </template>
                
                  <button
                    type="button"
                    class="schedule-day-chip schedule-day-chip--ghost"
                    @click="showAllDays()"
                    aria-label="Show all days"
                  >
                    Show all
                  </button>
                </div>
                  <!-- Global visible students (Day View columns) -->
                  <div class="schedule-days-global" x-show="view === 'day'">
                    <div class="schedule-days-global-label">Show students:</div>
                  
                    <template x-for="(studentId, sIdx) in (dayViewStudentSlots || [])" :key="'dv-top-slot-' + sIdx">
                      <div
                        class="student-select"
                        @click.outside="openDayStudentMenu = null"
                        @keydown.escape.window="openDayStudentMenu = null"
                        @click.stop
                      >
                        <button
                          type="button"
                          class="student-select-trigger schedule-day-chip schedule-day-chip--on schedule-student-chip"
                          @click.stop.prevent="openDayStudentMenu = (openDayStudentMenu === sIdx ? null : sIdx)"
                          :aria-expanded="openDayStudentMenu === sIdx"
                          :aria-controls="`day-student-top-menu-${sIdx}`"
                        >
                          <span class="student-select-label" x-text="getStudentName(studentId)"></span>
                  
                          <!-- chevron to match the rest of the app -->
                          <svg class="student-select-caret" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                  
                        <div
                          class="student-select-menu"
                          :id="`day-student-top-menu-${sIdx}`"
                          x-cloak
                          x-show="openDayStudentMenu === sIdx"
                          x-transition
                          @click.stop
                        >
                          <template x-for="s in (students || [])" :key="'dv-top-opt-' + sIdx + '-' + s.id">
                            <button
                              type="button"
                              class="student-select-option"
                              @click="setDayViewSlotStudent(sIdx, s.id); openDayStudentMenu = null;"
                            >
                              <span x-text="s.name"></span>
                              <span class="student-select-check" x-show="s.id === studentId">✓</span>
                            </button>
                          </template>
                        </div>
                      </div>
                    </template>
                  </div>
              </div>
            
              <div class="schedule-topbar-right">
                <!-- View toggle -->
                <div class="schedule-view-toggle" role="tablist" aria-label="Schedule view">
                  <button
                    type="button"
                    class="schedule-pill"
                    :class="view === 'track' ? 'schedule-pill--on' : ''"
                    @click="setView('track')"
                  >
                    Student View
                  </button>
                  <button
                    type="button"
                    class="schedule-pill"
                    :class="view === 'day' ? 'schedule-pill--on' : ''"
                    @click="setView('day')"
                  >
                    Day View
                  </button>
                </div>
          
                <!-- Density placeholder -->
                <div class="schedule-view-placeholder text-xs opacity-70">
                  Comfortable
                </div>
              </div>
            </div>
          
            <!-- Panels -->
            <div class="schedule-panels">
          
              <!-- TRACK / “Student View” (v1 = Tracks) -->
              <template x-if="view === 'track'">
                <div class="schedule-panel-row">
              
                  <template x-for="(panel, idx) in visibleStudentPanels" :key="panel.slot">
                    <section class="schedule-panel">
              
                      <!-- Panel header -->
                      <div class="schedule-panel-head">
                        <div class="schedule-panel-title">
                          <!-- Student dropdown (one per panel) -->
                          <div
                              class="student-select"
                              @click.outside="closeStudentMenu()"
                              @keydown.escape.window="closeStudentMenu()"
                              @click.stop
                            >
                              <button
                                type="button"
                                class="student-select-trigger"
                                @click.stop.prevent="toggleStudentMenu(idx)"
                                :aria-expanded="openStudentMenu === idx"
                                :aria-controls="`student-menu-${panel.slot}`"
                              >
                                <span class="student-select-label" x-text="getStudentName(panel.studentId)"></span>
                              
                                <!-- open chevron caret (matches app chevrons) -->
                                <svg class="student-select-caret" viewBox="0 0 24 24" aria-hidden="true">
                                  <path
                                    d="M6 9l6 6 6-6"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2.25"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                  />
                                </svg>
                              </button>
              
                            <div
                                class="student-select-menu"
                                :id="`student-menu-${panel.slot}`"
                                x-cloak
                                x-show="openStudentMenu === idx"
                                x-transition
                                @click.stop
                              >
                              <template x-for="s in students" :key="s.id">
                                <button
                                  type="button"
                                  class="student-select-option"
                                  @click="setPanelStudent(idx, s.id); closeStudentMenu()"
                                >
                                  <span x-text="s.name"></span>
                                  <span class="student-select-check" x-show="panel.studentId === s.id">✓</span>
                                </button>
                              </template>
                            </div>
                          </div>
                        </div>
                      </div>
              
                      <!-- Panel body: week columns -->
                      <div class="schedule-panel-body">
                        <div class="schedule-board">
                          <div class="schedule-columns">
                            <template x-for="i in visibleDays" :key="i">
                              <section class="schedule-col" :aria-label="dayLabel(i)">
                                <div class="schedule-col-head">
                                  <div class="schedule-col-title" x-text="dayLabel(i)"></div>
                                  <div class="schedule-col-total" x-text="formatMinutes(dayTotalMinutes(panel.studentId, i))"></div>
                                </div>
                                
                                <div
                                  class="schedule-dropzone"
                                  @click="setActiveTarget(panel.studentId, i)"
                                  @dragover.prevent="onDropzoneDragOver($event, panel.studentId, i)"
                                  @drop.prevent="onDropzoneDrop($event, panel.studentId, i)"
                                >

                                  <!-- Empty column placeholder -->
                                  <div
                                    class="schedule-empty"
                                    x-show="instancesFor(studentId, dayIdx).length === 0"
                                  >
                                    Assign schedule cards from the list to this day by clicking a day button on a scheduling card.
                                  </div>

                                  <!-- placed instances (Phase 2.5) -->
                                  <template x-for="inst in instancesFor(panel.studentId, i)" :key="inst.instanceId">
                                    <article
                                      :class="{
                                        'is-drop-target': dragState.dragging && dragState.overInstanceId === inst.instanceId,
                                        'is-drag-source': dragState.dragging && dragState.instanceId === inst.instanceId
                                      }"
                                      class="sched-card"
                                      draggable="true"
                                      :data-inst-id="inst.instanceId"
                                      @dragstart="onDragStart($event, panel.studentId, i, inst.instanceId)"
                                      @dragend="onDragEnd($event)"
                                      @dragover.prevent="onDragOver($event, panel.studentId, i, inst.instanceId)"
                                      @drop.prevent="onDrop($event, panel.studentId, i, inst.instanceId)"
                                    >
                                      <div class="sched-card-top">
                                        <div
                                          class="sched-card-title"
                                          :title="(templateForInstance(inst) || {}).title || ''"
                                          x-text="(templateForInstance(inst) || {}).title || 'Card'"
                                        ></div>
                                        <div class="sched-card-min" x-text="`${(templateForInstance(inst) || {}).minutes || 0}m`"></div>
                                      </div>
                                
                                      <div class="sched-card-sub" x-text="(templateForInstance(inst) || {}).symbols || ''"></div>
                                
                                      <div class="sched-card-trackline"
                                           x-text="(((templateForInstance(inst) || {}).trackingCount || 0) > 0) ? trackingBlocks(templateForInstance(inst)) : ''"></div>
                                
                                      <button
                                        type="button"
                                        class="sched-card-remove"
                                        title="Remove"
                                        @click.stop="removeInstance(panel.studentId, i, inst.instanceId)"
                                      >
                                        ✕
                                      </button>
                                    </article>
                                  </template>
                                
                                  <div class="schedule-empty" x-show="instancesFor(panel.studentId, i).length === 0">
                                    Click a card on the left to add it here
                                  </div>
                                </div>

                              </section>
                            </template>
                          </div>
                        </div>
                      </div>
              
                    </section>
                  </template>
              
                </div>
              </template>
          
              <!-- DAY VIEW -->
              <div x-show="view === 'day'" class="sched-dayview">
              
                <div class="sched-dayview-grid">
                  <template x-for="(panel, pIdx) in (dayViewPanels || [])" :key="panel.slot">
                    <section class="sched-dayview-day">
              
                      <header class="sched-dayview-dayhead">
                        <!-- Day dropdown -->
                        <div
                          class="student-select"
                          @click.outside="closeDayMenu()"
                          @keydown.escape.window="closeDayMenu()"
                          @click.stop
                        >
                          <button
                            type="button"
                            class="student-select-trigger"
                            @click.stop.prevent="toggleDayMenu(pIdx)"
                            :aria-expanded="openDayMenu === pIdx"
                            :aria-controls="`day-menu-${panel.slot}`"
                          >
                            <span class="student-select-label" x-text="dayLabelLong(panel.dayIdx)"></span>
              
                            <svg class="student-select-caret" viewBox="0 0 24 24" aria-hidden="true">
                              <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          </button>
              
                          <div
                            class="student-select-menu"
                            :id="`day-menu-${panel.slot}`"
                            x-cloak
                            x-show="openDayMenu === pIdx"
                            x-transition
                            @click.stop
                          >
                            <template x-for="d in [0,1,2,3,4]" :key="'dv-day-opt-' + pIdx + '-' + d">
                              <button
                                type="button"
                                class="student-select-option"
                                @click="setDayPanel(pIdx, d); closeDayMenu();"
                              >
                                <span x-text="dayLabelLong(d)"></span>
                                <span class="student-select-check" x-show="panel.dayIdx === d">✓</span>
                              </button>
                            </template>
                          </div>
                        </div>
                      </header>
              
                      <!-- Body matches Student View: board -> columns -> column headers -> dropzones -->
                      <div class="sched-dayview-daybody">
                        <div class="schedule-board">
                          <div class="schedule-columns schedule-columns--nowrap">
              
                            <template x-for="(studentId, sIdx) in (dayViewStudentSlots || [])" :key="'dv-col-' + panel.slot + '-' + sIdx">
                              <section class="schedule-col">
                                <div class="schedule-col-head">
                                  <div class="schedule-col-title" x-text="getStudentName(studentId)"></div>
                                  <div class="schedule-col-total" x-text="formatMinutes(dayTotalMinutes(studentId, panel.dayIdx))"></div>
                                </div>
              
                                <div
                                  class="schedule-dropzone"
                                  :data-student="studentId"
                                  :data-day="panel.dayIdx"
                                  @click="setActiveTarget(studentId, panel.dayIdx)"
                                  @dragover.prevent="onDropzoneDragOver($event, studentId, panel.dayIdx)"
                                  @drop.prevent="onDropzoneDrop($event, studentId, panel.dayIdx)"
                                >
                                  <!-- Empty column placeholder -->
                                  <div
                                    class="schedule-empty"
                                    x-show="instancesFor(studentId, panel.dayIdx).length === 0"
                                  >
                                    Assign schedule cards from the list to this day by clicking a day button on a scheduling card.
                                  </div>

                                  <template x-for="inst in instancesFor(studentId, panel.dayIdx)" :key="inst.instanceId">
                                    <article
                                      class="sched-card"
                                      draggable="true"
                                      :data-inst-id="inst.instanceId"
                                      @dragstart="onDragStart($event, studentId, panel.dayIdx, inst.instanceId)"
                                      @dragend="onDragEnd($event)"
                                      @dragover.prevent="onDragOver($event, studentId, panel.dayIdx, inst.instanceId)"
                                      @drop.prevent="onDrop($event, studentId, panel.dayIdx, inst.instanceId)"
                                    >
                                      <div class="sched-card-top">
                                        <div
                                          class="sched-card-title"
                                          :title="(templateForInstance(inst) || {}).title || ''"
                                          x-text="(templateForInstance(inst) || {}).title || 'Card'"
                                        ></div>
                                        <div class="sched-card-min" x-text="`${(templateForInstance(inst) || {}).minutes || 0}m`"></div>
                                      </div>
              
                                      <div class="sched-card-sub" x-text="(templateForInstance(inst) || {}).symbols || ''"></div>
              
                                      <div class="sched-card-trackline"
                                           x-text="(((templateForInstance(inst) || {}).trackingCount || 0) > 0) ? trackingBlocks(templateForInstance(inst)) : ''"></div>
              
                                      <button
                                        type="button"
                                        class="sched-card-remove"
                                        title="Remove"
                                        @click.stop="removeInstance(studentId, panel.dayIdx, inst.instanceId)"
                                      >
                                        ✕
                                      </button>
                                    </article>
                                  </template>
                                </div>
                              </section>
                            </template>
              
                          </div>
                        </div>
                      </div>
              
                    </section>
                  </template>
                </div>
              
              </div>
          
            </div>
          </div>

          <!-- Custom Card Modal (Create/Edit/Delete) -->
          <div x-show="customModalOpen" x-cloak class="sched-modal-overlay" @keydown.escape.window="closeCustomCardModal()">
            <div class="sched-modal-backdrop" @click="closeCustomCardModal()"></div>
          
            <div class="sched-modal" role="dialog" aria-modal="true" aria-label="Custom card" @click.stop>
              <div class="sched-modal-head">
                <div class="sched-modal-title"
                     x-text="customModalMode === 'create' ? 'New custom card' :
                             customModalMode === 'edit' ? 'Edit custom card' :
                             'Remove custom card'"></div>
          
                <button type="button" class="sched-modal-close" @click="closeCustomCardModal()" aria-label="Close">✕</button>
              </div>
          
              <div class="sched-modal-body">
                <template x-if="customModalMode !== 'delete'">
                  <div class="sched-modal-form">
                    <label class="sched-modal-label">Title</label>
                    <input class="sched-modal-input" type="text" x-model="customForm.title" placeholder="Co-op Class" />
          
                    <label class="sched-modal-label mt-3">Minutes</label>
                    <input class="sched-modal-input" type="number" min="0" max="600" step="5" x-model="customForm.minutes" />
                    <label class="sched-modal-label mt-3">Days per week</label>
                    <input class="sched-modal-input" type="number" min="0" max="5" step="1" x-model="customForm.weeklyTarget" />
          
                    <div class="sched-modal-error" x-show="customModalError" x-text="customModalError"></div>
                  </div>
                </template>
          
                <template x-if="customModalMode === 'delete'">
                  <div class="text-sm opacity-80">
                    Remove this custom card? This will also remove it from any days it was added to.
                  </div>
                </template>
              </div>
          
              <div class="sched-modal-actions">
                <button type="button" class="sched-modal-btn" @click="closeCustomCardModal()">Cancel</button>
          
                <template x-if="customModalMode === 'delete'">
                  <button type="button" class="sched-modal-btn sched-modal-btn-danger" @click="confirmDeleteCustomCard()">
                    Remove
                  </button>
                </template>
          
                <template x-if="customModalMode !== 'delete'">
                  <button type="button" class="sched-modal-btn sched-modal-btn-primary" @click="saveCustomCardModal()">
                    Save
                  </button>
                </template>
              </div>
            </div>
          </div>

          </div> <!-- Schedule Space (grid) closer -->
        </div> <!-- scheduleBuilder() closer -->
        
    </section>

  </main>

  <!-- Print Tip Modal (screen-only) -->
  <div
    x-show="printTipOpen"
    x-cloak
    class="print-tip-overlay"
    @keydown.escape.window="closePrintTip()"
  >
    <div class="print-tip-backdrop" @click="closePrintTip()"></div>
  
    <div class="print-tip-modal" role="dialog" aria-modal="true" aria-label="Print tips" @click.stop>
      <div class="print-tip-title">Best print settings</div>
  
      <div class="print-tip-body">
        <p><strong>For the cleanest print/PDF:</strong></p>
        <ul>
          <li>Set <strong>Margins</strong> to <strong>Custom: 0.5"</strong> on all sides</li>
          <li>Turn <strong>Headers and footers</strong> <strong>OFF</strong></li>
        </ul>
      </div>
  
      <label class="print-tip-checkbox">
        <input type="checkbox" x-model="printTipDontShowAgain" />
        Don’t show this again
      </label>
  
      <div class="print-tip-actions">
        <button type="button" class="print-tip-btn" @click="closePrintTip()">Cancel</button>
        <button type="button" class="print-tip-btn print-tip-btn-primary" @click="confirmPrintTipAndPrint()">
          Continue to Print
        </button>
      </div>
    </div>
  </div>

  <script type="module" src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <!-- Schedule page scripts -->
  <script src="js/schedule.js"></script>

  <!-- ✅ Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Print-only page numbers (Paged.js loads only when printing) -->
  <script>
    // Tell Paged.js: do NOT auto-run on page load
    window.PagedConfig = { auto: false };
  
    function loadPagedJsOnce() {
      return new Promise((resolve, reject) => {
        if (window.PagedPolyfill) return resolve();
        const s = document.createElement("script");
        s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Paged.js"));
        document.head.appendChild(s);
      });
    }
  
    //Print with real page numbers WITHOUT breaking the live app
    // --- helpers ---
    function stripScripts(docEl) {
      docEl.querySelectorAll("script").forEach(s => s.remove());
    }
  
    function closeOpenUi(alpineRoot) {
      try {
        const data = window.Alpine && window.Alpine.$data ? window.Alpine.$data(alpineRoot) : null;
        if (data) {
          data.gradeDropdownOpen = false;
          data.subjectDropdownOpen = false;
          data.tagDropdownOpen = false;
          data.studentDropdownOpen = false;
          data.planningMenuOpen = false;
          data.studentAssignMenuOpen = false;
          data.prepOptionsModalOpen = false;
          data.printTipOpen = false;
        }
      } catch (e) {}
    }
  
    async function loadPagedInto(win) {
      return new Promise((resolve, reject) => {
        if (win.PagedPolyfill) return resolve();
        const s = win.document.createElement("script");
        s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load Paged.js"));
        win.document.head.appendChild(s);
      });
    }
  
    function makeImagesEagerForPrint(win) {
      const imgs = Array.from(win.document.querySelectorAll("img"));
      imgs.forEach(img => {
        img.setAttribute("loading", "eager");
        try { img.loading = "eager"; } catch(e) {}
        img.decoding = "sync";
        img.setAttribute("decoding", "sync");
        try { img.fetchPriority = "high"; } catch(e) {}
        img.setAttribute("fetchpriority", "high");
      });
    }
  
    async function preloadAllImages(win, opts = {}) {
      const timeoutMs = opts.timeoutMs ?? 120000;
      const concurrency = opts.concurrency ?? 8;
  
      const imgs = Array.from(win.document.images || []);
      const srcs = imgs.map(img => img.currentSrc || img.src).filter(Boolean);
      if (!srcs.length) return;
  
      let idx = 0, active = 0, done = 0;
  
      return await new Promise((resolve) => {
        const start = Date.now();
  
        function pump() {
          if (done >= srcs.length) return resolve();
          if (Date.now() - start > timeoutMs) return resolve();
  
          while (active < concurrency && idx < srcs.length) {
            const src = srcs[idx++];
            active++;
  
            const probe = new Image();
            probe.onload = probe.onerror = () => {
              active--;
              done++;
              pump();
            };
            probe.src = src;
          }
        }
  
        pump();
      });
    }
  
    function openPrintWindowWithLoading() {
      // IMPORTANT: must happen synchronously inside the click event (before any awaits)
      const w = window.open("", "_blank", "noopener,noreferrer");
      if (!w) return null;
  
      w.document.open();
      w.document.write(`<!doctype html>
  <html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Preparing print…</title>
    <style>
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fbfbf9;color:#262b26;}
      .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:24px;}
      .card{max-width:560px;width:100%;border:1px solid #e5e8e5;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
      .title{font-weight:650;font-size:16px;margin:0 0 8px}
      .sub{margin:0;opacity:.8;font-size:13px;line-height:1.4}
      .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#596e5e;margin-right:8px;vertical-align:middle}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <p class="title"><span class="dot"></span>Preparing your Book List print…</p>
        <p class="sub">Loading cover images and building page numbers. This window will close automatically after printing.</p>
      </div>
    </div>
  </body>
  </html>`);
      w.document.close();
  
      return w;
    }
  
    function installAutoCloseHandlers(w) {
      function tryClose() { try { w.close(); } catch (e) {} }
  
      // best-case
      try { w.addEventListener("afterprint", tryClose); } catch(e) {}
  
      // very common fallback
      try {
        w.addEventListener("focus", () => setTimeout(tryClose, 400));
      } catch(e) {}
  
      // never leave orphan tabs
      setTimeout(tryClose, 60000);
    };
  </script>

  <!-- =========================
       Floating Video Links (Tutorials only for Course List)
       Desktop: bottom-right box
       Mobile: top-right icon opens modal
  ========================== -->
  <div id="videoLinks" class="av-video-links" aria-live="polite">
  
    <!-- Desktop floating box -->
    <div class="av-video-box" role="region" aria-label="Video links">
      <a class="av-video-row" id="avTutorialsLink" href="#" target="_blank" rel="noopener">
        <span class="av-play-icon" aria-hidden="true">
          <img src="./img/icons/play-button.svg" alt="" />
        </span>
        <span class="av-video-text">Planning App Tutorials</span>
      </a>
    </div>
  
    <!-- Mobile icon launcher -->
    <button class="av-video-mobile-btn" id="avVideoMobileBtn" type="button" aria-label="Open video links">
      <span class="av-play-icon" aria-hidden="true">
        <img src="./img/icons/play-button.svg" alt="" />
      </span>
    </button>
  
    <!-- Mobile modal -->
    <div class="av-video-modal-backdrop" id="avVideoBackdrop" hidden></div>
  
    <div class="av-video-modal" id="avVideoModal" role="dialog" aria-modal="true" aria-label="Video links" hidden>
      <div class="av-video-modal-header">
        <div class="av-video-modal-title">Videos</div>
        <button class="av-video-close" id="avVideoClose" type="button" aria-label="Close videos">✕</button>
      </div>
  
      <div class="av-video-modal-body">
        <a class="av-video-row" id="avTutorialsLinkMobile" href="#" target="_blank" rel="noopener">
          <span class="av-play-icon" aria-hidden="true">
            <img src="./img/icons/play-button.svg" alt="" />
          </span>
          <span class="av-video-text">Planning App Tutorials</span>
        </a>
      </div>
    </div>
  </div>
  
</body>
</html>
