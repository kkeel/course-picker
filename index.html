<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary Course Planning</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Crimson+Text:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --brand-bg:#fbfbf9; --brand-ink:#262b26;
      --green-dark:#596e5e; --gray-soft:#f4f6fa;
      --band-green:#596e5e; --check-green:#9da89f;
    }
    *{-webkit-print-color-adjust:exact !important; print-color-adjust:exact !important;}
    body{ background:var(--brand-bg); color:var(--brand-ink); font-family:'DM Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .title{ color:var(--green-dark); font-weight:700; font-size:34px; }
    .course-card{ border:1px solid #e5e7eb; background:#fff; border-radius:.75rem; overflow:hidden; }
    .course-band{ background:var(--band-green); color:#fff; }
  
    .band-title{ font-family: "Crimson Text", serif; font-size: 1.05rem; line-height: 1.15; }
    .band-title button {
        margin-left: 0.25rem;
        transition: background 0.15s ease, transform 0.1s ease;
      }
      .band-title button:hover {
        transform: translateY(-1px);
      }
    .desc-bg{ background:var(--gray-soft); }
    input[type="checkbox"]{ accent-color: var(--check-green); }
    /* pill style */
    .pill {
      border: 1px solid #9da89f;
      padding: .35rem .55rem;
      border-radius: 999px;
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex; gap:.35rem; align-items:center;
      background: #bdc5bf;           /* unselected */
      color:#262b26;                  /* readable */
      transition: background-color 0.2s, transform 0.1s;
    }
    .pill:hover { background:#b3bbb4; transform: translateY(-1px); }
    .pill.active {
      background:#9da89f;             /* selected */
      border-color:#8e988f;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    
    .icon { width:18px; height:18px; border-radius:999px; display:block; }
    .badge { width:18px; height:18px; border-radius:999px; display:block; margin-left:.35rem; }
    .tiny{ font-size:11px; opacity:.85; }
    dialog::backdrop{ background:rgba(0,0,0,.25); }
    @media print{
      .no-print{ display:none !important; }
      .badge { width:16px; height:16px; }
    }
    @media (max-width: 480px){
      .welcome-inline p { margin-top: .25rem; }
    }
    /* legend + helper text under filters */
      .legend img{ width:18px; height:18px; border-radius:999px; }
      .legend li{ display:flex; align-items:center; gap:.4rem; }
      
      /* inline note area */
      .note-area { background:#f4f6fa; border-radius:.5rem; padding:.5rem .6rem; }
      .note-area textarea{
        width:100%; border:1px solid #d9ded9; border-radius:.5rem; min-height:64px;
        padding:.5rem .6rem; font-size:.9rem; background:#fff;
      }
    /* Headings + icon row */
      .guidance-head {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }
    .guidance-head {
      align-items: center;
    }
      
      .guidance-head img {
        height: 3.25rem;   /* slightly larger icons */
        width: 3.25rem;
      }
      
      .guidance-head h3 {
        font-size: 1.35rem; /* slightly larger title text */
        font-weight: 700;
        color: var(--green-dark);
      }
      
      /* Body copy indentation */
      .guidance-copy {
        font-size: 0.96rem;
        line-height: 1.55;
        color: #2f3a33;
        margin-left: 2.9rem;   /* aligns under text, not icon */
      }
      
      .guidance-copy p {
        margin: 0 0 0.6rem 0;
      }
      
      .guidance-copy ul {
        margin-left: 1.25rem;
        margin-top: 0.25rem;
        margin-bottom: 0.75rem;
      }
      
      .guidance-copy ul li {
        margin-bottom: 0.25rem;
        padding-left: 0.25rem;
      }
      
      /* Optional: slightly thicker divider to match new scale */
      .divider-green {
        border-top: 1.5px solid var(--green-dark);
        margin-top: 1.1rem;
        padding-top: 1.1rem;
      }
    
    /* subtle highlight for the welcome info section */
    .intro-card{
      background:#fff;
      border:1px solid #e7ebe8;                       /* very faint border */
      box-shadow:0 2px 8px rgba(0,0,0,.05);           /* soft shadow */
      border-radius:1rem;
      padding:1rem 1.25rem;
    }
    @media (min-width: 640px){
      .intro-card{ padding:1.25rem 1.5rem; }
    }
    /* compact schedule block on the left */
      .schedule-col { font-size: 0.85rem; line-height: 1.35; color:#2f3a33; }
      .schedule-col .label { font-size:.72rem; letter-spacing:.06em; text-transform:uppercase; color:#6b7a71; margin-bottom:.25rem; display:block; }
      @media (min-width: 640px){
        .schedule-col { padding-right:.25rem; }
      }
    /* make topic rows a bit smaller than course title */
      .topics-list { font-size: 0.92rem; }
      .topics-list label span { line-height:1.3; }
  </style>
</head>
<body>
<div x-data="planningApp()" x-init="init()" class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

  <!-- Header -->
  <header class="flex items-center gap-3 mb-6">
    <img src="Alveary%20Lt.%20Green.png" alt="" class="h-10 w-10 object-contain">
    <h1 class="title">Alveary Course Planning</h1>
    <div class="ml-auto text-sm no-print">
      <a href="./courses.html" class="underline">View / Print Course List</a>
    </div>
  </header>

  <!-- Streamlined Welcome + Guidance -->
  <!-- Top info: one white card containing intro + all guidance -->
    <section class="mb-6">
      <div class="intro-card">
        <!-- italic intro -->
        <p class="italic text-base leading-relaxed text-gray-700 m-0 mb-4">
          The guidance below is designed to help you plan your year with intention and grace.
          A Charlotte Mason education should fit the child, not force the child to fit the curriculum.
        </p>
    
        <!-- Guidance list inside the same card -->
        <template x-for="(g, i) in guidance" :key="g.key">
          <div class="guidance-block">
            <div class="guidance-head flex items-center gap-3">
              <img :src="g.icon" class="h-9 w-9" alt="">
              <h3 class="text-xl font-semibold text-[var(--green-dark)]" x-text="g.title"></h3>
            </div>
    
            <div class="guidance-copy" x-html="g.html"></div>
    
            <div x-show="i < guidance.length - 1" class="divider-green"></div>
          </div>
        </template>
      </div>
    </section>

  <!-- Filters / view controls -->
  <section class="panel mb-4 border-t border-gray-200 pt-4">
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Search</span>
        <input x-model.trim.debounce.250ms="search" type="search" placeholder="Title, subject, keyword…" class="w-full mt-1 rounded-xl border-gray-300 placeholder-[#7b8b7f]" />
      </label>

      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Subject</span>
        <select x-model="filters.subject" class="w-full mt-1 rounded-xl border-gray-300">
          <option value="">All</option>
          <template x-for="s in subjectList" :key="s"><option :value="s" x-text="s"></option></template>
        </select>
      </label>

      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Grade</span>
        <select x-model="filters.levelTag" class="w-full mt-1 rounded-xl border-gray-300">
          <option value="">All</option>
          <template x-for="lvl in levelList" :key="lvl"><option :value="lvl" x-text="lvl"></option></template>
        </select>
      </label>

      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Plan</span>
        <select x-model="filters.planUse" class="w-full mt-1 rounded-xl border-gray-300">
          <option value="">All</option>
          <option value="Core">Core</option>
          <option value="Family">Family</option>
          <option value="High Interest">High Interest</option>
          <option value="Additional">Additional</option>
          <option value="(none)">Undecided</option>
        </select>
      </label>
    </div>

    <div class="mt-3 flex flex-wrap items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" x-model="onlyPlanned"> Show only planned
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" x-model="onlyChecked"> Show only checked
      </label>
      <div class="ml-auto tiny text-gray-500">
        <strong x-text="selectedCount"></strong> selected
      </div>
    </div>
    <!-- helper row: tip + legend -->
      <div class="mt-3 text-sm text-gray-700 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div>
          <em>Tip:</em> Click <strong>“i”</strong> on any course or topic to view Description and Combining &amp; Placement guidance.
        </div>
        <ul class="legend flex flex-wrap items-center gap-3">
          <li><img src="Core%20Subjects.png" alt=""> Core</li>
          <li><img src="Family%20Subjects.png" alt=""> Family</li>
          <li><img src="Combine%20Subjects.png" alt=""> Combine</li>
          <li><img src="High%20Interest%20Subjects.png" alt=""> High Interest</li>
          <li><img src="Additional%20Subjects.png" alt=""> Additional</li>
          <li><img src="Plan%20Your%20Year.png" alt=""> Plan</li>
        </ul>
      </div>
  </section>

  <!-- Sticky actions -->
  <div class="no-print sticky top-0 z-10 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-3 bg-[var(--brand-bg)]/95 backdrop-blur border-y border-gray-200 flex justify-between items-center">
    <div class="tiny"><strong x-text="selectedCount"></strong> selected</div>
    <div class="flex items-center gap-2">
      <button @click="clearAll()" class="rounded-xl px-3 py-2 border border-[var(--green-dark)] text-[var(--green-dark)] bg-white hover:bg-[#f4f6fa]">Clear</button>
      <button @click="printSelected()" class="rounded-xl px-3 py-2 bg-[var(--green-dark)] text-white shadow hover:opacity-95">Print Selected</button>
    </div>
  </div>

  <!-- Course list -->
  <section>
    <template x-for="c in groupedFlat" :key="c.id">
      <div class="course-card mb-3">
        <!-- band -->
        <div class="course-band grid grid-cols-12 items-center">
          <!-- LEFT SIDE: checkbox + title + icons + small schedule -->
          <div class="col-span-8 px-3 py-2 border-white/10 flex flex-col">
            <!-- top line: checkbox, title, icons -->
            <div class="flex items-center gap-2">
              <input type="checkbox"
                     class="size-5 rounded border-white/50"
                     x-model="c.checked"
                     @change="persistChecked()" />
        
              <!-- Course title -->
              <div class="band-title font-crimson text-base font-semibold flex items-center gap-1">
                <span x-text="c.title"></span>
        
                <!-- pencil + info icons directly beside title -->
                <button
                  @click="c.noteOpen = !c.noteOpen"
                  :aria-expanded="c.noteOpen"
                  class="text-xs bg-white/15 hover:bg-white/25 p-1.5 rounded"
                  title="Add / View Note">
                  ✏️
                </button>
        
                <button
                  x-show="c.hasInfo"
                  @click="c.infoOpen = !c.infoOpen"
                  :aria-expanded="c.infoOpen"
                  class="text-xs bg-white/15 hover:bg-white/25 p-1.5 rounded"
                  title="Description &amp; Placement">
                  <span x-show="!c.infoOpen">i</span>
                  <span x-show="c.infoOpen">–</span>
                </button>
              </div>
            </div>
        
            <!-- scheduling info right under title -->
            <div class="text-[0.8rem] opacity-90 leading-tight ml-7 mt-0.5"
                 x-html="c.summary || '<span class=opacity-60>—</span>'"></div>
          </div>
        
          <!-- RIGHT SIDE: planning pills (Core / Family / Combine / High-Interest / Additional) -->
          <div class="col-span-4 px-3 py-2 border-white/10">
            <div class="flex flex-wrap justify-end items-center gap-2">
              <template x-for="opt in useOptions" :key="opt.value">
                <button class="pill"
                        :class="{'active': (Array.isArray(plan[c.id]?.use)
                          ? plan[c.id].use.includes(opt.value)
                          : plan[c.id]?.use === opt.value)}"
                        @click="setUse(c.id,opt.value)">
                  <img class="icon" :src="opt.icon" :alt="opt.label + ' icon'">
                  <span class="tiny" x-text="opt.short"></span>
                </button>
              </template>
            </div>
          </div>
        </div>

        <!-- body row -->
        <div class="grid grid-cols-12">
          <!-- LEFT: Scheduling (compact) -->
          <div class="col-span-12 sm:col-span-3 px-3 py-3 schedule-col">
            <span class="label">Schedule</span>
            <div x-html="c.summary || '<span class=opacity-60>—</span>'"></div>
          </div>
        
          <!-- RIGHT: notes + accordion details -->
          <div class="col-span-12 sm:col-span-9 px-4 py-4">
            <!-- inline planning note -->
            <div class="note-area">
              <label class="text-xs uppercase tracking-wide text-gray-500 block mb-1">
                Planning note (optional)
              </label>
              <textarea
                :value="plan[c.id]?.note || ''"
                @input="plan[c.id]={ ...(plan[c.id]||{}), note:$event.target.value, ts:Date.now() }; persistPlan();"
                placeholder="Add any details for your plan (who it’s for, pacing, resources, etc.)"></textarea>
            </div>
        
            <!-- accordion: appears under the note -->
            <div x-show="c.infoOpen && c.hasInfo" x-collapse class="mt-3 pt-3 border-t border-gray-200">
              <template x-if="c.description">
                <div class="mb-3">
                  <div class="font-semibold mb-1">Description</div>
                  <div class="text-sm leading-6" x-html="c.description"></div>
                </div>
              </template>
        
              <template x-if="c.combining">
                <div>
                  <div class="font-semibold mb-1">Combining &amp; Placement</div>
                  <div class="text-sm leading-6" x-html="c.combining"></div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- topics -->
        <template x-if="c.topics && c.topics.length">
          <div class="px-3 pb-3 topics-list">
            <div class="text-xs uppercase tracking-wide text-gray-500 mt-2 mb-1">Topics</div>
            <template x-for="t in c.topics" :key="t.topic_id">
              <label class="flex items-center gap-2 py-1">
                <input type="checkbox" class="size-4" x-model="t.checked" @change="persistChecked()" />
                <span x-text="t.topic_title"></span>
              </label>
            </template>
          </div>
        </template>
      </div>
    </template>

    <template x-if="!groupedFlat.length">
      <p class="text-center text-gray-500 py-12">No courses match your filters/view.</p>
    </template>
  </section>
  
</div>
  
<script>
function planningApp(){
  return {
    /* ---------- UI state ---------- */
    search:'', filters:{subject:'', levelTag:'', planUse:''},
    onlyPlanned:false, onlyChecked:false,

    /* ---------- data ---------- */
    courses:[], courseIndex:{}, plan:{}, openGuidance:{},

    noteFor:null, noteDraft:'',
    modal:{title:'',description:'',combine:''},

    // guidance blocks (uses your uploaded PNGs)
    guidance:[
      {
        key:'core', title:'Core Subjects', icon:'Core%20Subjects.png',
        html:`
          <p><strong>Start by focusing on the core subjects</strong> required by your state or those you consider nonnegotiable, such as Bible, History, Geography, English/Reading, Literature, Science, and Math.</p>
    
          <p>If you plan to modify a subject—such as focusing on only one stream of History (e.g., <em>World, Ancient,</em> or <em>US/Canadian for grades 4+</em>)—make a note of it. Similarly, if you intend to combine students into a single grade level for a subject (e.g., <em>2nd and 3rd graders sharing a 3rd-grade Science course</em>), make note of that too.</p>
    
          <p>Refer to our <a href="https://www.alveary.org/whats-new/tips-for-combining-students" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">tips on combining students</a> for additional guidance.</p>
        `
      },
      {
        key:'family', title:'Family & High-Interest', icon:'Family%20Subjects.png',
        html:`
          <p><strong>Next, choose a few subjects that spark high interest</strong> for each child or that your whole family would enjoy together.</p>
    
          <p>You can focus on the same subject throughout the year or rotate topics to explore a variety. For example, you might dedicate one term each to <em>Shakespeare, Plutarch,</em> and <em>Composer Study</em> if you don't have room for a full year of each. If you prefer a slower pace, consider spreading a term's worth of lessons across two terms.</p>
    
          <p>This approach works well for subjects such as <em>Art Instruction</em> or <em>Singing,</em> giving you the flexibility to adjust to your students' needs.</p>
        `
      },
      {
        key:'additional', title:'Additional Subjects', icon:'Additional%20Subjects.png',
        html:`
          <p><strong>Review the remaining subjects and choose one or two</strong> that feel especially important to include, especially if they haven’t been covered yet. Consider options that:</p>
    
          <ul class="list-disc pl-6 mt-2 mb-3 space-y-1">
            <li>Fulfill high-school credit requirements.</li>
            <li>Reflect your family’s priorities or interests.</li>
            <li>Align with your child’s passions or future goals.</li>
          </ul>
    
          <p>These could also be subjects where Alveary offers resources without daily lesson plans (e.g., <em>cooking</em> or <em>car maintenance</em>) or areas where you can incorporate non-Alveary resources, such as co-op classes or ACT prep courses.</p>
        `
      },
      {
        key:'plan', title:'Plan Your Year', icon:'Plan%20Your%20Year.png',
        html:`
          <p>Now that you’ve identified your subjects, you’re ready to <strong>create a schedule</strong> using Alveary’s scheduling tools. This is a great starting point for your school year.</p>
    
          <p>If you have room for additional subjects—or think you might later—make a list of what you’d like to include and why each is important. Consider adding these subjects when time allows.</p>
    
          <p>For guidance, refer to these Alveary resources:</p>
          <ul class="list-none mt-2 mb-1 space-y-1 pl-6">
            <li>∞ <a href="https://www.alveary.org/whats-new/a-relational-education" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Relational Education</a> <span class="text-gray-600">(which subjects are intertwined)</span></li>
            <li>∞ <a href="http://www.alveary.org/whats-new/balancing-the-feast" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Balancing the Feast</a> <span class="text-gray-600">(often overlooked subjects)</span></li>
            <li>∞ <a href="https://www.alveary.org/whats-new/tips-for-combining-students" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Tips for Combining Students</a></li>
          </ul>
        `
      }
    ],

    useOptions:[
      {label:'Core Subject', value:'Core', icon:'Core%20Subjects.png'},
      {label:'Family', value:'Family', icon:'Family%20Subjects.png'},
      {label:'Combine', value:'Combine', icon:'Combine%20Subjects.png'},
      {label:'High Interest', value:'High Interest', icon:'High%20Interest%20Subjects.png'},
      {label:'Additional', value:'Additional', icon:'Additional%20Subjects.png'}
    ],

    /* ---------- sources (same as your list page) ---------- */
    dataSources:{
      courses:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=0&single=true&output=csv',
      topics: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=1919021076&single=true&output=csv'
    },
    courseFields:{
      course_id:'Course_ID', course_title:'Course', subject:'Subject',
      schedule_text:'Scheduling_R3', grade_text:'Grade_Text', grade_filter:'Grade_Filter',
      description:'Program_Description_R3', combining_placement:'Combining&PlacementTips_R3'
    },
    topicFields:{
      topic_id:'Topic_ID', course_id:'Course_ID_R3', topic_title:'Topic',
      topic_description:'Program_Description_R3', combining_placement:'Combining&PlacementTips_R3',
      schedule_text:'Scheduling_R3', grade_text:'Grade_Text', grade_filter:'Grade_Filter'
    },

    /* ---------- computed ---------- */
    get filtered(){
      const q=this.search.toLowerCase();
      return this.courses.filter(c=>{
        // text filters
        const matchesQ=!q || [c.title,c.subject,c.summary,c.levelDisplay].join(' ').toLowerCase().includes(q);
        const matchesS=!this.filters.subject || c.subject===this.filters.subject;
        const matchesL=!this.filters.levelTag || (c.levelTags||[]).includes(this.filters.levelTag);

        // plan filter
        let matchesPlan=true;
        const use = this.plan[c.id]?.use || [];
        const uses = Array.isArray(use) ? use : [use];
        if(this.filters.planUse === '(none)') matchesPlan = uses.length === 0;
        else if(this.filters.planUse) matchesPlan = uses.includes(this.filters.planUse);

        // view toggles
        const passPlanned = !this.onlyPlanned || !!use;
        const passChecked = !this.onlyChecked || c.checked || (c.topics||[]).some(t=>t.checked);

        return matchesQ && matchesS && matchesL && matchesPlan && passPlanned && passChecked;
      });
    },
    get groupedFlat(){
      const by = new Map();
      this.filtered.forEach(c=>{ const s=c.subject||'Other'; if(!by.has(s)) by.set(s,[]); by.get(s).push(c); });
      const special='Alt. Science Options';
      return Array.from(by.entries()).sort((a,b)=>{
        const A=a[0]||'', B=b[0]||'';
        if(A===special && B!==special) return 1;
        if(B===special && A!==special) return -1;
        return A.localeCompare(B,undefined,{numeric:true});
      }).flatMap(x=>x[1]);
    },
    get selectedCount(){
      return this.courses.reduce((n,c)=> n + (c.checked?1:0) + ((c.topics||[]).filter(t=>t.checked).length), 0);
    },
    get subjectList(){ return [...new Set(this.courses.map(c=>c.subject).filter(Boolean))].sort((a,b)=>a.localeCompare(b,undefined,{numeric:true})); }
    ,get levelList(){ return [...new Set(this.courses.flatMap(c=>c.levelTags||[]))].sort((a,b)=> {
      const na=+a.replace(/\D/g,''); const nb=+b.replace(/\D/g,''); return na-nb || a.localeCompare(b);
    }); },

    /* ---------- helpers ---------- */
    _getCI(row,want){ const keys=Array.isArray(want)?want:[want]; for(const k of keys){ const hit=Object.keys(row).find(h=>h.trim().toLowerCase()===String(k).trim().toLowerCase()); if(hit) return row[hit]; } },
    computeGradeTags(gr){
      const tags=[]; const range=gr&&gr.match(/^(?:[Gg]?(\d+))\s*[–-]\s*[Gg]?(\d+)$/);
      if(range){ const a=+range[1],b=+range[2]; for(let i=Math.min(a,b); i<=Math.max(a,b); i++) tags.push(`G${i}`); return tags; }
      const single=gr&&gr.match(/^[Gg]?(\d+)$/); if(single) return [`G${+single[1]}`];
      if(gr && String(gr).includes(',')){ String(gr).split(',').forEach(x=>{ const n=x.replace(/[^0-9]/g,''); if(n) tags.push(`G${+n}`); }); }
      return tags;
    },
    rowToCourse(row){
      const g=(k)=>this._getCI(row,this.courseFields[k]);
      const id=(g('course_id')||'').toString().trim();
      const title=(g('course_title')||'').toString().trim();
      if(!id && !title) return null;
    
      const subject=(g('subject')||'').toString().trim();
      const gradeText=(g('grade_text')||'').toString().trim();
      const gradeFilter=(g('grade_filter')||'').toString().trim();
      const schedule=(g('schedule_text')||'').toString().trim();       // we’ll not show it, but keep it in case later
      const description=(g('description')||'').toString().trim();
      const combining=(g('combining_placement')||'').toString().trim();
    
      const levelDisplay=gradeText||'';
      const levelTags=(gradeFilter && /G\s*\d+/i.test(gradeFilter))
        ? (gradeFilter.match(/G\s*\d+/gi)||[]).map(s=>'G'+s.replace(/[^0-9]/g,''))
        : this.computeGradeTags(gradeText);
    
      const details=[];
      if(description) details.push({label:'Description', value:description});
      if(combining)   details.push({label:'Combining & Placement', value:combining});
    
      const hasInfo = !!(description || combining);
    
      return {
        id:id||title, title:title||id, subject,
        summary:schedule, details, description, combining, hasInfo,
        levelDisplay, levelTags, checked:false, topics:[],
        infoOpen:false               // NEW: accordion state per course
      };
    },
    rowToTopic(row){
      const g=(k)=>this._getCI(row,this.topicFields[k]);
      const rawCourseIds=(g('course_id')||'').toString().trim();
      const topic_title=(g('topic_title')||'').toString().trim();
      if(!rawCourseIds || !topic_title) return null;
      const topic_id=(g('topic_id')||'').toString().trim() || (rawCourseIds+'::'+topic_title);
      const topic_desc=(g('topic_description')||'').toString().trim();
      const combining=(g('combining_placement')||'').toString().trim();
      const schedule_t=(g('schedule_text')||'').toString().trim();
      const gradeText=(g('grade_text')||'').toString().trim();
      const gradeFilter=(g('grade_filter')||'').toString().trim();
      const levelDisplay=gradeText||'';
      const levelTags=(gradeFilter && /G\s*\d+/i.test(gradeFilter))
        ? (gradeFilter.match(/G\s*\d+/gi)||[]).map(s=>'G'+s.replace(/[^0-9]/g,''))
        : this.computeGradeTags(gradeText);
      const details=[]; if(topic_desc) details.push({label:'Description', value:topic_desc}); if(combining) details.push({label:'Combining & Placement', value:combining});
      return { topic_id, course_ids:rawCourseIds.split(',').map(s=>s.trim()).filter(Boolean), topic_title, summary:schedule_t, details, levelDisplay, levelTags, checked:false };
    },

    /* ---------- storage & sync ---------- */
    persistChecked(){
      const ids=[]; this.courses.forEach(c=>{ if(c.checked) ids.push('c:'+c.id); (c.topics||[]).forEach(t=>{ if(t.checked) ids.push('t:'+t.topic_id); }); });
      localStorage.setItem('pf_courses', JSON.stringify(ids));
    },
    restoreChecked(){
      try{
        const saved=JSON.parse(localStorage.getItem('pf_courses')||'[]'); const set=new Set(saved);
        this.courses.forEach(c=>{ c.checked=set.has('c:'+c.id); (c.topics||[]).forEach(t=>{ t.checked=set.has('t:'+t.topic_id); }); });
      }catch{}
    },
    loadPlan(){ try{ this.plan=JSON.parse(localStorage.getItem('pf_plan_v1')||'{}'); }catch{ this.plan={}; } },
    persistPlan(){ localStorage.setItem('pf_plan_v1', JSON.stringify(this.plan)); },
    setUse(id, use) {
      const existing = this.plan[id]?.use || [];
      // Normalize to array
      const currentUses = Array.isArray(existing) ? existing : existing ? [existing] : [];
    
      // If already selected, remove it; otherwise add it
      const newUses = currentUses.includes(use)
        ? currentUses.filter(u => u !== use)
        : [...currentUses, use];
    
      this.plan[id] = { ...(this.plan[id] || {}), use: newUses, ts: Date.now() };
      this.persistPlan();
    },
    editNote(id){ this.noteFor=id; this.noteDraft=(this.plan[id]?.note)||''; this.$refs.noteDlg.showModal(); },
    saveNote(){ if(this.noteFor){ this.plan[this.noteFor]={ ...(this.plan[this.noteFor]||{}), note:this.noteDraft, ts:Date.now() }; this.persistPlan(); } this.$refs.noteDlg.close(); },

    iconMap:{
      'Core':'Core%20Subjects.png',
      'Family':'Family%20Subjects.png',
      'Combine':'Combine%20Subjects.png',
      'High Interest':'High%20Interest%20Subjects.png',
      'Additional':'Additional%20Subjects.png'
    },
    iconsFor(use){
      const uses = Array.isArray(use) ? use : (use ? [use] : []);
      return uses
        .map(u => this.iconMap[u])
        .filter(Boolean); // skip empty/unknown (e.g., Undecided)
    },

    /* ---------- guidance open/close memory ---------- */
    isOpen(key){ return this.openGuidance[key] ?? (key==='core'); },
    toggleOpen(key,val){ this.openGuidance[key]=!!val; localStorage.setItem('pf_guidance_open', JSON.stringify(this.openGuidance)); },

    /* ---------- load ---------- */
    async loadDualCSVs(){
      const cacheKey='pf_csv_cache_v1', maxAgeMs=6*60*60*1000, now=Date.now();
      let cached; try{ cached=JSON.parse(localStorage.getItem(cacheKey)||'null'); }catch{}
      if(cached && (now - cached.ts) < maxAgeMs){
        const pc=Papa.parse(cached.courses,{header:true,skipEmptyLines:true});
        const pt=Papa.parse(cached.topics,{header:true,skipEmptyLines:true});
        return this.applyParsed(pc,pt);
      }
      const [cCSV,tCSV]=await Promise.all([
        fetch(this.dataSources.courses).then(r=>r.text()),
        fetch(this.dataSources.topics).then(r=>r.text())
      ]);
      localStorage.setItem(cacheKey, JSON.stringify({ts:now, courses:cCSV, topics:tCSV}));
      const pc=Papa.parse(cCSV,{header:true,skipEmptyLines:true});
      const pt=Papa.parse(tCSV,{header:true,skipEmptyLines:true});
      this.applyParsed(pc,pt);
    },
    applyParsed(pc,pt){
      this.courseIndex={};
      pc.data.forEach(row=>{ const c=this.rowToCourse(row); if(c) this.courseIndex[c.id]=c; });
      pt.data.forEach(row=>{ const t=this.rowToTopic(row); if(!t) return; t.course_ids.forEach(cid=>{ if(this.courseIndex[cid]) this.courseIndex[cid].topics.push(t); }); });
      this.courses=Object.values(this.courseIndex);
    },

    /* ---------- actions ---------- */
    clearAll(){
      this.courses.forEach(c=>{ c.checked=false; (c.topics||[]).forEach(t=>t.checked=false); });
      this.persistChecked();
      this.plan={}; this.persistPlan();
    },
    printSelected(){ window.print(); },

    async init(){
      // load guidance open state
      try{ this.openGuidance = JSON.parse(localStorage.getItem('pf_guidance_open')||'{}'); }catch{ this.openGuidance={}; }

      await this.loadDualCSVs();
      this.restoreChecked();
      this.loadPlan();
    }
  }
}
</script>
</body>
</html>
