<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary – Planner</title>

  <!-- Fonts -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
  />

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js for simple interactivity -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Helper to get live CSV Data -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* =========================================
       BRAND FONTS (self-hosted)
    ========================================= */
    @font-face {
      font-family: "Plantin MT Pro";
      src:
        url("assets/fonts/plantin/plantinmtprorg-webfont.woff2") format("woff2"),
        url("assets/fonts/plantin/plantinmtprorg-webfont.woff") format("woff");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    
    @font-face {
      font-family: "Circular Pro";
      src:
        url("assets/fonts/circular/circularpro-medium-webfont.woff2") format("woff2"),
        url("assets/fonts/circular/circularpro-medium-webfont.woff") format("woff");
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --brand-bg: #faf7ed;
      --brand-dark: #596e5e;
      --brand-text: #262b26;
      --brand-muted: #1C1B1F4D;
      --brand-accent: #adb58f;
      --brand-surface: #ffffff;
      --divider-subtle: #dde2d5;
    }

    body {
      margin: 0;
      background: var(--brand-bg);
      color: var(--brand-text);
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-weight: 400;
    }
    
    .app-header {
      border-bottom: 1px solid #dde2d5;
    }

    .logo-title {
      font-family: "Circular Pro", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      font-weight: 700;
      font-size: 40px;
      line-height: 1;
      color: var(--brand-dark);
    }

    .nav-tab {
      border: none;
      background: transparent;
      padding-bottom: 4px;
      font-size: 15px;
      font-weight: 500;
      color: var(--brand-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s ease, border-color 0.15s ease;
      white-space: nowrap;
    }

    .nav-tab-active {
      color: var(--brand-text);
      border-color: var(--brand-text);
    }

    .section-title {
      font-family: "Plantin MT Pro", "Times New Roman", serif;
      font-size: 48px;
      font-weight: 400;
      margin-bottom: 0.5rem;
      color: var(--brand-text);
    }

    .section-subtitle {
      font-family: "DM Sans", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      font-size: 16px;
      font-weight: 400;
      color: var(--brand-text);
      max-width: 781px;
      width: 100%;
      line-height: 1.5;
      margin-left: 0;
    }

    /* Font helpers for branding */
    .font-plantin {
      font-family: 'Plantin MT Pro', 'Times New Roman', serif;
      font-weight: 400;
    }
    
    .font-circular {
      font-family: 'Circular Pro', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 500;
    }

    /* Filter panel (Course list) */
    .filter-panel {
      max-width: 1601px;
      width: 100%;
      padding: 24px;
      border-radius: 4px;
      border: 1px solid #dde2d5;
      background-color: transparent;
    }

    .filter-panel-title {
      font-family: "Circular Pro", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-weight: 500;
      font-size: 18px;
      color: var(--brand-text);
      margin: 0 0 16px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 1024px) {
      .filter-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }
    }

    .filter-control {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      border-radius: 4px;
      border: 1px solid #dde2d5;
      padding: 8px 12px;
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      font-weight: 500; /* DM Sans medium look */
      font-size: 14px;
      background-color: #ffffff;
    }

    .filter-placeholder {
      color: var(--brand-muted);
      font-weight: 500;
      font-size: 14px;
    }

    .filter-chevron {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      color: var(--brand-muted);
    }

    .filter-chevron svg {
      width: 24px;
      height: 24px;
      stroke: var(--brand-text);
      transition: transform 0.15s ease;
    }

    .filter-chevron-open svg {
      transform: rotate(180deg);
    }

    .filter-control input {
      border: none;
      outline: none;
      width: 100%;
      font: inherit;
      background: transparent;
      color: var(--brand-text);
      font-size: 14px;
    }

    .filter-control input::placeholder {
      color: var(--brand-muted);
      font-weight: 500; /* DM Sans medium */
      font-size: 14px;
    }

    .filter-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .filter-actions {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
    }

    .filter-control-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      row-gap: 4px;
      align-items: center;
      width: 100%;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #f4f6fa;
      font-size: 13px;
      font-weight: 500;
      color: var(--brand-text);
    }

    .filter-chip-remove {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      font-size: 11px;
      line-height: 1;
      color: var(--brand-muted);
    }

    .filter-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      width: 100%;
      max-height: 260px;
      overflow-y: auto;
      background-color: #ffffff;
      border-radius: 4px;
      border: 1px solid #dde2d5;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      z-index: 20;
    }

    .filter-dropdown-item {
      width: 100%;
      padding: 6px 10px;
      text-align: left;
      font-size: 14px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-dropdown-item:hover {
      background-color: #f4f6fa;
    }

    .filter-dropdown-check {
      font-size: 14px;
      color: var(--brand-dark);
    }

    .btn-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 14px;
      font-weight: 500;
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      border: 1px solid #262b26;
      background-color: transparent;
      color: var(--brand-text);
      cursor: pointer;
    }

    .btn-pill-icon {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-pill-icon svg {
      width: 16px;
      height: 16px;
    }

    .btn-pill.print-btn .btn-pill-icon svg {
      width: 24px;
      height: 24px;
    }

    .btn-secondary {
      /* print button keeps same transparent style, but we may
         enhance later if you want emphasis */
      background-color: transparent;
      border-color: #262b26;
      color: var(--brand-text);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--brand-muted);
      white-space: nowrap;
    }

    .toggle-switch {
      position: relative;
      width: 34px;
      height: 18px;
      border-radius: 999px;
      background-color: rgba(38, 43, 38, 0.16);
      padding: 2px;
      transition: background-color 0.15s ease;
      flex-shrink: 0;
    }

    .toggle-switch-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background-color: #ffffff;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.08);
      transition: transform 0.15s ease;
    }

    .toggle--on .toggle-switch {
      background-color: var(--brand-accent);
    }

    .toggle--on .toggle-switch-knob {
      transform: translateX(14px);
    }

    .search-icon {
      position: absolute;
      right: 10px;
      width: 20px;
      height: 20px; 
      pointer-events: none;
      color: var(--brand-muted);
    }

    .search-icon svg {
      width: 20px;
      height: 20px;
    }

    /* Subject, course, and topic shells */
    .course-shell {
      margin-top: 40px;
    }

    .subject-block + .subject-block {
      margin-top: 32px;
    }

    .subject-title {
      font-family: "Plantin MT Pro", "Crimson Text", Georgia, "Times New Roman", serif;
      font-size: 32px;
      line-height: 1.25;
      font-weight: 400;
      color: var(--brand-text);
      margin-bottom: 12px; /* space before first course card */
    }

    .subject-courses {
      display: flex;
      flex-direction: column;
      gap: 12px; /* space between course cards */
    }

    .course-card,
    .topic-card {
      border-radius: 4px;
      padding: 20px;
      background-color: var(--brand-surface);
    }
    
    .topic-card {
      border: 1px solid var(--divider-subtle);
    }
    
    /* course cards: default border before subject override */
    .course-card {
      border: 1px solid var(--divider-subtle);
    }

    .topic-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .course-title,
    .topic-title {
      margin: 0;
      font-family: "Circular Pro", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      font-size: 18px;
      line-height: 1.4;
      font-weight: 500;
      color: var(--brand-text);
    }

    .course-meta {
      margin-top: 4px;
      display: flex;
      align-items: flex-start;
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 12px;
      line-height: 1.5;
      font-weight: 400;
      color: var(--brand-muted);
      white-space: normal;
    }

    .meta-schedule {
      white-space: pre-line;
    }

    .meta-schedule--with-grade {
      padding-right: 20px;
      border-right: 1px solid #e5e8e5;
    }

    .meta-schedule--solo {
      padding-right: 0;
      border-right: none;
    }

    .meta-grade {
      white-space: normal;
    }

    .meta-grade--with-sched {
      padding-left: 20px;
    }
   
    .meta-grade--solo {
      padding-left: 0;
    }

    .meta-flex-spacer {
      margin-left: auto;
    }

    /* Planning tags */
    .planning-tag-wrapper {
      position: relative;
      display: inline-flex;
      align-items: flex-start;
    }

    .planning-tag-region {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* The initial "+ Planning tag" button */
    .planning-tag-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #e5e8e5;
      background-color: #ffffff;
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 12px;
      font-weight: 400;
      color: var(--brand-muted);
      cursor: pointer;
      white-space: nowrap;
      line-height: 1.2;
    }

    .planning-tag-label {
      white-space: nowrap;
    }

    /* When tags are selected: row of images + small "+" button */
    .planning-tag-selected-row {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .planning-tag-pill {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .planning-tag-img {
      display: block;
      height: 28px;
      width: auto;
    }

    .planning-tag-remove {
      position: absolute;
      right: -4px;
      bottom: -4px;
      border: none;
      background: transparent;
      border-radius: 0;
      width: auto;
      height: auto;
      font-size: 11px;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      color: var(--brand-muted);
      box-shadow: none;
    }

    .planning-tag-add {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 4px;
      border: 1px solid #e5e8e5;
      background-color: #ffffff;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      color: var(--brand-muted);
      line-height: 1;
    }

    /* Dropdown-like menu for planning tag selections */
    .planning-tag-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #dde2d5;
      background-color: #ffffff;
      min-width: 260px;
      max-width: 300px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      z-index: 10;
    }

    .planning-tag-option {
      width: 100%;
      border: none;
      background: transparent;
      padding: 4px 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
    }

    .planning-tag-option:hover {
      background-color: #f4f6fa;
    }

    .planning-tag-option-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .planning-tag-option-main img {
      height: 24px;
      width: auto;
      display: block;
    }

    /* Description + tips rows */
    .course-detail-row {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 16px;
      line-height: 1.5;
      color: var(--brand-text);
    }

    .course-detail-tips {
      flex: 1.5;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      background-color: #f4f6fa;
      padding: 8px 12px;
      border-radius: 4px;
      color: var(--brand-muted);
    }

    .course-detail-tips-icon {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .course-detail-tips-icon svg {
      width: 20px;
      height: 20px;
    }

    /* Preserve line breaks from CSV for descriptions & tips text */
    .course-detail-description {
      white-space: pre-line;
    }
    
    /* Tips text should also respect line breaks */
    .course-detail-tips span[x-text],
    .course-detail-tips span[ x-text ],
    .course-detail-tips span {
      white-space: pre-line;
    }

    /* Card headers with chevrons */
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-toggle {
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      color: var(--brand-muted);
    }

    .card-toggle svg {
      width: 24px;
      height: 24px;
      transition: transform 0.15s ease;
    }

    .card-toggle--closed svg {
      transform: rotate(-90deg);
    }

    /* Hide Alpine sections until ready */
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body x-data="coursePlanner()" x-init="init()">

  <!-- Header -->
  <header class="app-header mb-8 px-6 md:px-16 py-4 md:py-6 flex flex-col md:flex-row md:items-center gap-4">
    <!-- Logo + wordmark -->
    <div class="flex items-center gap-3">
      <!-- Replace src with new dark green logo file when ready -->
      <img
        src="Alveary%20Lt.%20Green.png"
        alt="Alveary logo"
        class="object-contain"
        style="height: 40px; width: 40px;"
      />
      <span class="logo-title">Alveary</span>
    </div>

    <!-- Top-right navigation tabs -->
    <nav
      class="mt-3 md:mt-0 md:ml-auto flex flex-wrap items-center gap-x-6 gap-y-2 text-sm"
    >
      <button
        type="button"
        class="nav-tab"
        :class="step === 1 ? 'nav-tab-active' : ''"
        @click="openStep(1)"
      >
        How to
      </button>

      <button
        type="button"
        class="nav-tab"
        :class="step === 2 ? 'nav-tab-active' : ''"
        @click="openStep(2)"
      >
        Planning guide
      </button>

      <button
        type="button"
        class="nav-tab"
        :class="step === 3 ? 'nav-tab-active' : ''"
        @click="openStep(3)"
      >
        Course list
      </button>

      <button
        type="button"
        class="nav-tab"
        :class="step === 4 ? 'nav-tab-active' : ''"
        @click="openStep(4)"
      >
        Book list
      </button>
    </nav>
  </header>

  <!-- Main content -->
  <main class="max-w-6xl mx-auto px-6 lg:px-16 pb-16 space-y-10">
    <!-- STEP 1: How to -->
    <section x-show="step === 1" x-cloak>
      <h2 class="section-title">How to use this planner</h2>
      <p class="section-subtitle">
        This is a placeholder for your “How To” instructions. We’ll bring over
        the refined content and visuals from the legacy planner once the new
        layout is settled.
      </p>

      <div class="mt-6 rounded-2xl bg-white shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-700 mb-2">
          • Step 1: Browse the course list and book list using the tabs above.
        </p>
        <p class="text-sm text-gray-700 mb-2">
          • Step 2: Apply filters to narrow down options by grade, subject, and
          tags.
        </p>
        <p class="text-sm text-gray-700">
          • Step 3: Save or print your selections for a personalized learning
          plan.
        </p>
      </div>
    </section>

    <!-- STEP 2: Planning guide -->
    <section x-show="step === 2" x-cloak>
      <h2 class="section-title">Planning guide</h2>
      <p class="section-subtitle">
        This section will eventually hold your full planning guide content. For
        now, it’s just a clean placeholder while we rebuild the structure.
      </p>

      <div class="mt-6 grid gap-4 md:grid-cols-2">
        <div class="rounded-2xl bg-white shadow-sm border border-gray-200 p-6">
          <h3 class="font-semibold text-sm mb-2 text-[var(--brand-dark)]">
            Big-picture planning
          </h3>
          <p class="text-sm text-gray-700">
            Use this space to outline rotation goals, term focus, and any school
            year themes you want families to keep in mind.
          </p>
        </div>

        <div class="rounded-2xl bg-white shadow-sm border border-gray-200 p-6">
          <h3 class="font-semibold text-sm mb-2 text-[var(--brand-dark)]">
            Weekly rhythm
          </h3>
          <p class="text-sm text-gray-700">
            Later we can embed guidance on how frequently to schedule each
            course and how books support those choices.
          </p>
        </div>
      </div>
    </section>

    <!-- STEP 3: Course list -->
    <section x-show="step === 3" x-cloak>
      <h2 class="section-title">Course list</h2>
      <p class="section-subtitle">
        This is an intuitive course planner that helps organize your school year.
        Browse courses by subject, view descriptions and placement tips, and easily tag, note,
        or save your selections for a personalized learning plan.
      </p>

      <!-- Filter bar -->
      <div class="mt-8 flex justify-center">
        <div class="filter-panel">
          <p class="filter-panel-title">Filter by</p>

          <div class="filter-grid">
            <!-- Grade -->
            <div class="relative" @click.outside="gradeDropdownOpen = false">
              <button
                type="button"
                id="filter-grade"
                class="filter-control"
                aria-label="Filter by grade"
                @click="gradeDropdownOpen = !gradeDropdownOpen"
              >
                <!-- placeholder when nothing selected -->
                <template x-if="selectedGrades.length === 0">
                  <span class="filter-placeholder">Grade</span>
                </template>

                <!-- chips when grades are selected -->
                <template x-if="selectedGrades.length > 0">
                  <div class="filter-control-chips">
                    <template x-for="code in selectedGrades" :key="code">
                      <span class="filter-chip">
                        <span x-text="gradeLabelFromCode(code)"></span>
                        <button
                          type="button"
                          class="filter-chip-remove"
                          @click.stop="removeGrade(code)"
                          aria-label="Remove grade"
                        >
                          ×
                        </button>
                      </span>
                    </template>
                  </div>
                </template>

                <span
                  class="filter-chevron"
                  :class="gradeDropdownOpen ? 'filter-chevron-open' : ''"
                  aria-hidden="true"
                >
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6 9l6 6 6-6"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </span>
              </button>

              <!-- dropdown menu -->
              <div
                class="filter-dropdown"
                x-show="gradeDropdownOpen"
                x-transition
              >
                <template x-for="opt in gradeOptions" :key="opt.code">
                  <button
                    type="button"
                    class="filter-dropdown-item"
                    @click="toggleGrade(opt.code)"
                  >
                    <span x-text="opt.label"></span>
                    <span
                      class="filter-dropdown-check"
                      x-show="selectedGrades.includes(opt.code)"
                    >
                      ✓
                    </span>
                  </button>
                </template>
              </div>
            </div>

            <!-- Subject -->
            <div class="relative" @click.outside="subjectDropdownOpen = false">
              <button
                type="button"
                id="filter-subject"
                class="filter-control"
                aria-label="Filter by subject"
                @click="subjectDropdownOpen = !subjectDropdownOpen"
              >
                <!-- placeholder when nothing selected -->
                <template x-if="selectedSubjects.length === 0">
                  <span class="filter-placeholder">Subject</span>
                </template>
            
                <!-- chips when subjects are selected -->
                <template x-if="selectedSubjects.length > 0">
                  <div class="filter-control-chips">
                    <template x-for="subj in selectedSubjects" :key="subj">
                      <span
                        class="filter-chip"
                        :style="`background-color: ${subjectColor(subj)}4D;`"
                      >
                        <span x-text="subj"></span>
                        <button
                          type="button"
                          class="filter-chip-remove"
                          @click.stop="removeSubject(subj)"
                          aria-label="Remove subject"
                        >
                          ×
                        </button>
                      </span>
                    </template>
                  </div>
                </template>
            
                <span
                  class="filter-chevron"
                  :class="subjectDropdownOpen ? 'filter-chevron-open' : ''"
                  aria-hidden="true"
                >
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6 9l6 6 6-6"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </span>
              </button>
            
              <!-- dropdown menu -->
              <div
                class="filter-dropdown"
                x-show="subjectDropdownOpen"
                x-transition
              >
                <template x-for="opt in subjectOptions" :key="opt">
                  <button
                    type="button"
                    class="filter-dropdown-item"
                    @click="toggleSubject(opt)"
                  >
                    <span x-text="opt"></span>
                    <span
                      class="filter-dropdown-check"
                      x-show="selectedSubjects.includes(opt)"
                    >
                      ✓
                    </span>
                  </button>
                </template>
              </div>
            </div>

            <!-- Tags -->
            <div>
              <button
                type="button"
                id="filter-tags"
                class="filter-control"
                aria-label="Filter by tag"
              >
                <span class="filter-placeholder">Planning tag</span>
                <span class="filter-chevron" aria-hidden="true">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6 9l6 6 6-6"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </span>
              </button>
            </div>

            <!-- Search -->
            <div>
              <div class="filter-control" aria-label="Search courses or topics">
                <input
                  id="filter-search"
                  type="search"
                  placeholder="Search"
                  autocomplete="off"
                />
                <span class="search-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <circle
                      cx="11"
                      cy="11"
                      r="6.5"
                      stroke="currentColor"
                      stroke-width="1.8"
                      fill="none"
                    />
                    <line
                      x1="15"
                      y1="15"
                      x2="20"
                      y2="20"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                    />
                  </svg>
                </span>
              </div>
            </div>
          </div>

          <div class="filter-actions">
            <!-- Left: clear + print buttons -->
            <div class="flex gap-2">
              <button type="button" class="btn-pill" @click="clearAllFilters()">
                <span class="btn-pill-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <line x1="6" y1="6" x2="18" y2="18"
                          stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <line x1="18" y1="6" x2="6" y2="18"
                          stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                  </svg>
                </span>
                <span>Clear selected</span>
              </button>

              <button type="button" class="btn-pill btn-secondary print-btn">
                <span class="btn-pill-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="5" y="9" width="14" height="9" rx="1.5" ry="1.5"
                          fill="none" stroke="currentColor" stroke-width="1.8" />
                    <path d="M8 9V5h8v4"
                          fill="none" stroke="currentColor" stroke-width="1.8" />
                    <rect x="9" y="13" width="6" height="4"
                          fill="none" stroke="currentColor" stroke-width="1.5" />
                    <circle cx="17" cy="12" r="0.9" fill="currentColor" />
                  </svg>
                </span>
                <span>Print</span>
              </button>
            </div>

            <!-- Right: toggles -->
            <div class="flex gap-4 justify-start md:justify-end flex-wrap">
              <div
                class="toggle"
                :class="showAllDetails ? 'toggle--on' : ''"
                @click="toggleAllDetails()"
              >
                <div class="toggle-switch">
                  <div class="toggle-switch-knob"></div>
                </div>
                <span>Show descriptions &amp; tips</span>
              </div>

              <div class="toggle">
                <div class="toggle-switch">
                  <div class="toggle-switch-knob"></div>
                </div>
                <span>Show my courses only</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dynamic course list -->
      <div class="course-list-shell mt-10">
      
        <!-- Loading & error states -->
        <p x-show="isLoadingCourses" class="text-sm text-muted">Loading courses…</p>
        <p x-show="!isLoadingCourses && loadError" class="text-sm text-red-600" x-text="loadError"></p>
      
        <!-- Subjects, courses, and topics -->
        <template x-if="!isLoadingCourses && !loadError">
          <div>
            <template x-for="(courseGroup, subjectName) in coursesBySubject" :key="subjectName">
              <section
                class="subject-block"
                :class="'subject--' + subjectName.toLowerCase().replace(/[^a-z0-9]+/g, '-')"
              >
                <h3 class="subject-title" x-text="subjectName"></h3>
      
                <div class="subject-courses">
                  <template x-for="course in courseGroup" :key="course.id">
                    <article class="course-card" :style="`border-color: ${subjectColor(course.subject)}`">
                      <!-- Title row with chevron -->
                      <div class="card-header">
                        <h4 class="course-title" x-text="course.title"></h4>

                          <!-- Chevron only if description or tips exist -->
                          <template x-if="course.description || course.tips">
                            <button
                              type="button"
                              class="card-toggle"
                              :class="course.detailsOpen ? '' : 'card-toggle--closed'"
                              @click="course.detailsOpen = !course.detailsOpen"
                              aria-label="Toggle course details"
                            >
                              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path
                                  d="M6 9l6 6 6-6"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.8"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                              </svg>
                            </button>
                          </template>
                      </div>
                    
                      <!-- grade + schedule line -->
                      <p
                        class="course-meta"
                        x-show="course.gradeText || course.schedText"
                      >
                        <!-- left: schedule (if any) -->
                        <template x-if="course.schedText">
                          <span
                            class="meta-schedule"
                            :class="course.gradeText ? 'meta-schedule--with-grade' : 'meta-schedule--solo'"
                            x-text="course.schedText"
                          ></span>
                        </template>
                      
                        <!-- middle: grade (if any) -->
                        <template x-if="course.gradeText">
                          <span
                            :class="course.schedText ? 'meta-grade meta-grade--with-sched' : 'meta-grade meta-grade--solo'"
                            x-text="course.gradeText"
                          ></span>
                        </template>
                      
                        <!-- spacer pushes planning tag area to far right -->
                        <span class="meta-flex-spacer"></span>

                        <!-- right: planning tag UI (courses *without* topics only) -->
                        <template x-if="!course.topics || course.topics.length === 0">
                          <span
                            class="planning-tag-wrapper"
                            @click.outside="course.planningTagMenuOpen = false"
                          >
                            <span class="planning-tag-region">
                              <!-- If no tags yet: show "+ Planning tag" button -->
                              <template x-if="!course.planningTags || course.planningTags.length === 0">
                                <button
                                  type="button"
                                  class="planning-tag-button"
                                  aria-label="Add planning tag to course"
                                  @click.stop="course.planningTagMenuOpen = !course.planningTagMenuOpen"
                                >
                                  <span class="planning-tag-label">+ Planning tag</span>
                                </button>
                              </template>

                              <!-- If tags exist: show images + small "+" square -->
                              <template x-if="course.planningTags && course.planningTags.length > 0">
                                <div class="planning-tag-selected-row">
                                  <template x-for="tag in course.planningTags" :key="tag.id">
                                    <div class="planning-tag-pill">
                                      <img
                                        class="planning-tag-img"
                                        :src="tag.img"
                                        :alt="tag.label"
                                      />
                                      <button
                                        type="button"
                                        class="planning-tag-remove"
                                        @click.stop="removePlanningTag(course, tag.id)"
                                        aria-label="Remove planning tag"
                                      >
                                        ×
                                      </button>
                                    </div>
                                  </template>

                                  <button
                                    type="button"
                                    class="planning-tag-add"
                                    aria-label="Add more planning tags"
                                    @click.stop="course.planningTagMenuOpen = !course.planningTagMenuOpen"
                                  >
                                    +
                                  </button>
                                </div>
                              </template>
                            </span>

                            <!-- anchored dropdown for planning tags -->
                            <div
                              class="planning-tag-menu"
                              x-show="course.planningTagMenuOpen"
                              x-transition
                            >
                              <template x-for="opt in planningTagOptions" :key="opt.id">
                                <button
                                  type="button"
                                  class="planning-tag-option"
                                  @click="togglePlanningTag(course, opt)"
                                >
                                  <span class="planning-tag-option-main">
                                    <img :src="opt.img" :alt="opt.label" />
                                    <span x-text="opt.label"></span>
                                  </span>
                                  <span
                                    class="filter-dropdown-check"
                                    x-show="course.planningTags && course.planningTags.some(t => t.id === opt.id)"
                                  >
                                    ✓
                                  </span>
                                </button>
                              </template>
                            </div>
                          </span>
                        </template>
                      </p>
                    
                      <!-- Description + combining tips -->
                      <div
                        class="course-detail-row"
                        x-show="showAllDetails && course.detailsOpen && (course.description || course.tips)"
                        x-transition
                      >
                        <div
                          class="course-detail-description"
                          x-show="course.description"
                          x-text="course.description"
                        ></div>
                    
                        <div
                          class="course-detail-tips"
                          x-show="course.tips"
                        >
                          <span class="course-detail-tips-icon" aria-hidden="true">
                            <!-- “join” icon -->
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <circle
                                cx="9"
                                cy="12"
                                r="4"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.7"
                              />
                              <circle
                                cx="15"
                                cy="12"
                                r="4"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.7"
                              />
                            </svg>
                          </span>
                          <span x-text="course.tips"></span>
                        </div>
                      </div>
      
                      <!-- Nested topics (titles only for now) -->
                      <div class="topic-list" x-show="course.topics.length">
                        <template x-for="topic in course.topics" :key="topic.recordID">
                          <article class="topic-card">
                            <!-- Title row with chevron -->
                            <div class="card-header">
                              <h5 class="topic-title" x-text="topic.Topic"></h5>

                                <!-- Chevron only if description or tips exist -->
                                <template x-if="topic.description || topic.tips">
                                  <button
                                    type="button"
                                    class="card-toggle"
                                    :class="topic.detailsOpen ? '' : 'card-toggle--closed'"
                                    @click="topic.detailsOpen = !topic.detailsOpen"
                                    aria-label="Toggle topic details"
                                  >
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                      <path
                                        d="M6 9l6 6 6-6"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.8"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                      />
                                    </svg>
                                  </button>
                                </template>
                            </div>
                          
                              <p
                                class="course-meta topic-meta"
                                x-show="topic.gradeText || topic.schedText"
                              >
                                <!-- left: schedule -->
                                <template x-if="topic.schedText">
                                  <span
                                    class="meta-schedule"
                                    :class="topic.gradeText ? 'meta-schedule--with-grade' : 'meta-schedule--solo'"
                                    x-text="topic.schedText"
                                  ></span>
                                </template>
                              
                                <!-- middle: grade -->
                                <template x-if="topic.gradeText">
                                  <span
                                    :class="topic.schedText ? 'meta-grade meta-grade--with-sched' : 'meta-grade meta-grade--solo'"
                                    x-text="topic.gradeText"
                                  ></span>
                                </template>
                              
                                <!-- spacer -->
                                <span class="meta-flex-spacer"></span>

                                <!-- right: planning tag UI (topics always can have tags) -->
                                <span
                                  class="planning-tag-wrapper"
                                  @click.outside="topic.planningTagMenuOpen = false"
                                >
                                  <span class="planning-tag-region">
                                    <!-- No tags yet -->
                                    <template x-if="!topic.planningTags || topic.planningTags.length === 0">
                                      <button
                                        type="button"
                                        class="planning-tag-button"
                                        aria-label="Add planning tag to topic"
                                        @click.stop="topic.planningTagMenuOpen = !topic.planningTagMenuOpen"
                                      >
                                        <span class="planning-tag-label">+ Planning tag</span>
                                      </button>
                                    </template>

                                    <!-- Tags selected -->
                                    <template x-if="topic.planningTags && topic.planningTags.length > 0">
                                      <div class="planning-tag-selected-row">
                                        <template x-for="tag in topic.planningTags" :key="tag.id">
                                          <div class="planning-tag-pill">
                                            <img
                                              class="planning-tag-img"
                                              :src="tag.img"
                                              :alt="tag.label"
                                            />
                                            <button
                                              type="button"
                                              class="planning-tag-remove"
                                              @click.stop="removePlanningTag(topic, tag.id)"
                                              aria-label="Remove planning tag"
                                            >
                                              ×
                                            </button>
                                          </div>
                                        </template>

                                        <button
                                          type="button"
                                          class="planning-tag-add"
                                          aria-label="Add more planning tags"
                                          @click.stop="topic.planningTagMenuOpen = !topic.planningTagMenuOpen"
                                        >
                                          +
                                        </button>
                                      </div>
                                    </template>
                                  </span>

                                  <!-- anchored dropdown -->
                                  <div
                                    class="planning-tag-menu"
                                    x-show="topic.planningTagMenuOpen"
                                    x-transition
                                  >
                                    <template x-for="opt in planningTagOptions" :key="opt.id">
                                      <button
                                        type="button"
                                        class="planning-tag-option"
                                        @click="togglePlanningTag(topic, opt)"
                                      >
                                        <span class="planning-tag-option-main">
                                          <img :src="opt.img" :alt="opt.label" />
                                          <span x-text="opt.label"></span>
                                        </span>
                                        <span
                                          class="filter-dropdown-check"
                                          x-show="topic.planningTags && topic.planningTags.some(t => t.id === opt.id)"
                                        >
                                          ✓
                                        </span>
                                      </button>
                                    </template>
                                  </div>
                                </span>
                              </p>

                            <div
                              class="course-detail-row"
                              x-show="showAllDetails && topic.detailsOpen && (topic.description || topic.tips)"
                              x-transition
                            >
                              <div
                                class="course-detail-description"
                                x-show="topic.description"
                                x-text="topic.description"
                              ></div>
                          
                              <div
                                class="course-detail-tips"
                                x-show="topic.tips"
                              >
                                <span class="course-detail-tips-icon" aria-hidden="true">
                                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle
                                      cx="9"
                                      cy="12"
                                      r="4"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.7"
                                    />
                                    <circle
                                      cx="15"
                                      cy="12"
                                      r="4"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.7"
                                    />
                                  </svg>
                                </span>
                                <span x-text="topic.tips"></span>
                              </div>
                            </div>
                          </article>

                        </template>
                      </div>
                      
                    </article>
                  </template>
                </div>
              </section>
              
            </template>
          </div>
        </template>
      </div>
      
    </section>

    <!-- STEP 4: Book list -->
    <section x-show="step === 4" x-cloak>
      <h2 class="section-title">Book list</h2>
      <p class="section-subtitle">
        This tab will contain the integrated book list experience. We’ll reuse
        the logic and layout from your current book list page and adapt it to
        match the new branding.
      </p>

      <div class="mt-6 rounded-2xl bg-white shadow-sm border border-dashed border-gray-300 p-6">
        <p class="text-sm text-gray-700 mb-3">
          Book list UI coming soon.
        </p>
        <p class="text-xs text-gray-500">
          For now, you can continue to reference <code>books (6).html</code>
          while we migrate the filters, assigned resources, and tags into this
          step.
        </p>
      </div>
    </section>
  </main>

  <script>
  const MA_COURSES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=0&single=true&output=csv";
  const MA_TOPICS_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=1919021076&single=true&output=csv";

  async function fetchAndParseCSV(url) {
    const response = await fetch(url);
    const text = await response.text();

    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });

    // Filter out completely empty rows, just in case
    return parsed.data.filter(row =>
      Object.values(row).some(v => v !== null && String(v).trim() !== "")
    );
  }

  function coursePlanner() {
    return {
      // existing state
      step: 3,
      openStep(n) {
        this.step = n;
        window.scrollTo({ top: 0, behavior: "smooth" });
      },

      // new global detail toggle
      showAllDetails: true,

      // --- FILTER STATE (grade) ---
      selectedGrades: [],          // e.g. ["G1", "G3"]
      gradeDropdownOpen: false,
      gradeOptions: [
        { code: "G1",  label: "Grade 1"  },
        { code: "G2",  label: "Grade 2"  },
        { code: "G3",  label: "Grade 3"  },
        { code: "G4",  label: "Grade 4"  },
        { code: "G5",  label: "Grade 5"  },
        { code: "G6",  label: "Grade 6"  },
        { code: "G7",  label: "Grade 7"  },
        { code: "G8",  label: "Grade 8"  },
        { code: "G9",  label: "Grade 9"  },
        { code: "G10", label: "Grade 10" },
        { code: "G11", label: "Grade 11" },
        { code: "G12", label: "Grade 12" },
      ],

      // --- FILTER STATE (subject) ---
      selectedSubjects: [],       // e.g. ["Science", "Art"]
      subjectDropdownOpen: false,
      // Order matches subject display (Science, then Alt. Science Options directly after)
      subjectOptions: [
        "Architecture",
        "Art",
        "Bible",
        "Citizenship",
        "English",
        "Geography",
        "History",
        "Latin",
        "Life Skills",
        "Literature",
        "Math",
        "Modern Language",
        "Music",
        "Physical Education",
        "Science",
        "Alt. Science Options",
      ],

      // --- PLANNING TAG OPTIONS ---
      // Adjust image filenames/paths as needed so they match your repo
      planningTagOptions: [
        {
          id: "core",
          label: "Core",
          img: "Core%20Subjects.png",
        },
        {
          id: "family",
          label: "Family",
          img: "Family%20Subjects.png",
        },
        {
          id: "combine",
          label: "Combine",
          img: "Combine%20Subjects.png",
        },
        {
          id: "high-interest",
          label: "High interest",
          img: "High%20Interest%20Subjects.png",
        },
        {
          id: "additional",
          label: "Additional",
          img: "Additional%20Subjects.png",
        },
      ],

      toggleAllDetails() {
        this.showAllDetails = !this.showAllDetails;
      },

      // label helper for chips
      gradeLabelFromCode(code) {
        const found = this.gradeOptions.find(o => o.code === code);
        return found ? found.label : code;
      },

      // toggle a grade in/out of the selection
      toggleGrade(code) {
        const idx = this.selectedGrades.indexOf(code);
        if (idx === -1) {
          this.selectedGrades.push(code);
        } else {
          this.selectedGrades.splice(idx, 1);
        }
        this.applyFilters();
      },

      // remove a single grade (chip ×)
      removeGrade(code) {
        this.selectedGrades = this.selectedGrades.filter(c => c !== code);
        this.applyFilters();
      },

      // --- SUBJECT FILTER HELPERS ---
      toggleSubject(name) {
        const idx = this.selectedSubjects.indexOf(name);
        if (idx === -1) {
          this.selectedSubjects.push(name);
        } else {
          this.selectedSubjects.splice(idx, 1);
        }
        this.applyFilters();
      },

      removeSubject(name) {
        this.selectedSubjects = this.selectedSubjects.filter(s => s !== name);
        this.applyFilters();
      },

      subjectMatches(courseSubject) {
        if (!this.selectedSubjects.length) return true; // no subject filter
        if (!courseSubject) return false;
        const subj = courseSubject.trim();
        return this.selectedSubjects.includes(subj);
      },

            // --- PLANNING TAG HELPERS ---
      togglePlanningTag(item, opt) {
        if (!item.planningTags) item.planningTags = [];

        const existingIndex = item.planningTags.findIndex(t => t.id === opt.id);
        if (existingIndex === -1) {
          // add
          item.planningTags.push({
            id: opt.id,
            label: opt.label,
            img: opt.img,
          });
        } else {
          // remove
          item.planningTags.splice(existingIndex, 1);
        }
      },

      removePlanningTag(item, tagId) {
        if (!item.planningTags) return;
        item.planningTags = item.planningTags.filter(t => t.id !== tagId);
      },

      // clear everything (used by Clear selected button)
      clearAllFilters() {
        this.selectedGrades = [];
        this.gradeDropdownOpen = false;

        this.selectedSubjects = [];
        this.subjectDropdownOpen = false;

        this.applyFilters();
      },

      // helper: does this item match the grade filter?
      gradeMatches(tags) {
        if (!this.selectedGrades.length) return true;  // no filter => match all
        if (!tags || !tags.length) return false;
        return this.selectedGrades.some(code => tags.includes(code));
      },

      // rebuild coursesBySubject from allCoursesBySubject + filters
      applyFilters() {
        const hasGrade   = this.selectedGrades.length > 0;
        const hasSubject = this.selectedSubjects.length > 0;

        // No filters => show full dataset
        if (!hasGrade && !hasSubject) {
          this.coursesBySubject = this.allCoursesBySubject;
          return;
        }

        const filtered = {};
        const subjects = Object.keys(this.allCoursesBySubject);

        subjects.forEach(subject => {
          const courses = this.allCoursesBySubject[subject];
          const subjectCourses = [];

          courses.forEach(course => {
            // grade check (course-level only)
            const matchesGrade =
              !hasGrade || this.gradeMatches(course.gradeTags);

            // subject check (course.subject must match one of selectedSubjects)
            const matchesSubject =
              !hasSubject || this.subjectMatches(course.subject);

            if (!(matchesGrade && matchesSubject)) return;

            // If course passes filters, include it with all its topics
            const courseCopy = {
              ...course,
              topics: course.topics || [],
            };

            subjectCourses.push(courseCopy);
          });

          // Only include subject if it has at least one visible course
          if (subjectCourses.length) {
            filtered[subject] = subjectCourses;
          }
        });

        this.coursesBySubject = filtered;
      },

      // new state for courses
      isLoadingCourses: true,
      loadError: "",
      allCoursesBySubject: {}, // full dataset
      coursesBySubject: {},    // filtered view

      subjectColors: {
      'Architecture': '#a0a6be',
      'Art': '#907061',
      'Bible': '#964945',
      'Citizenship': '#62765c',
      'English': '#9b5b7b',
      'Geography': '#4d8da2',
      'History': '#6b6bbf',
      'Latin': '#5a5373',
      'Life Skills': '#d1b358',
      'Literature': '#c07669',
      'Math': '#6d7eaa',
      'Modern Language': '#6db4b2',
      'Music': '#9e6bac',
      'Physical Education': '#bd855e',
      'Science': '#96a767',
      'Alt. Science Options': '#96a767'
    },
    
    subjectColor(name) {
      if (!name) return '#dde2d5';
      const key = Object.keys(this.subjectColors).find(k =>
        k.toLowerCase() === name.toLowerCase()
      );
      return key ? this.subjectColors[key] : '#dde2d5';
    },

      async init() {
        await this.loadCourses();
      },

      async loadCourses() {
        this.isLoadingCourses = true;
        this.loadError = "";
        try {
          const [coursesRaw, topicsRaw] = await Promise.all([
            fetchAndParseCSV(MA_COURSES_URL),
            fetchAndParseCSV(MA_TOPICS_URL),
          ]);
      
          // Build a lookup table for topics by Topic_ID
          const topicById = {};
            topicsRaw.forEach(t => {
              const id = (t.Topic_ID || "").trim();
              if (!id) return;
            
              const gradeText = (t.Grade_Text || "").trim();
              const schedText = (t.Scheduling_R3 || "").trim();
              const description = (t.Program_Description_R3 || "").trim();
              const tips = (t["Combining&PlacementTips_R3"] || "").trim();
              const gradeTags = (t.Grade_Filter || "")
                .split(",")
                .map(s => s.trim())
                .filter(Boolean);
            
              topicById[id] = {
                ...t,
                gradeText,
                schedText,
                description,
                tips,
                gradeTags,
                detailsOpen: true,
                planningTags: [],
                planningTagMenuOpen: false,
              };
            });
      
          // Group courses by Subject, attach topics via Topic_ID_App
          const grouped = {};
      
          coursesRaw.forEach(c => {
            const subject  = (c.Subject || "Other").trim();
            const courseId = (c.Course_ID || "").trim();
            const title    = (c.Course || "").trim();
            if (!title) return;
      
            const gradeText = (c.Grade_Text || "").trim();
            const schedText = (c.Scheduling_R3 || "").trim();
            const description = (c.Program_Description_R3 || "").trim();
            const tips = (c["Combining&PlacementTips_R3"] || "").trim();
            const gradeTags = (c.Grade_Filter || "")
              .split(",")
              .map(s => s.trim())
              .filter(Boolean);
            const parts = [];
            if (gradeText) parts.push(gradeText);
            if (schedText) parts.push(schedText);
            const metaLine = parts.join(" | ");
      
            // Collect topics for this course using Topic_ID_App
            let topicsForCourse = [];
            const topicIdList = (c.Topic_ID_App || "").trim();
            if (topicIdList) {
              const ids = topicIdList
                .split(",")
                .map(s => s.trim())
                .filter(Boolean);
      
              topicsForCourse = ids
                .map(id => topicById[id])
                .filter(Boolean);
            }
      
            const courseObj = {
              id: c.recordID || courseId || title,
              title,
              subject,
              courseId,
              gradeText,
              schedText,
              description,
              tips,
              gradeTags,
              metaLine,
              detailsOpen: true,
              planningTags: [],
              planningTagMenuOpen: false,
              topics: topicsForCourse,
            };
      
            if (!grouped[subject]) grouped[subject] = [];
            grouped[subject].push(courseObj);
          });
      
          // --- SPECIAL SUBJECT ORDERING ---
          const ALT_LABEL = "Alt. Science Options";
      
          // Start with normal alphabetical order
          let subjects = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
      
          // If we have both Science and Alt. Science Options, move Alt. right after Science
          const sciIdx = subjects.indexOf("Science");
          const altIdx = subjects.indexOf(ALT_LABEL);
      
          if (sciIdx !== -1 && altIdx !== -1) {
            // Remove Alt. Science from wherever it is…
            subjects.splice(altIdx, 1);
            // …and insert it immediately after Science
            subjects.splice(sciIdx + 1, 0, ALT_LABEL);
          }
      
          const sorted = {};
          subjects.forEach(subject => {
            const courses = grouped[subject];
      
            // Sort courses by Course_ID then title
            courses.sort((a, b) => {
              const aId = a.courseId || "";
              const bId = b.courseId || "";
              if (aId < bId) return -1;
              if (aId > bId) return 1;
              return a.title.localeCompare(b.title);
            });
      
            // Sort topics within each course by Topic_ID then Topic
            courses.forEach(course => {
              course.topics.sort((ta, tb) => {
                const aId = (ta.Topic_ID || "").trim();
                const bId = (tb.Topic_ID || "").trim();
                if (aId < bId) return -1;
                if (aId > bId) return 1;
                return (ta.Topic || "").localeCompare(tb.Topic || "");
              });
            });
      
            sorted[subject] = courses;
          });
      
          this.allCoursesBySubject = sorted;
          this.applyFilters();
        } catch (err) {
          console.error("Error loading course data", err);
          this.loadError =
            "We couldn’t load the course data. Please try refreshing the page.";
        } finally {
          this.isLoadingCourses = false;
        }
      },
    };
  }
</script>
  
</body>
</html>
