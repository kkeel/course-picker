<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 1. Required basics -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary – Planner</title>

  <!-- 2. PWA / App metadata -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#596e5e">

  <!-- iOS support -->
  <link rel="apple-touch-icon" href="./img/icon/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- 3. Fonts -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
  />
  
  <!-- 4. CSS -->
  <link rel="stylesheet" href="css/styles.css">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" type="image/png" href="img/Alveary%20Lt.%20Green.png">

</head>

<body x-data="coursePlanner()" x-init="init()">

  <!-- Header -->
  <header class="app-header mb-8 px-6 md:px-16 py-4 md:py-6 flex flex-col md:flex-row md:items-center gap-4">
    <!-- Logo + wordmark -->
    <div class="flex items-center gap-3">
      <img
        src="img/Alveary%20Lt.%20Green.png"
        alt="Alveary logo"
        class="object-contain"
        style="height: 40px; width: 40px;"
      />
      <div class="logo-text-block">
        <span class="logo-title">Alveary</span>

        <!-- PRINT-ONLY: year under Alveary (left) -->
        <span class="print-year-left">2026–2027</span>
      </div>
    </div>

    <!-- Top-right: staff toggle + nav (screen only) -->
    <div class="mt-3 md:mt-0 md:ml-auto flex items-center justify-end gap-6 text-sm">
      <!-- Staff-only: Edit mode (inline, before nav) -->
      <div
        class="toggle"
        x-show="isStaff"
        style="display:none"
        :class="editMode ? 'toggle--on' : ''"
        @click="toggleEditMode()"
      >
        <div class="toggle-switch">
          <div class="toggle-switch-knob"></div>
        </div>
        <span x-text="editMode ? 'Edit Mode' : 'Published'"></span>
      </div>
    
      <!-- navigation tabs -->
      <nav class="flex items-center gap-x-6 text-sm">
        <a href="index.html" class="nav-tab nav-tab-active">Course List</a>
        <a href="books.html" class="nav-tab">Book List</a>
      </nav>
    </div>

    <!-- PRINT-ONLY: Course List + grade/master label on the right -->
    <div class="print-header-title-block">
      <div class="print-header-title">Course List</div>
      <div class="print-header-grade" x-text="gradePrintLabel()"></div>
    </div>
    
  </header>

  <!-- PRINT-ONLY FOOTER -->
  <footer class="print-footer" aria-hidden="true">
    <div class="print-footer-left">Alveary Course List</div>
    <div class="print-footer-center">©2026 Charlotte Mason Institute® All rights reserved.</div>
    <div class="print-footer-right">
      <span class="print-footer-grade" x-text="gradePrintLabel()"></span>
      <span class="print-page-number"></span>
    </div>
  </footer>

  <!-- Main content -->
  <main class="max-w-6xl mx-auto px-6 lg:px-16 pb-16 space-y-10">

    <!-- Course List -->
    <section>
      <h2 class="section-title">Course List</h2>
      <p class="section-subtitle">
        This is an intuitive course planner that helps organize your school year.
        Browse courses by subject, view descriptions and placement tips, and easily tag, note,
        or save your selections for a personalized learning plan.
      </p>

      <!-- Filter state + panel (both stick under header) -->
      <div class="filter-state-wrapper">
        <!-- Sticky bar -->
        <div class="flex justify-center">
          <div
            class="filter-state-bar"
            x-show="!isLoadingCourses && !loadError"
            x-cloak
            @click="toggleFiltersOpen()"
          >
            <div class="filter-state-main">
              <span class="filter-state-label">Filter by</span>
              <span class="filter-state-summary" x-text="filterSummary"></span>
            </div>
        
            <div class="filter-state-actions">
              <span
                class="filter-state-toggle-text"
                x-text="filtersOpen ? 'Hide' : 'Show'"
              ></span>
            </div>
          </div>
        </div>

        <!-- Sticky panel (only shown when filtersOpen === true) -->
        <div
          class="mt-0 flex justify-center"
          id="course-filters"
          x-show="filtersOpen"
          x-transition
        >
          <div class="filter-panel">
            <div class="filter-grid">
              <!-- Grade -->
              <div class="relative" @click.outside="gradeDropdownOpen = false">
                <button
                  type="button"
                  id="filter-grade"
                  class="filter-control"
                  aria-label="Filter by grade"
                  @click="gradeDropdownOpen = !gradeDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedGrades.length === 0">
                    <span class="filter-placeholder">Grade</span>
                  </template>

                  <!-- chips when grades are selected -->
                  <template x-if="selectedGrades.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="code in selectedGrades" :key="code">
                        <span class="filter-chip">
                          <span x-text="gradeLabelFromCode(code)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeGrade(code)"
                            aria-label="Remove grade"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>

                  <span
                    class="filter-chevron"
                    :class="gradeDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>

                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="gradeDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in gradeOptions" :key="opt.code">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleGrade(opt.code)"
                    >
                      <span x-text="opt.label"></span>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedGrades.includes(opt.code)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Subject -->
              <div class="relative" @click.outside="subjectDropdownOpen = false">
                <button
                  type="button"
                  id="filter-subject"
                  class="filter-control"
                  aria-label="Filter by subject"
                  @click="subjectDropdownOpen = !subjectDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedSubjects.length === 0">
                    <span class="filter-placeholder">Subject</span>
                  </template>
              
                  <!-- chips when subjects are selected -->
                  <template x-if="selectedSubjects.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="subj in selectedSubjects" :key="subj">
                        <span
                          class="filter-chip"
                          :style="`background-color: ${subjectColor(subj)}4D;`"
                        >
                          <span x-text="subj"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeSubject(subj)"
                            aria-label="Remove subject"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="subjectDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="subjectDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in subjectOptions" :key="opt">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleSubject(opt)"
                    >
                      <span x-text="opt"></span>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedSubjects.includes(opt)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Tags -->
              <div class="relative" @click.outside="tagDropdownOpen = false">
                <button
                  type="button"
                  id="filter-tags"
                  class="filter-control"
                  aria-label="Filter by planning tag"
                  @click="tagDropdownOpen = !tagDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedTags.length === 0">
                    <span class="filter-placeholder">Planning tag</span>
                  </template>
              
                  <!-- chips when tags are selected -->
                  <template x-if="selectedTags.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="tagId in selectedTags" :key="tagId">
                        <span class="filter-chip">
                          <span x-text="planningTagLabel(tagId)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeSelectedTag(tagId)"
                            aria-label="Remove tag"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="tagDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="tagDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in planningTagOptions" :key="opt.id">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleSelectedTag(opt.id)"
                    >
                      <div class="planning-tag-option-main">
                        <img
                          :src="opt.img"
                          :alt="opt.label"
                        />
                        <span x-text="opt.label"></span>
                      </div>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedTags.includes(opt.id)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Search -->
              <div>
                <div class="filter-control" aria-label="Search courses or topics">
                  <input
                    id="filter-search"
                    type="search"
                    placeholder="Search"
                    autocomplete="off"
                    x-model="searchQuery"
                    @input="applyFilters()"
                  />
                  <span class="search-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <circle
                        cx="11"
                        cy="11"
                        r="6.5"
                        stroke="currentColor"
                        stroke-width="1.8"
                        fill="none"
                      />
                      <line
                        x1="15"
                        y1="15"
                        x2="20"
                        y2="20"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                      />
                    </svg>
                  </span>
                </div>
              </div>
            </div>


            <!-- Students: manage + filter -->
            <div class="student-tools-row" @click.stop>
              <!-- Student (multi-select, chip-style like other filters) -->
              <div class="relative" @click.outside="studentDropdownOpen = false">
                <button
                  type="button"
                  id="filter-student"
                  class="filter-control"
                  aria-label="Filter by student"
                  @click="studentDropdownOpen = !studentDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="!selectedStudents || selectedStudents.length === 0">
                    <span class="filter-placeholder">All Students</span>
                  </template>
              
                  <!-- chips when students are selected -->
                  <template x-if="selectedStudents && selectedStudents.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="sid in selectedStudents" :key="sid">
                        <span
                          class="filter-chip filter-chip--student"
                          :style="`background-color:${studentColorFromId(sid)};`"
                        >
                          <span x-text="studentNameFromId(sid)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeStudentFilter(sid)"
                            aria-label="Remove student"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="studentDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div class="filter-dropdown" x-show="studentDropdownOpen" x-transition>
                  <template x-for="s in students" :key="s.id">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleStudentFilter(s.id)"
                    >
                      <span class="student-dd-row">
                        <span
                          class="student-dd-swatch"
                          :style="`background-color:${s.color || '#596e5e'}`"
                          aria-hidden="true"
                        ></span>
                        <span x-text="s.name || 'Unnamed'"></span>
                      </span>
                  
                      <span class="filter-dropdown-check" x-show="selectedStudents.includes(s.id)">✓</span>
                    </button>
                  </template>
                </div>
              </div>

              <button
                type="button"
                class="manage-students-toggle"
                @click.stop="toggleStudentsOpen()"
                :aria-expanded="studentsOpen ? 'true' : 'false'"
              >
                Manage Students
              </button>
            </div>

            <div
              class="student-manager"
              x-show="studentsOpen"
              x-transition
              x-cloak
              @click.stop
            >
              <p class="student-manager-help">
                Add up to 15 students. Click color buttons to change student colors.
              </p>

              <div class="student-list">
                <template x-for="s in students" :key="s.id">
                  <div>
                    <div class="student-row">
                      <!-- Color square (click to open swatches) -->
                      <button
                        type="button"
                        class="student-color-btn"
                        :style="{ backgroundColor: s.color }"
                        @click.stop="toggleStudentColorPicker(s.id)"
                        aria-label="Choose student color"
                        title="Choose color"
                      ></button>
                    
                      <input
                        class="student-name-input"
                        type="text"
                        placeholder="Student name"
                        :value="s.name"
                        @input="updateStudentName(s.id, $event.target.value)"
                      />
                    
                      <!-- Subtle X remove -->
                      <button
                        type="button"
                        class="student-remove-x"
                        @click.stop="removeStudent(s.id)"
                        aria-label="Remove student"
                        title="Remove"
                      >×</button>
                    </div>

                    <div class="student-swatches" x-show="colorPickerFor === s.id" x-transition>
                      <template x-for="c in studentColorPalette" :key="c">
                        <button
                          type="button"
                          class="student-swatch"
                          :class="s.color === c ? 'student-swatch--selected' : ''"
                          :style="{ backgroundColor: c }"
                          @click="setStudentColor(s.id, c)"
                          :aria-label="`Set color ${c}`"
                          title="Set color"
                        ></button>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="student-add-row">
                <input
                  class="student-name-input"
                  type="text"
                  placeholder="Add a student…"
                  x-model="newStudentName"
                  @keydown.enter.prevent="addStudent()"
                />
                <button
                  type="button"
                  class="student-row-btn"
                  @click="addStudent()"
                  :disabled="!canAddStudent"
                >Add</button>
              </div>
            </div>

            <div class="filter-actions">
              <!-- Left: clear + print buttons -->
              <div class="flex gap-2">
                <button
                  type="button"
                  class="btn-pill"
                  @click="clearAllBookmarks()"
                >
                  <span class="btn-pill-icon bookmark-reset" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <!-- bookmark outline -->
                      <path d="M7 5h10v14l-5-3-5 3V5z"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.8"
                            stroke-linejoin="round" />
                      <!-- X inside bookmark -->
                      <line x1="9" y1="9" x2="15" y2="15"
                            stroke="currentColor"
                            stroke-width="1.8"
                            stroke-linecap="round" />
                      <line x1="15" y1="9" x2="9" y2="15"
                            stroke="currentColor"
                            stroke-width="1.8"
                            stroke-linecap="round" />
                    </svg>
                  </span>
                  <span>Clear bookmarks</span>
                </button>

                <button
                  type="button"
                  class="btn-pill btn-secondary print-btn"
                  @click="openPrintTip()"
                >
                  <span class="btn-pill-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="9" width="14" height="9" rx="1.5" ry="1.5"
                            fill="none" stroke="currentColor" stroke-width="1.8" />
                      <path d="M8 9V5h8v4"
                            fill="none" stroke="currentColor" stroke-width="1.8" />
                      <rect x="9" y="13" width="6" height="4"
                            fill="none" stroke="currentColor" stroke-width="1.5" />
                      <circle cx="17" cy="12" r="0.9" fill="currentColor" />
                    </svg>
                  </span>
                  <span>Print</span>
                </button>
              </div>

              <!-- Right: toggles -->
              <div class="flex gap-4 justify-start md:justify-end flex-wrap">
                <div
                  class="toggle"
                  :class="showAllDetails ? 'toggle--on' : ''"
                  @click="toggleAllDetails()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>Descriptions &amp; Tips</span>
                </div>

                <div
                  class="toggle"
                  :class="myCoursesOnly ? 'toggle--on' : ''"
                  @click="toggleMyCoursesOnly()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>My Courses</span>
                </div>
                <div
                  class="toggle"
                  :class="myNotesOpen ? 'toggle--on' : ''"
                  @click="toggleMyNotes()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>My Notes</span>
                </div>
              </div>
            </div>
          </div> <!-- .filter-panel -->
        </div>   <!-- #course-filters -->
      </div>     <!-- .filter-state-wrapper -->

      <!-- Dynamic course list -->
      <div class="course-list-shell mt-10">
      
        <!-- Loading & error states -->
        <p x-show="isLoadingCourses" class="text-sm text-muted">Loading courses…</p>
        <p x-show="!isLoadingCourses && loadError" class="text-sm text-red-600" x-text="loadError"></p>
      
        <!-- Subjects, courses, and topics -->
        <template x-if="!isLoadingCourses && !loadError">
          <div>
            <template x-for="(courseGroup, subjectName) in visibleCourseGroups()" :key="subjectName">
              <section
                class="subject-block"
                :class="'subject--' + subjectName.toLowerCase().replace(/[^a-z0-9]+/g, '-')"
              >
                <h3 class="subject-title" x-text="subjectName"></h3>
      
                <div class="subject-courses">
                  <template x-for="course in courseGroup" :key="course.recordID || course.id">
                    <article class="course-card" :style="`border-color: ${subjectColor(course.subject)}`">
                      <!-- Title row with bookmark (for topic-less courses) + chevron -->
                      <div class="card-header">
                        <div class="title-with-edit">
                          <h4 class="course-title" x-text="course.course_title || course.title || course.Course || 'Untitled course'"></h4>
                        
                          <a
                            class="edit-pill"
                            x-show="isStaff && editMode && course.Edit_CourseListURL"
                            x-cloak
                            :href="course.Edit_CourseListURL"
                            target="_blank"
                            rel="noopener"
                            @click.stop
                          >Edit ↗</a>
                        </div>
                      
                        <div class="card-header-actions">
                          <!-- Course notes (only for courses with NO topics) -->
                          <template x-if="!course.topics || course.topics.length === 0">
                              <button
                                type="button"
                                class="note-btn"
                                :class="{
                                  'note-btn--empty': !hasCourseNote(course),
                                  'note-btn--soft':  hasCourseNote(course) && !isCourseBookmarked(course),
                                  'note-btn--strong': hasCourseNote(course) && isCourseBookmarked(course),
                                }"
                                :style="hasCourseNote(course) && isCourseBookmarked(course)
                                  ? {
                                      backgroundColor: subjectColor(course.subject) + '4D',
                                      borderColor: subjectColor(course.subject),
                                      color: subjectColor(course.subject),
                                    }
                                  : {}"
                                @click.stop="toggleCourseNoteOpen(course)"
                                aria-label="Toggle course notes"
                              >
                              <!-- pencil icon -->
                              <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                  d="M4 17.5V20h2.5L17 9.5 14.5 7 4 17.5z"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                                <path
                                  d="M15.5 5.5L18 8"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                              </svg>
                            </button>
                          </template>
                          <!-- Course bookmark only when there are NO topics -->
                          <template x-if="!course.topics || course.topics.length === 0">
                            <span class="bookmark-region">
                              <!-- Bookmarked here (solid, subject-colored) -->
                              <template x-if="isCourseBookmarked(course)">
                                <button
                                  type="button"
                                  class="bookmark-btn bookmark-btn--solid"
                                  :style="{ backgroundColor: subjectColor(course.subject) }"
                                  @click.stop="toggleCourseBookmark(course)"
                                  aria-label="Remove from My courses"
                                >
                                  <img src="img/icons/bookmark-active.svg" alt="" class="bookmark-icon" />
                                </button>
                              </template>
                              
                              <!-- Empty bookmark (not yet in My courses) -->
                              <template x-if="!isCourseBookmarked(course)">
                                <button
                                  type="button"
                                  class="bookmark-btn bookmark-btn--empty"
                                  @click.stop="toggleCourseBookmark(course)"
                                  aria-label="Add course to My courses"
                                >
                                  <img src="img/icons/bookmark-muted.svg" alt="" class="bookmark-icon" />
                                  <span class="bookmark-apply">+</span>
                                </button>
                              </template>
                            </span>
                          </template>

                          <!-- Quickmark: bookmark all topics in this course -->
                          <template x-if="course.topics && course.topics.length">
                            <div class="quick-enroll-wrapper">
                              
                              <!-- BUTTON -->
                              <button
                                type="button"
                                class="quick-enroll-btn"
                                :class="allTopicsBookmarked(course) ? 'quick-enroll-btn--active' : ''"
                                :style="allTopicsBookmarked(course)
                                  ? {
                                      backgroundColor: subjectColor(course.subject) + '4D',
                                      borderColor: subjectColor(course.subject),
                                      color: subjectColor(course.subject),
                                    }
                                  : {}"
                                @click.stop="toggleAllTopicsBookmark(course)"
                                aria-label="Enroll all topics in this course"
                              >
                                <!-- bookmark icon -->
                                <img
                                  :src="allTopicsBookmarked(course)
                                    ? 'img/icons/bookmark-active.svg'
                                    : 'img/icons/bookmark-muted.svg'"
                                  alt=""
                                  class="bookmark-icon"
                                />
                          
                                <!-- unselected chip -->
                                <template x-if="!allTopicsBookmarked(course)">
                                  <span class="quick-chip">+</span>
                                </template>
                              </button>
                          
                              <!-- LABEL BELOW BUTTON -->
                              <div
                                class="quick-enroll-label"
                                :class="allTopicsBookmarked(course) ? 'quick-enroll-label--active' : ''"
                                :style="allTopicsBookmarked(course)
                                  ? { backgroundColor: subjectColor(course.subject) }
                                  : {}"
                              >
                                <span x-text="allTopicsBookmarked(course) ? 'All' : '+All'"></span>
                              </div>
                          
                            </div>
                          </template>
                        
                          <!-- Chevron only if description or tips exist -->
                          <template x-if="(course.description && course.description.trim()) || (course.tips && course.tips.trim())">
                            <button
                              type="button"
                              class="card-toggle"
                              :class="course.detailsOpen ? '' : 'card-toggle--closed'"
                              @click="course.detailsOpen = !course.detailsOpen"
                              aria-label="Toggle course details"
                            >
                              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path
                                  d="M6 9l6 6 6-6"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.8"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                              </svg>
                            </button>
                          </template>
                        </div>
                      </div>
                    
                      <!-- grade + schedule line -->
                      <p
                        class="course-meta"
                        x-show="course.gradeText || course.schedText"
                      >
                        <!-- left: schedule (if any) -->
                        <template x-if="course.schedText">
                          <span
                            class="meta-schedule"
                            :class="course.gradeText ? 'meta-schedule--with-grade' : 'meta-schedule--solo'"
                            x-text="course.schedText"
                          ></span>
                        </template>
                      
                        <!-- middle: grade (if any) -->
                        <template x-if="course.gradeText">
                          <span
                            :class="course.schedText ? 'meta-grade meta-grade--with-sched' : 'meta-grade meta-grade--solo'"
                            x-text="course.gradeText"
                          ></span>
                        </template>
                      
                        <!-- spacer pushes planning tag area to far right -->
                        <span class="meta-flex-spacer"></span>

                        <!-- right: planning tag UI (courses *without* topics only) -->
                        <template x-if="!course.topics || course.topics.length === 0">
                          <span class="planning-tag-region">
                            <!-- If no tags yet: show "+ Planning tag" button -->
                            <template x-if="!course.planningTags || course.planningTags.length === 0">
                              <button
                                type="button"
                                class="planning-tag-button"
                                aria-label="Add planning tag to course"
                                @click.stop="openPlanningMenu($event, course)"
                              >
                                <span class="planning-tag-label">+ Planning tag</span>
                              </button>
                            </template>

                            <!-- If tags exist: show images + small "+" square -->
                            <template x-if="course.planningTags && course.planningTags.length > 0">
                              <div class="planning-tag-selected-row">
                                <template x-for="tag in course.planningTags" :key="tag.id">
                                  <div class="planning-tag-pill">
                                    <img
                                      class="planning-tag-img"
                                      :src="tag.img"
                                      :alt="tag.label"
                                    />
                                    <button
                                      type="button"
                                      class="planning-tag-remove"
                                      @click.stop="removePlanningTag(course, tag.id)"
                                      aria-label="Remove planning tag"
                                    >
                                      ×
                                    </button>
                                  </div>
                                </template>

                                <button
                                  type="button"
                                  class="planning-tag-add"
                                  aria-label="Add more planning tags"
                                  @click.stop="openPlanningMenu($event, course)"
                                >
                                  +
                                </button>
                              </div>
                            </template>
                          </span>
                        </template>
                      </p>
                    
                      <!-- Description + combining tips -->
                      <div
                        class="course-detail-row"
                        x-show="showAllDetails
                                && course.detailsOpen
                                && ((course.description && course.description.trim())
                                    || (course.tips && course.tips.trim()))"
                        x-transition
                      >
                        <div
                          class="course-detail-description"
                          x-show="course.description && course.description.trim().length > 0"
                          x-text="course.description"
                        ></div>
                        
                        <div
                          class="course-detail-tips"
                          x-show="course.tips && course.tips.trim().length > 0"
                        >
                          <span class="course-detail-tips-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24">
                              <circle cx="9" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="1.7"/>
                              <circle cx="15" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="1.7"/>
                            </svg>
                          </span>
                          <span x-text="course.tips"></span>
                        </div>

                      </div>
      
                      <!-- Nested topics (titles only for now) -->
                      <div class="topic-list" x-show="visibleTopicsForCourse(course).length">
                        <template x-for="topic in visibleTopicsForCourse(course)" :key="topic.recordID">
                          <article class="topic-card">
                            <!-- Title row with chevron -->
                            <div class="card-header">
                              <div class="title-with-edit">
                                <h5 class="topic-title" x-text="topic.Topic"></h5>
                              
                                <a
                                  class="edit-pill"
                                  x-show="isStaff && editMode && topic.Edit_CourseListURL"
                                  x-cloak
                                  :href="topic.Edit_CourseListURL"
                                  target="_blank"
                                  rel="noopener"
                                  @click.stop
                                >Edit ↗</a>
                              </div>
                            
                              <div class="card-header-actions">
                                <!-- Topic notes button -->
                                <button
                                    type="button"
                                    class="note-btn"
                                    :class="{
                                      'note-btn--empty': !hasTopicNote(topic),
                                      'note-btn--soft':  hasTopicNote(topic) && !isTopicBookmarked(topic),
                                      'note-btn--strong': hasTopicNote(topic) && isTopicBookmarked(topic),
                                    }"
                                    :style="hasTopicNote(topic) && isTopicBookmarked(topic)
                                      ? {
                                          backgroundColor: subjectColor(course.subject) + '4D',
                                          borderColor: subjectColor(course.subject),
                                          color: subjectColor(course.subject),
                                        }
                                      : {}"
                                    @click.stop="toggleTopicNoteOpen(topic)"
                                    aria-label="Toggle topic notes"
                                  >
                                  <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path
                                      d="M4 17.5V20h2.5L17 9.5 14.5 7 4 17.5z"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.6"
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                    />
                                    <path
                                      d="M15.5 5.5L18 8"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.6"
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                    />
                                  </svg>
                                </button>
                                <!-- topic bookmark (My courses) -->
                                <span class="bookmark-region">
                                  <!-- Bookmarked here (solid, subject-colored) -->
                                  <template x-if="isTopicBookmarked(topic)">
                                    <button
                                      type="button"
                                      class="bookmark-btn bookmark-btn--solid"
                                      :style="{ backgroundColor: subjectColor(course.subject) }"
                                      @click.stop="toggleTopicBookmark(topic)"
                                      aria-label="Remove from My courses"
                                    >
                                      <img src="img/icons/bookmark-active.svg" alt="" class="bookmark-icon" />
                                    </button>
                                  </template>
                            
                                  <!-- Ghost bookmark (bookmarked in another course, not here) -->
                                  <template x-if="!isTopicBookmarked(topic) && topicBookmarkedElsewhere(topic)">
                                    <button
                                      type="button"
                                      class="bookmark-btn bookmark-btn--ghost"
                                      :style="{ backgroundColor: subjectColor(course.subject) }"
                                      @click.stop="applyBookmarkFromElsewhere(topic)"
                                      aria-label="Add this topic to My courses here"
                                    >
                                      <svg viewBox="0 0 24 24" aria-hidden="true" class="bookmark-icon">
                                        <path
                                          d="M8 5h8a1 1 0 0 1 1 1v13l-5-2.5L7 19V6a1 1 0 0 1 1-1z"
                                          fill="currentColor"
                                          stroke="currentColor"
                                          stroke-width="1.4"
                                          stroke-linejoin="round"
                                        />
                                      </svg>
                                      <span class="bookmark-apply">+</span>
                                    </button>
                                  </template>
                            
                                  <!-- Empty bookmark (nowhere yet) -->
                                  <template x-if="!isTopicBookmarked(topic) && !topicBookmarkedElsewhere(topic)">
                                    <button
                                      type="button"
                                      class="bookmark-btn bookmark-btn--empty"
                                      @click.stop="toggleTopicBookmark(topic)"
                                      aria-label="Add to My courses"
                                    >
                                      <img src="img/icons/bookmark-muted.svg" alt="" class="bookmark-icon" />
                                       <span class="bookmark-apply">+</span>
                                    </button>
                                  </template>
                                </span>
                            
                                <!-- Chevron only if description or tips exist -->
                                <template x-if="(topic.description && topic.description.trim()) || (topic.tips && topic.tips.trim())">
                                  <button
                                    type="button"
                                    class="card-toggle"
                                    :class="topic.detailsOpen ? '' : 'card-toggle--closed'"
                                    @click="topic.detailsOpen = !topic.detailsOpen"
                                    aria-label="Toggle topic details"
                                  >
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                      <path
                                        d="M6 9l6 6 6-6"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.8"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                      />
                                    </svg>
                                  </button>
                                </template>
                              </div>
                            </div>
                          
                              <p
                                class="course-meta topic-meta"
                                x-show="topic.gradeText || topic.schedText"
                              >
                                <!-- left: schedule -->
                                <template x-if="topic.schedText">
                                  <span
                                    class="meta-schedule"
                                    :class="topic.gradeText ? 'meta-schedule--with-grade' : 'meta-schedule--solo'"
                                    x-text="topic.schedText"
                                  ></span>
                                </template>
                              
                                <!-- middle: grade -->
                                <template x-if="topic.gradeText">
                                  <span
                                    :class="topic.schedText ? 'meta-grade meta-grade--with-sched' : 'meta-grade meta-grade--solo'"
                                    x-text="topic.gradeText"
                                  ></span>
                                </template>
                              
                                <!-- spacer pushes controls to the right -->
                                <span class="meta-flex-spacer"></span>
                              
                                <!-- right: planning tag UI (topics always can have tags) -->
                                <span class="planning-tag-region">
                                  <!-- No tags yet -->
                                  <template x-if="!topic.planningTags || topic.planningTags.length === 0">
                                    <button
                                      type="button"
                                      class="planning-tag-button"
                                      aria-label="Add planning tag to topic"
                                      @click.stop="openPlanningMenu($event, topic)"
                                    >
                                      <span class="planning-tag-label">+ Planning tag</span>
                                    </button>
                                  </template>
                              
                                  <!-- Tags selected -->
                                  <template x-if="topic.planningTags && topic.planningTags.length > 0">
                                    <div class="planning-tag-selected-row">
                                      <template x-for="tag in topic.planningTags" :key="tag.id">
                                        <div class="planning-tag-pill">
                                          <img
                                            class="planning-tag-img"
                                            :src="tag.img"
                                            :alt="tag.label"
                                          />
                                          <button
                                            type="button"
                                            class="planning-tag-remove"
                                            @click.stop="removePlanningTag(topic, tag.id)"
                                            aria-label="Remove planning tag"
                                          >
                                            ×
                                          </button>
                                        </div>
                                      </template>
                              
                                      <button
                                        type="button"
                                        class="planning-tag-add"
                                        aria-label="Add more planning tags"
                                        @click.stop="openPlanningMenu($event, topic)"
                                      >
                                        +
                                      </button>
                                    </div>
                                  </template>
                              
                                  <!-- Ghost tags from previous use of this topic elsewhere -->
                                  <template x-if="missingGlobalTagsForTopic(topic).length > 0">
                                    <div class="planning-tag-selected-row">
                                      <template
                                        x-for="tagId in missingGlobalTagsForTopic(topic)"
                                        :key="'ghost-' + tagId"
                                      >
                                        <div class="planning-tag-pill">
                                          <img
                                            class="planning-tag-img planning-tag-img-ghost"
                                            :src="planningTagImage(tagId)"
                                            :alt="planningTagLabel(tagId)"
                                          />
                                          <button
                                            type="button"
                                            class="planning-tag-apply"
                                            @click.stop="applyGlobalTagToTopic(topic, tagId)"
                                            :aria-label="`Apply ${planningTagLabel(tagId)} here`"
                                            title="Add previous tag"
                                          >
                                            +
                                          </button>
                                        </div>
                                      </template>
                                    </div>
                                  </template>
                                </span>
                              </p>

                            <div
                              class="course-detail-row"
                              x-show="showAllDetails
                                  && topic.detailsOpen
                                  && ((topic.description && topic.description.trim())
                                  || (topic.tips && topic.tips.trim()))"

                              x-transition
                            >
                              <div
                                class="course-detail-description"
                                x-show="topic.description && topic.description.trim()"
                                x-text="topic.description"
                              ></div>
                          
                              <div
                                class="course-detail-tips"
                                x-show="topic.tips && topic.tips.trim()"
                              >
                                <span class="course-detail-tips-icon" aria-hidden="true">
                                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle
                                      cx="9"
                                      cy="12"
                                      r="4"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.7"
                                    />
                                    <circle
                                      cx="15"
                                      cy="12"
                                      r="4"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.7"
                                    />
                                  </svg>
                                </span>
                                <span x-text="topic.tips"></span>
                              </div>
                            </div>
                            <!-- Topic notes panel -->
                            <div
                              class="note-panel"
                              x-show="topic.noteOpen"
                              x-transition
                              :style="{ backgroundColor: subjectColor(course.subject) + '4D' }"
                            >
                              <label class="note-label">Notes</label>
                              <textarea
                                class="note-textarea"
                                placeholder="Add notes for this topic..."
                                :value="topicNoteText(topic)"
                                @input="updateTopicNoteText(topic, $event.target.value)"
                                :style="{ backgroundColor: subjectColor(course.subject) + '1A' }"
                              ></textarea>
                            </div>
                            <!-- Student rail toggle (topic) -->
                            <div class="student-rail-toggle-row">
                              <button
                                type="button"
                                class="student-rail-toggle"
                                :aria-expanded="!isStudentRailCollapsed(studentRailKeyForTopic(topic))"
                                @click.stop="toggleStudentRailCollapsed(studentRailKeyForTopic(topic))"
                                aria-label="Toggle student assignments"
                              >
                                <!-- solid filled person icon -->
                                <svg class="student-rail-icon" viewBox="0 0 24 24" aria-hidden="true">
                                  <circle cx="12" cy="8" r="3.2" fill="currentColor"></circle>
                                  <path
                                    d="M4.5 20c0-3.9 3.7-6.8 7.5-6.8s7.5 2.9 7.5 6.8"
                                    fill="currentColor">
                                  </path>
                                </svg>
                            
                                <!-- chevron / wedge -->
                                <svg class="student-rail-wedge" viewBox="0 0 24 24" aria-hidden="true">
                                  <path
                                    d="M7 10l5 5 5-5"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round">
                                  </path>
                                </svg>
                              </button>
                            
                              <!-- Add-students "+" (shows only when rail is OPEN) -->
                              <template x-if="!isStudentRailCollapsed(studentRailKeyForCourse(course))">
                                <button
                                  type="button"
                                  class="planning-tag-add"
                                  aria-label="Assign students"
                                  @click.stop="openStudentAssignMenu($event, course)"
                                >+</button>
                              </template>
                            </div>
                          </article>

                        </template>
                      </div>

                      <!-- Course notes panel (topic-less courses only) -->
                      <template x-if="!course.topics || course.topics.length === 0">
                        <div
                          class="note-panel"
                          x-show="course.noteOpen"
                          x-transition
                          :style="{ backgroundColor: subjectColor(course.subject) + '4D' }"
                        >
                          <label class="note-label">Notes</label>
                          <textarea
                            class="note-textarea"
                            placeholder="Add notes for this course..."
                            :value="courseNoteText(course)"
                            @input="updateCourseNoteText(course, $event.target.value)"
                            :style="{ backgroundColor: subjectColor(course.subject) + '1A' }"
                          ></textarea>
                        </div>
                      </template>

                      <template x-if="!course.topics || course.topics.length === 0">
                      <!-- Student rail toggle (course - only when no topics) -->
                      <div class="student-rail-toggle-row">
                        <button
                          type="button"
                          class="student-rail-toggle"
                          :aria-expanded="!isStudentRailCollapsed(studentRailKeyForCourse(course))"
                          @click.stop="toggleStudentRailCollapsed(studentRailKeyForCourse(course))"
                          aria-label="Toggle student assignments"
                        >
                          <!-- solid filled person icon -->
                          <svg class="student-rail-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="12" cy="8" r="3.2" fill="currentColor"></circle>
                            <path
                              d="M4.5 20c0-3.9 3.7-6.8 7.5-6.8s7.5 2.9 7.5 6.8"
                              fill="currentColor">
                            </path>
                          </svg>
                    
                          <!-- chevron / wedge -->
                          <svg class="student-rail-wedge" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                              d="M7 10l5 5 5-5"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round">
                            </path>
                          </svg>
                        </button>
                    
                        <!-- Add-students "+" (shows only when rail is OPEN) -->
                        <template x-if="!isStudentRailCollapsed(studentRailKeyForTopic(topic))">
                          <button
                            type="button"
                            class="planning-tag-add"
                            aria-label="Assign students"
                            @click.stop="openStudentAssignMenu($event, topic)"
                          >+</button>
                        </template>
                      </div>
                    </template>
                      
                    </article>
                  </template>
                </div>
              </section>
              
            </template>
          </div>
        </template>
      </div>

      <!-- Global planning-tag menu (modal-style, for both courses & topics) -->
      <div
        x-show="planningMenuOpen"
        x-transition
        x-cloak
        class="fixed inset-0 z-50"
      >
        <!-- click-away backdrop -->
        <div class="absolute inset-0" @click="closePlanningMenu()"></div>

        <!-- floating menu positioned near the clicked button -->
        <div
          class="planning-tag-menu fixed"
          :style="`top:${planningMenuY}px; left:${planningMenuX}px;`"
          @click.stop
        >
          <template x-for="opt in planningTagOptions" :key="opt.id">
            <button
              type="button"
              class="planning-tag-option"
              @click="togglePlanningTag(planningMenuItem, opt)"
            >
              <span class="planning-tag-option-main">
                <img :src="opt.img" :alt="opt.label" />
                <span x-text="opt.label"></span>
              </span>
              <span
                class="filter-dropdown-check"
                x-show="
                  planningMenuItem &&
                  planningMenuItem.planningTags &&
                  planningMenuItem.planningTags.some(t => t.id === opt.id)
                "
              >
                ✓
              </span>
            </button>
          </template>
        </div>
      </div>

      <!-- Global student-assign menu (modal-style, for both courses & topics) -->
      <div
        x-show="studentAssignMenuOpen"
        x-transition
        x-cloak
        class="fixed inset-0 z-50"
      >
        <!-- click-away backdrop -->
        <div class="absolute inset-0" @click="closeStudentAssignMenu()"></div>
      
        <!-- floating menu positioned near the clicked button -->
        <div
          class="planning-tag-menu fixed"
          :style="`top:${studentAssignMenuY}px; left:${studentAssignMenuX}px;`"
          @click.stop
        >
          <template x-for="s in students" :key="s.id">
            <button
              type="button"
              class="planning-tag-option"
              @click="closeStudentAssignMenu()"
            >
              <span class="planning-tag-option-main">
                <span
                  aria-hidden="true"
                  style="width:12px;height:12px;border-radius:999px;display:inline-block;"
                  :style="`background-color: ${s.color};`"
                ></span>
                <span x-text="s.name"></span>
              </span>
            </button>
          </template>
        </div>
      </div>
  
    </section>

  </main>

  <!-- Print Tip Modal (screen-only) -->
  <div
    x-show="printTipOpen"
    x-cloak
    class="print-tip-overlay"
    @keydown.escape.window="closePrintTip()"
  >
    <div class="print-tip-backdrop" @click="closePrintTip()"></div>
  
    <div class="print-tip-modal" role="dialog" aria-modal="true" aria-label="Print tips" @click.stop>
      <div class="print-tip-title">Best print settings</div>
  
      <div class="print-tip-body">
        <p><strong>For the cleanest print/PDF:</strong></p>
        <ul>
          <li>Set <strong>Margins</strong> to <strong>Custom: 0.5"</strong> on all sides</li>
          <li>Turn <strong>Headers and footers</strong> <strong>OFF</strong></li>
        </ul>
      </div>
  
      <label class="print-tip-checkbox">
        <input type="checkbox" x-model="printTipDontShowAgain" />
        Don’t show this again
      </label>
  
      <div class="print-tip-actions">
        <button type="button" class="print-tip-btn" @click="closePrintTip()">Cancel</button>
        <button type="button" class="print-tip-btn print-tip-btn-primary" @click="confirmPrintTipAndPrint()">
          Continue to Print
        </button>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  
  <!-- Authentication Bootstrapping (wrap the global coursePlanner() function) -->
  <script type="module">
    import { getCurrentUser } from "./js/auth.js";
  
    const originalCoursePlanner = window.coursePlanner;
  
    window.coursePlanner = function () {
      const original = originalCoursePlanner();
      const originalInit = original.init;
  
      return {
        ...original,
  
        user: { role: "anonymous" },
  
        get isStaff()  { return this.user?.role === "staff"; },
        get isMember() { return this.user?.role === "member"; },
        get isAnon()   { return !this.user?.role || this.user.role === "anonymous"; },
  
        async init() {
          this.user = await getCurrentUser();
        
          // ✅ DEV OVERRIDE (temporary): force staff when a local flag is set
          try {
            const devStaff = localStorage.getItem("ALVEARY_DEV_STAFF") === "1";
            if (devStaff) this.user = { role: "staff" };
          } catch (e) {}
        
          if (typeof originalInit === "function") {
            await originalInit.call(this);
          }
        },
      };
    };
  </script>

  <!-- ✅ Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Print-only page numbers (Paged.js loads only when printing) -->
  <script>
    // Tell Paged.js: do NOT auto-run on page load
    window.PagedConfig = { auto: false };
  
    function loadPagedJsOnce() {
      return new Promise((resolve, reject) => {
        if (window.PagedPolyfill) return resolve();
        const s = document.createElement("script");
        s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Paged.js"));
        document.head.appendChild(s);
      });
    }
  
      // Print with real page numbers WITHOUT breaking the live app
      function stripScripts(docEl) {
        docEl.querySelectorAll("script").forEach(s => s.remove());
      }
    
      function closeOpenUi(alpineRoot) {
        // optional: close the left Planning Tag menu if it’s open
        // (only runs if Alpine variables exist)
        try {
          const data = window.Alpine && window.Alpine.$data ? window.Alpine.$data(alpineRoot) : null;
          if (data) {
            data.gradeDropdownOpen = false;
            data.subjectDropdownOpen = false;
            data.tagDropdownOpen = false;
            data.planningMenuOpen = false;
          }
        } catch (e) {}
      }
    
      async function loadPagedInto(win) {
        return new Promise((resolve, reject) => {
          const s = win.document.createElement("script");
          s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
          s.onload = resolve;
          s.onerror = () => reject(new Error("Failed to load Paged.js"));
          win.document.head.appendChild(s);
        });
      }
    
      window.alvearyPrintWithPaged = async function () {
        // 1) Ensure dropdowns/menus close in the LIVE UI before snapshot
        const root = document.querySelector("[x-data]");
        if (root) closeOpenUi(root);
    
        // Let Alpine finish DOM updates
        await new Promise(r => setTimeout(r, 50));
    
        // 2) Clone the current, already-rendered DOM
        const cloned = document.documentElement.cloneNode(true);
    
        // 3) Remove scripts so the print window doesn’t re-run the whole app
        stripScripts(cloned);
    
        // 4) Open a dedicated print window with the snapshot HTML
        const w = window.open("", "_blank", "noopener,noreferrer");
        if (!w) {
          // popup blocked → fall back
          window.print();
          return;
        }
    
        w.document.open();
        w.document.write("<!doctype html>" + cloned.outerHTML);
        w.document.close();
    
        // 5) In the print window, load Paged.js and print
        try {
          // Prevent auto-run
          w.PagedConfig = { auto: false };
    
          await loadPagedInto(w);
    
          // Wait a beat for styles/fonts
          await new Promise(r => setTimeout(r, 100));
    
          await w.PagedPolyfill.preview();
          w.focus();
          w.print();
    
          // Close the print window after printing
          w.addEventListener("afterprint", () => {
            try { w.close(); } catch (e) {}
          });
        } catch (e) {
          console.warn(e);
          w.focus();
          w.print();
          w.addEventListener("afterprint", () => {
            try { w.close(); } catch (e) {}
          });
        }
      };
  
  </script>
  
</body>
</html>
