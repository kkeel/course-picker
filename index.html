<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary Course Planning</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Crimson+Text:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --brand-bg:#fbfbf9; --brand-ink:#262b26;
      --green-dark:#596e5e; --gray-soft:#f4f6fa;
      --band-green:#596e5e; --check-green:#9da89f;
    }
    *{-webkit-print-color-adjust:exact !important; print-color-adjust:exact !important;}
    body{ background:var(--brand-bg); color:var(--brand-ink); font-family:'DM Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    
    /* Title Style */
    .title{ color:var(--green-dark); font-weight:700; font-size:34px; }
    @media (max-width: 480px){
      .welcome-inline p { margin-top: .25rem; }
    }

    /* Guide Headings + icons row */
    .guidance-head { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .guidance-head { align-items: center; }
    .guidance-head img { height: 3.25rem; width: 3.25rem; }
    .guidance-head h3 { font-size: 1.35rem; font-weight: 700; color: var(--green-dark); }

    /* Guide Body copy indentation */
    .guidance-copy { font-size: 0.96rem; line-height: 1.55; color: #2f3a33; margin-left: 2.9rem; }
    .guidance-copy p { margin: 0 0 0.6rem 0; }
    .guidance-copy ul { margin-left: 1.25rem; margin-top: 0.25rem; margin-bottom: 0.75rem; }
    .guidance-copy ul li { margin-bottom: 0.25rem; padding-left: 0.25rem; }    
    
    /* Optional: slightly thicker divider to match new scale */
    .divider-green { border-top: 1.5px solid var(--green-dark); margin-top: 1.1rem; padding-top: 1.1rem; }

    /* subtle highlight for the welcome info section */
    .intro-card{
      background:#fff;
      border:1px solid #e7ebe8;                       /* very faint border */
      box-shadow:0 2px 8px rgba(0,0,0,.05);           /* soft shadow */
      border-radius:1rem;
      padding:1rem 1.25rem;
    }
    @media (min-width: 640px){
      .intro-card{ padding:1.25rem 1.5rem; }
    }
    /* compact schedule block on the left */
      .schedule-col { font-size: 0.85rem; line-height: 1.35; color:#2f3a33; }
      .schedule-col .label { font-size:.72rem; letter-spacing:.06em; text-transform:uppercase; color:#6b7a71; margin-bottom:.25rem; display:block; }
      @media (min-width: 640px){
        .schedule-col { padding-right:.25rem; }
      }
    
    /* legend + helper text under filters */
    .legend img{ width:18px; height:18px; border-radius:999px; }
    .legend li{ display:flex; align-items:center; gap:.4rem; }

    /* Full-width sticky subject bar — no box, just page bg + subtle blur */
    .subject-bar{
      position: sticky;
      top: 64px;                 /* match your top sticky actions height */
      z-index: 20;
      background: rgba(250,251,250,.92);  /* same feel as page bg */
      -webkit-backdrop-filter: saturate(180%) blur(8px);
      backdrop-filter: saturate(180%) blur(8px);
      border: 0;                 /* no border box */
      box-shadow: none;          /* kill the boxed look */
      padding-top: .55rem;
      padding-bottom: .35rem;
      border-bottom: 6px solid var(--subject-color, #dfe4df); /* full-width underline */
      margin-bottom: .75rem;
    }
    
    /* Inner row: big, elegant title */
    .subject-inner{
      display:flex; align-items:center; gap:.5rem;
      color:#262b26;
      font-family:"Crimson Text", serif;
      font-weight:700;
      font-size:1.5rem; line-height:1.1;
    }
    @media (min-width:768px){ .subject-inner{ font-size:1.75rem; } }
    
    /* Small subject color dot */
    .subject-dot{
      width:14px; height:14px; border-radius:999px;
      background:var(--subject-color, #dfe4df);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.08);
    }
    
    /* Mobile sticky offset */
    @media (max-width:640px){ .subject-bar{ top:56px; } }

    /* One row = color rail + card */
    .course-row{ display:flex; align-items:stretch; gap:12px; width:100%; }
    
    /* Thin subject rail, independent of the card */
    .subject-rail{
      width:5px; border-radius:10px;
      background: var(--subject-color, #dfe4df);
      flex: none;
    }
    
    /* Course Style */
    .course-card { flex: 1 1 auto; min-width: 0; border-radius: 1rem; overflow: visible; background: #fff; }
    .course-band { background: var(--band-green); color: #fff; border-top-left-radius: 1rem; border-top-right-radius: 1rem; overflow: visible; }
    .band-title{ font-family: "Crimson Text", serif; font-size: 1.05rem; line-height: 1.15; }
    .band-title button {margin-left: 0.25rem; transition: background 0.15s ease, transform 0.1s ease; }
    .band-title button:hover {transform: translateY(-1px); }
    .desc-bg{ background:var(--gray-soft); }
    input[type="checkbox"]{ accent-color: var(--check-green); }
    
      /* COURSE pills: outline + large icon */
      .pill{
        /* outline look */
        background: transparent;              /* no fill by default */
        border: 2px solid #bfc4b4;            /* subtle outline */
        border-radius: 999px;
        padding: 2px;                          /* just enough for the ring */
        display: inline-flex; align-items: center; justify-content: center;
        cursor: pointer; transition: transform .1s ease, background-color .15s ease, border-color .15s ease;
      }
      .pill:hover{ transform: translateY(-1px); }
      .pill.active{
        background: #bec5a6;                  /* selected highlight */
        border-color: #aeb49a;
      }
      
      /* big course pill image */
      .pill .icon{
        width: 28px;   /* ← bump this if you want even larger */
        height: 28px;
        border-radius: 999px;
        display: block;
      }
      
      /* hide any residual label span inside pills */
      .pill .tiny{ display: none !important; }

      .icon { width:18px; height:18px; border-radius:999px; display:block; }
      .badge { width:18px; height:18px; border-radius:999px; display:block; margin-left:.35rem; }
      .tiny{ font-size:11px; opacity:.85; }
      dialog::backdrop{ background:rgba(0,0,0,.25); }
      @media print{
        .no-print{ display:none !important; }
        .badge { width:16px; height:16px; }
      }
    
      /* Accordion "tray" */
      .accordion{
        background: var(--gray-soft);      /* #f4f6fa */
        border-top: 1px solid #e5e7eb;
        padding: 14px 16px;
      }
      .acc-section + .acc-section {       /* divider between note and info when both are open */
        border-top: 1px solid #e5e7eb;
        margin-top: 12px;
        padding-top: 12px;
      }
      .acc-info{
        background:#fff;
        border-top: 1px solid #e5e7eb;     /* separation line above */
        padding: 16px;
      }
      
      /* inline note area */
      .note-area{ padding:0; background:transparent; border:0; }
      .note-area textarea{
        width:100%; border:1px solid #d9ded9; border-radius:.5rem;
        min-height:72px; padding:.5rem .6rem; font-size:.9rem; background:#fff;
      }
    
    /* Topics */
    .topics-list { font-size: 0.92rem; margin-left: 1.75rem;  /* slight indent from course */ }
    .topics-list .font-medium { font-family: "DM Sans", sans-serif; }
    .topics-list span { line-height: 1.3; }
    .topics-list label span { line-height:1.3; }

    /* Topic row layout */
    .topic-row{ display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; padding:.25rem .25rem; }
    .topic-left{ display:flex; gap:.5rem; align-items:flex-start; }
    .topic-title{ font-weight:600; font-size:.95rem; line-height:1.2; }
    .topic-schedule{ font-size:.78rem; color:#647067; line-height:1.2; margin-top:.15rem; }
    
    /* Mini icon buttons beside topic title */
    .topic-icon{
      background:#dee1d2;          /* requested unclicked color */
      padding:.25rem .4rem;
      border-radius:.45rem;
      font-size:.75rem;
      line-height:1;
    }
    .topic-icon[aria-expanded="true"]{ background:#bec5a6; } /* active color */
    .topic-icon:hover{ filter:brightness(.97); }
    
    /* Right-side topic planning pills */
        .topic-pill{
      background: transparent;
      border: 2px solid #bfc4b4;
      border-radius: 999px;
      padding: 2px;
      display: inline-flex; align-items:center; justify-content:center;
      cursor: pointer; transition: transform .1s ease, background-color .15s ease, border-color .15s ease;
    }
    .topic-pill:hover{ transform: translateY(-1px); }
    .topic-pill.active{
      background:#bec5a6;
      border-color:#aeb49a;
    }
    
    /* big topic pill image */
    .topic-pill img{ width: 28px; height: 28px; border-radius:999px; display:block; }
    
    /* remove topic pill text if any slipped through */
    .topic-pill .tiny{ display:none !important; }
    
    /* Visual helper connecting pills to their topic */
    .topic-icons{
      display:flex; align-items:center; gap:.35rem;
      padding-left:.5rem; margin-left:.5rem;
      border-left:1px dashed #bec5a6;  /* subtle guide */
    }

    /* --- Keep topic plan button using gray variant --- */
    .topic-icons .plan-trigger {
      background: #dee1d2;
      color: #2a312b;
    }
    .topic-icons .plan-trigger[aria-expanded="true"],
    .topic-icons .plan-trigger:hover {
      background: #bec5a6;
    }
    
    /* Topic accordions (full width within topics area) */
    .topic-acc-note{ background:#f4f6fa; border-top:1px solid #e5e7eb; padding:12px 12px; border-radius:.5rem; }
    .topic-acc-info{ background:#fff;    border-top:1px solid #e5e7eb; padding:12px 12px; border-radius:.5rem; }
    
    .topic-note-area textarea{
      width:100%; border:1px solid #d9ded9; border-radius:.5rem;
      min-height:64px; padding:.45rem .55rem; font-size:.88rem; background:#fff;
    }

    /* Plan trigger – match topic-icon sizing/colors */
    .plan-trigger{
      background:#dee1d2;
      padding:.25rem .45rem;
      border-radius:.45rem;
      font-size:.8rem; line-height:1; color:#2a312b;
      border:0; display:inline-flex; align-items:center; gap:.35rem;
    }
    .plan-trigger:hover{ background:#eef2ee; }
    .plan-trigger[aria-expanded="true"]{ background:#bec5a6; }
    /* keep the tiny check icon small */
    .plan-trigger svg{ width:14px; height:14px; }
    
    /* COURSE-ONLY style — same palette/size as your i/✏️ badges */
    .course-plan-trigger {
      background: #ffffff1f !important;   /* same translucent white as i/pencil */
      border: none !important;
      border-radius: .45rem !important;
      padding: .25rem .45rem !important;
      font-size: .8rem !important;
      line-height: 1 !important;
      color: #fff !important;
    }
    .course-plan-trigger:hover,
    .course-plan-trigger[aria-expanded="true"] {
      background: #ffffff33 !important;
    }

    .plan-anchor{ position: relative; }
    
    /* Popover menu */
    .plan-menu{
      position:absolute; right:0; top:calc(100% + .35rem); z-index:100; /* higher */
      background:#fff; border:1px solid #e5e7eb; border-radius:.6rem;
      box-shadow:0 8px 24px rgba(0,0,0,.08); padding:.4rem; width:240px;
      color:#2a312b;   /* ensure dark text */
    }
    .plan-opt span{ color:#2a312b; font-size:.9rem; }
    .plan-opt{
      display:flex; align-items:center; gap:.5rem;
      padding:.45rem .5rem; border-radius:.5rem; cursor:pointer;
    }
    .plan-opt:hover{ background:#f7f9f7; }
    .plan-opt img{ width:18px; height:18px; border-radius:999px; }
    
    /* Selected preview chips (image-only with outline like you wanted) */
    .tag-chip{
      background:transparent; border:2px solid #bfc4b4; border-radius:999px;
      padding:2px; display:inline-flex; align-items:center; justify-content:center;
    }
    .tag-chip img{ width:28px; height:28px; border-radius:999px; display:block; }
    .tag-row{ display:flex; gap:.5rem; flex-wrap:wrap; }
    
  </style>
</head>
<body>
<div x-data="planningApp()" x-init="init()" class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

  <!-- Header -->
  <header class="flex items-center gap-3 mb-6">
    <img src="Alveary%20Lt.%20Green.png" alt="" class="h-10 w-10 object-contain">
    <h1 class="title">Alveary Course Planning</h1>
    <div class="ml-auto text-sm no-print">
      <a href="./courses.html" class="underline">View / Print Course List</a>
    </div>
  </header>

  <!-- Streamlined Welcome + Guidance -->
  <!-- Top info: one white card containing intro + all guidance -->
    <section class="mb-6">
      <div class="intro-card">
        <!-- italic intro -->
        <p class="italic text-base leading-relaxed text-gray-700 m-0 mb-4">
          The guidance below is designed to help you plan your year with intention and grace.
          A Charlotte Mason education should fit the child, not force the child to fit the curriculum.
        </p>
    
        <!-- Guidance list inside the same card -->
        <template x-for="(g, i) in guidance" :key="g.key">
          <div class="guidance-block">
            <div class="guidance-head flex items-center gap-3">
              <img :src="g.icon" class="h-9 w-9" alt="">
              <h3 class="text-xl font-semibold text-[var(--green-dark)]" x-text="g.title"></h3>
            </div>
    
            <div class="guidance-copy" x-html="g.html"></div>
    
            <div x-show="i < guidance.length - 1" class="divider-green"></div>
          </div>
        </template>
      </div>
    </section>

  <!-- Filters / view controls -->
  <section class="panel mb-4 border-t border-gray-200 pt-4">
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Search</span>
        <input x-model.trim.debounce.250ms="search" type="search" placeholder="Title, subject, keyword…" class="w-full mt-1 rounded-xl border-gray-300 placeholder-[#7b8b7f]" />
      </label>

      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Subject</span>
        <select x-model="filters.subject" class="w-full mt-1 rounded-xl border-gray-300">
          <option value="">All</option>
          <template x-for="s in subjectList" :key="s"><option :value="s" x-text="s"></option></template>
        </select>
      </label>

      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Grade</span>
        <select x-model="filters.levelTag" class="w-full mt-1 rounded-xl border-gray-300">
          <option value="">All</option>
          <template x-for="lvl in levelList" :key="lvl"><option :value="lvl" x-text="lvl"></option></template>
        </select>
      </label>

      <label class="block">
        <span class="text-xs uppercase tracking-wide text-gray-500">Plan</span>
        <select x-model="filters.planUse" class="w-full mt-1 rounded-xl border-gray-300">
          <option value="">All</option>
          <option value="Core">Core</option>
          <option value="Family">Family</option>
          <option value="High Interest">High Interest</option>
          <option value="Additional">Additional</option>
          <option value="(none)">Undecided</option>
        </select>
      </label>
    </div>

    <div class="mt-3 flex flex-wrap items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" x-model="onlyPlanned"> Show only planned
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" x-model="onlyChecked"> Show only checked
      </label>
      <div class="ml-auto tiny text-gray-500">
        <strong x-text="selectedCount"></strong> selected
      </div>
    </div>
    <!-- helper row: tip + legend -->
      <div class="mt-3 text-sm text-gray-700 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <ul class="legend flex flex-wrap items-center gap-3">
          <li><img src="Core%20Subjects.png" alt=""> Core</li>
          <li><img src="Family%20Subjects.png" alt=""> Family</li>
          <li><img src="Combine%20Subjects.png" alt=""> Combine</li>
          <li><img src="High%20Interest%20Subjects.png" alt=""> High Interest</li>
          <li><img src="Additional%20Subjects.png" alt=""> Additional</li>
        </ul>
        <div>
          <em>Tip:</em> Click <strong>“i”</strong> on any course or topic to view Description and Combining &amp; Placement guidance.
        </div>
      </div>
  </section>

  <!-- Sticky actions -->
  <div class="no-print sticky top-0 z-10 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-3 bg-[var(--brand-bg)]/95 backdrop-blur border-y border-gray-200 flex justify-between items-center">
    <div class="tiny"><strong x-text="selectedCount"></strong> selected</div>
    <div class="flex items-center gap-2">
      <button @click="clearAll()" class="rounded-xl px-3 py-2 border border-[var(--green-dark)] text-[var(--green-dark)] bg-white hover:bg-[#f4f6fa]">Clear</button>
      <button @click="printSelected()" class="rounded-xl px-3 py-2 bg-[var(--green-dark)] text-white shadow hover:opacity-95">Print Selected</button>
    </div>
  </div>

  <!-- Course list -->
  <section>
    <!-- subject groups -->
    <template x-for="grp in groupedBySubject" :key="grp.subject || 'other'">
      <div class="group-block">
        <!-- full-width sticky subject bar (matches Clear/Print width trick) -->
        <div class="subject-bar no-print -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8"
             :style="{ '--subject-color': grp.color }">
          <div class="subject-inner">
            <span class="subject-dot"></span>
            <span x-text="grp.subject || 'Other'"></span>
          </div>
        </div>
  
        <!-- courses in this subject -->
        <template x-for="c in grp.items" :key="c.id">
          <div class="course-row" :style="{ '--subject-color': grp.color }">
            <div class="subject-rail"></div>
            <div class="course-card mb-3 rounded-2xl shadow-sm bg-white">
  
            <!-- band -->
            <div class="course-band grid grid-cols-12 items-center">
              <!-- LEFT: checkbox + title + icons + small schedule -->
              <div class="col-span-8 px-3 py-2 border-white/10 flex flex-col">
                <div class="flex items-center gap-2">
                  <input type="checkbox" class="size-5 rounded border-white/50"
                         x-model="c.checked" @change="persistChecked()" />
  
                  <div class="band-title font-crimson text-base font-semibold flex items-center gap-1.5">
                    <span x-text="c.title"></span>
  
                    <!-- ℹ️ info toggle -->
                    <button type="button" x-show="c.hasInfo"
                            @click="c.infoOpen = !c.infoOpen"
                            :aria-expanded="c.infoOpen"
                            :aria-controls="'acc-info-'+c.id"
                            class="text-xs bg-white/15 hover:bg-white/25 p-1.5 rounded"
                            title="Description &amp; Placement">
                      <span x-show="!c.infoOpen">i</span>
                      <span x-show="c.infoOpen">–</span>
                    </button>
  
                    <!-- ✏️ note toggle -->
                    <button type="button"
                            @click="c.noteOpen = !c.noteOpen"
                            :aria-expanded="c.noteOpen"
                            :aria-controls="'acc-note-'+c.id"
                            class="text-xs bg-white/15 hover:bg-white/25 p-1.5 rounded"
                            title="Add / View Note">✏️</button>
                  </div>
                </div>
  
                <!-- schedule under title -->
                <div class="text-[0.8rem] opacity-90 leading-tight ml-7 mt-0.5"
                     x-html="c.summary || '<span class=opacity-60>—</span>'"></div>
              </div>
  
              <!-- RIGHT: planning tags -->
              <div class="col-span-4 px-3 py-2 border-white/10 plan-anchor">
                <div class="flex items-center justify-end gap-3" x-data="{open:false}">
                  <!-- selected tags preview (only chosen ones) -->
                  <div class="tag-row" x-show="getUses(c.id).length">
                    <template x-for="val in getUses(c.id)" :key="val">
                      <span class="tag-chip">
                        <img :src="iconMap[val]" :alt="val">
                      </span>
                    </template>
                  </div>
              
                  <!-- Course Plan Button -->
                  <button type="button" class="plan-trigger course-plan-trigger"
                          @click="open=!open" :aria-expanded="open">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    <span>Plan</span>
                  </button>
              
                  <!-- menu -->
                  <div class="plan-menu" x-show="open" x-transition @click.outside="open=false">
                    <div class="text-xs uppercase tracking-wide text-gray-500 px-2 pb-1">Add tags</div>
                    <template x-for="opt in useOptions" :key="opt.value">
                      <label class="plan-opt">
                        <input type="checkbox" class="mr-1"
                         :checked="getUses(c.id).includes(opt.value)"
                         @change="toggleUse(c.id,opt.value); /* open=false */">
                        <img :src="opt.icon" :alt="opt.label">
                        <span x-text="opt.label"></span>
                      </label>
                    </template>
                  </div>
                </div>
              </div>
            </div>
  
            <!-- accordion area -->
            <div x-show="c.noteOpen || (c.infoOpen && c.hasInfo)" x-collapse>
              <!-- NOTE (gray, full width) -->
              <section :id="'acc-note-'+c.id" x-show="c.noteOpen" class="accordion">
                <div class="note-area">
                  <label class="text-xs uppercase tracking-wide text-gray-500 block mb-1">
                    Planning Note (optional)
                  </label>
                  <textarea
                    :value="plan[c.id]?.note || ''"
                    @input="plan[c.id]={ ...(plan[c.id]||{}), note:$event.target.value, ts:Date.now() }; persistPlan();"
                    placeholder="Add any details for your plan (who it’s for, pacing, resources, etc.)"></textarea>
                </div>
              </section>
  
              <!-- INFO (white, full width) -->
              <section :id="'acc-info-'+c.id" x-show="c.infoOpen && c.hasInfo" class="acc-info">
                <template x-if="c.description">
                  <div class="mb-3">
                    <div class="font-semibold mb-1">Description</div>
                    <div class="text-sm leading-6" x-html="c.description"></div>
                  </div>
                </template>
                <template x-if="c.combining">
                  <div>
                    <div class="font-semibold mb-1">Combining &amp; Placement</div>
                    <div class="text-sm leading-6" x-html="c.combining"></div>
                  </div>
                </template>
              </section>
            </div>

        <!-- topics -->
        <template x-if="c.topics && c.topics.length">
          <div class="px-3 pb-3 topics-list">
            <div class="text-xs uppercase tracking-wide text-gray-500 mt-2 mb-1">Topics</div>
        
            <template x-for="t in c.topics" :key="t.topic_id">
              <div class="mb-2">
                <!-- Topic row -->
                <div class="topic-row">
                  <div class="topic-left">
                    <input type="checkbox" class="size-4 mt-0.5"
                           x-model="t.checked" @change="persistChecked()" />
                    <div>
                      <div class="flex items-center gap-1">
                        <span class="topic-title" x-text="t.topic_title"></span>
        
                        <!-- ℹ️ info (only if info exists) -->
                        <button x-show="t.hasInfo"
                                @click="t.infoOpen = !t.infoOpen"
                                :aria-expanded="t.infoOpen"
                                :aria-controls="'t-acc-info-'+t.topic_id"
                                class="topic-icon"
                                title="Description &amp; Placement">
                          <span x-show="!t.infoOpen">i</span><span x-show="t.infoOpen">–</span>
                        </button>
        
                        <!-- ✏️ note -->
                        <button @click="t.noteOpen = !t.noteOpen"
                                :aria-expanded="t.noteOpen"
                                :aria-controls="'t-acc-note-'+t.topic_id"
                                class="topic-icon"
                                title="Add / View Note">✏️
                        </button>
                      </div>
        
                      <!-- Topic schedule directly under title -->
                      <div class="topic-schedule"
                           x-html="t.summary || '<span class=opacity-60>—</span>'"></div>
                    </div>
                  </div>
        
                  <!-- Right-side topic planning (selected chips + trigger) -->
                  <div class="topic-icons plan-anchor" x-data="{open:false}">
                    <div class="flex items-center gap-3">
                      <!-- selected chips -->
                      <div class="tag-row" x-show="getUses(t.topic_id).length">
                        <template x-for="val in getUses(t.topic_id)" :key="val">
                          <span class="tag-chip">
                            <img :src="iconMap[val]" :alt="val">
                          </span>
                        </template>
                      </div>
                  
                      <!-- Topic Plan Button -->
                      <button type="button" class="plan-trigger"
                              @click="open=!open" :aria-expanded="open">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 6L9 17l-5-5"/>
                        </svg>
                        <span>Plan</span>
                      </button>
                    </div>
                  
                    <!-- menu -->
                    <div class="plan-menu" x-show="open" x-transition @click.outside="open=false">
                      <div class="text-xs uppercase tracking-wide text-gray-500 px-2 pb-1">Add tags</div>
                      <template x-for="opt in useOptions" :key="opt.value">
                        <label class="plan-opt">
                          <input type="checkbox" class="mr-1"
                                 :checked="getUses(t.topic_id).includes(opt.value)"
                                 @change="toggleUse(t.topic_id,opt.value)">
                          <img :src="opt.icon" :alt="opt.label">
                          <span x-text="opt.label"></span>
                        </label>
                      </template>
                    </div>
                  </div>
                </div>
        
                <!-- Topic accordions (full width under this topic) -->
                <div x-show="t.noteOpen || (t.infoOpen && t.hasInfo)" x-collapse>
                  <!-- Note tray (gray) -->
                  <section :id="'t-acc-note-'+t.topic_id" x-show="t.noteOpen" class="topic-acc-note">
                    <div class="topic-note-area">
                      <label class="text-xs uppercase tracking-wide text-gray-500 block mb-1">
                        Planning Note (topic)
                      </label>
                      <textarea
                        :value="plan[t.topic_id]?.note || ''"
                        @input="plan[t.topic_id]={ ...(plan[t.topic_id]||{}), note:$event.target.value, ts:Date.now() }; persistPlan();"
                        placeholder="Add any topic-specific notes"></textarea>
                    </div>
                  </section>
        
                  <!-- Info tray (white) -->
                  <section :id="'t-acc-info-'+t.topic_id" x-show="t.infoOpen && t.hasInfo" class="topic-acc-info">
                    <template x-if="t.description">
                      <div class="mb-2">
                        <div class="font-semibold mb-1">Description</div>
                        <div class="text-sm leading-6" x-html="t.description"></div>
                      </div>
                    </template>
                    <template x-if="t.combining">
                      <div>
                        <div class="font-semibold mb-1">Combining &amp; Placement</div>
                        <div class="text-sm leading-6" x-html="t.combining"></div>
                      </div>
                    </template>
                  </section>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>  
      </template>
    </div>
  </template>
</section>

    <template x-if="!groupedFlat.length">
      <p class="text-center text-gray-500 py-12">No courses match your filters/view.</p>
    </template>
  
</div>
  
<script>
function planningApp(){
  return {
    /* ---------- UI state ---------- */
    search:'', filters:{subject:'', levelTag:'', planUse:''},
    onlyPlanned:false, onlyChecked:false,

    /* ---------- data ---------- */
    courses:[], courseIndex:{}, plan:{}, openGuidance:{},

    noteFor:null, noteDraft:'',
    modal:{title:'',description:'',combine:''},

    // guidance blocks (uses your uploaded PNGs)
    guidance:[
      {
        key:'core', title:'Core Subjects', icon:'Core%20Subjects.png',
        html:`
          <p><strong>Start by focusing on the core subjects</strong> required by your state or those you consider nonnegotiable, such as Bible, History, Geography, English/Reading, Literature, Science, and Math.</p>
    
          <p>If you plan to modify a subject—such as focusing on only one stream of History (e.g., <em>World, Ancient,</em> or <em>US/Canadian for grades 4+</em>)—make a note of it. Similarly, if you intend to combine students into a single grade level for a subject (e.g., <em>2nd and 3rd graders sharing a 3rd-grade Science course</em>), make note of that too.</p>
    
          <p>Refer to our <a href="https://www.alveary.org/whats-new/tips-for-combining-students" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">tips on combining students</a> for additional guidance.</p>
        `
      },
      {
        key:'family', title:'Family & High-Interest', icon:'Family%20Subjects.png',
        html:`
          <p><strong>Next, choose a few subjects that spark high interest</strong> for each child or that your whole family would enjoy together.</p>
    
          <p>You can focus on the same subject throughout the year or rotate topics to explore a variety. For example, you might dedicate one term each to <em>Shakespeare, Plutarch,</em> and <em>Composer Study</em> if you don't have room for a full year of each. If you prefer a slower pace, consider spreading a term's worth of lessons across two terms.</p>
    
          <p>This approach works well for subjects such as <em>Art Instruction</em> or <em>Singing,</em> giving you the flexibility to adjust to your students' needs.</p>
        `
      },
      {
        key:'additional', title:'Additional Subjects', icon:'Additional%20Subjects.png',
        html:`
          <p><strong>Review the remaining subjects and choose one or two</strong> that feel especially important to include, especially if they haven’t been covered yet. Consider options that:</p>
    
          <ul class="list-disc pl-6 mt-2 mb-3 space-y-1">
            <li>Fulfill high-school credit requirements.</li>
            <li>Reflect your family’s priorities or interests.</li>
            <li>Align with your child’s passions or future goals.</li>
          </ul>
    
          <p>These could also be subjects where Alveary offers resources without daily lesson plans (e.g., <em>cooking</em> or <em>car maintenance</em>) or areas where you can incorporate non-Alveary resources, such as co-op classes or ACT prep courses.</p>
        `
      },
      {
        key:'plan', title:'Plan Your Year', icon:'Plan%20Your%20Year.png',
        html:`
          <p>Now that you’ve identified your subjects, you’re ready to <strong>create a schedule</strong> using Alveary’s scheduling tools. This is a great starting point for your school year.</p>
    
          <p>If you have room for additional subjects—or think you might later—make a list of what you’d like to include and why each is important. Consider adding these subjects when time allows.</p>
    
          <p>For guidance, refer to these Alveary resources:</p>
          <ul class="list-none mt-2 mb-1 space-y-1 pl-6">
            <li>∞ <a href="https://www.alveary.org/whats-new/a-relational-education" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Relational Education</a> <span class="text-gray-600">(which subjects are intertwined)</span></li>
            <li>∞ <a href="http://www.alveary.org/whats-new/balancing-the-feast" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Balancing the Feast</a> <span class="text-gray-600">(often overlooked subjects)</span></li>
            <li>∞ <a href="https://www.alveary.org/whats-new/tips-for-combining-students" target="_blank" rel="noopener" class="underline text-[var(--green-dark)] hover:opacity-80">Tips for Combining Students</a></li>
          </ul>
        `
      }
    ],

    useOptions:[
      {label:'Core Subject', value:'Core', icon:'Core%20Subjects.png'},
      {label:'Family', value:'Family', icon:'Family%20Subjects.png'},
      {label:'Combine', value:'Combine', icon:'Combine%20Subjects.png'},
      {label:'High Interest', value:'High Interest', icon:'High%20Interest%20Subjects.png'},
      {label:'Additional', value:'Additional', icon:'Additional%20Subjects.png'}
    ],

    /* ---------- sources (same as your list page) ---------- */
    dataSources:{
      courses:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=0&single=true&output=csv',
      topics: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsihZUzspkkv62sv-KxQOjiXIApm8W8fOO1f_y9sfhyLLTeJhGsq6l5k1BhONtEtw7q197VqdZqDN3/pub?gid=1919021076&single=true&output=csv'
    },
    courseFields:{
      course_id:'Course_ID', course_title:'Course', subject:'Subject',
      schedule_text:'Scheduling_R3', grade_text:'Grade_Text', grade_filter:'Grade_Filter',
      description:'Program_Description_R3', combining_placement:'Combining&PlacementTips_R3'
    },
    topicFields:{
      topic_id:'Topic_ID', course_id:'Course_ID_R3', topic_title:'Topic',
      topic_description:'Program_Description_R3', combining_placement:'Combining&PlacementTips_R3',
      schedule_text:'Scheduling_R3', grade_text:'Grade_Text', grade_filter:'Grade_Filter'
    },

    subjectColors:{
        'Architecture': '#a0a6be',
        'Art': '#907061',
        'Bible': '#964945',
        'Citizenship': '#62765c',
        'English': '#9b5b7b',
        'Geography': '#4d8da2',
        'History': '#6b6bbf',
        'Latin': '#5a5373',
        'Life Skills': '#d1b358',
        'Literature': '#c07669',
        'Math': '#6d7eaa',
        'Modern Language': '#6db4b2',
        'Music': '#9e6bac',
        'Physical Education': '#bd855e',
        'Science': '#96a767',
        'Science & Alt. Science': '#96a767'
      },
      subjectColor(name){
        if(!name) return '#dfe4df';
        // loose match so "Science & Alt. Science" etc. resolve
        const key = Object.keys(this.subjectColors).find(k =>
          k.toLowerCase() === name.toLowerCase()
        );
        return key ? this.subjectColors[key] : '#dfe4df';
      },

    /* ---------- computed ---------- */
    get filtered(){
      const q=this.search.toLowerCase();
      return this.courses.filter(c=>{
        // text filters
        const matchesQ=!q || [c.title,c.subject,c.summary,c.levelDisplay].join(' ').toLowerCase().includes(q);
        const matchesS=!this.filters.subject || c.subject===this.filters.subject;
        const matchesL=!this.filters.levelTag || (c.levelTags||[]).includes(this.filters.levelTag);

        // plan filter
        let matchesPlan=true;
        const use = this.plan[c.id]?.use || [];
        const uses = Array.isArray(use) ? use : [use];
        if(this.filters.planUse === '(none)') matchesPlan = uses.length === 0;
        else if(this.filters.planUse) matchesPlan = uses.includes(this.filters.planUse);

        // view toggles
        const passPlanned = !this.onlyPlanned || !!use;
        const passChecked = !this.onlyChecked || c.checked || (c.topics||[]).some(t=>t.checked);

        return matchesQ && matchesS && matchesL && matchesPlan && passPlanned && passChecked;
      });
    },
    get groupedFlat(){
      const by = new Map();
      this.filtered.forEach(c=>{ const s=c.subject||'Other'; if(!by.has(s)) by.set(s,[]); by.get(s).push(c); });
      const special='Alt. Science Options';
      return Array.from(by.entries()).sort((a,b)=>{
        const A=a[0]||'', B=b[0]||'';
        if(A===special && B!==special) return 1;
        if(B===special && A!==special) return -1;
        return A.localeCompare(B,undefined,{numeric:true});
      }).flatMap(x=>x[1]);
    },
    get selectedCount(){
      return this.courses.reduce((n,c)=> n + (c.checked?1:0) + ((c.topics||[]).filter(t=>t.checked).length), 0);
    },
    get subjectList(){ return [...new Set(this.courses.map(c=>c.subject).filter(Boolean))].sort((a,b)=>a.localeCompare(b,undefined,{numeric:true})); }
    ,get levelList(){ return [...new Set(this.courses.flatMap(c=>c.levelTags||[]))].sort((a,b)=> {
      const na=+a.replace(/\D/g,''); const nb=+b.replace(/\D/g,''); return na-nb || a.localeCompare(b);
    }); },

    get groupedCourses(){
        // assumes you already have coursesFiltered – use whatever your filtered array name is
        const arr = this.coursesFiltered || this.courses; 
        return arr.reduce((out, c) => {
          const subj = c.subject || 'Other';
          const last = out[out.length-1];
          if(!last || last.subject !== subj){
            out.push({ subject: subj, color: this.subjectColor(subj), items:[c] });
          }else{
            last.items.push(c);
          }
          return out;
        }, []);
      },

      get groupedBySubject(){
          const arr = this.groupedFlat || [];  // ← filtered + subject-sorted flat list
          return arr.reduce((out, c) => {
            const subj = c.subject || 'Other';
            const last = out[out.length - 1];
            if (!last || last.subject !== subj) {
              out.push({ subject: subj, color: this.subjectColor(subj), items: [c] });
            } else {
              last.items.push(c);
            }
            return out;
          }, []);
        },

    /* ---------- helpers ---------- */
    _getCI(row,want){ const keys=Array.isArray(want)?want:[want]; for(const k of keys){ const hit=Object.keys(row).find(h=>h.trim().toLowerCase()===String(k).trim().toLowerCase()); if(hit) return row[hit]; } },
    computeGradeTags(gr){
      const tags=[]; const range=gr&&gr.match(/^(?:[Gg]?(\d+))\s*[–-]\s*[Gg]?(\d+)$/);
      if(range){ const a=+range[1],b=+range[2]; for(let i=Math.min(a,b); i<=Math.max(a,b); i++) tags.push(`G${i}`); return tags; }
      const single=gr&&gr.match(/^[Gg]?(\d+)$/); if(single) return [`G${+single[1]}`];
      if(gr && String(gr).includes(',')){ String(gr).split(',').forEach(x=>{ const n=x.replace(/[^0-9]/g,''); if(n) tags.push(`G${+n}`); }); }
      return tags;
    },
    rowToCourse(row){
      const g = (k) => this._getCI(row, this.courseFields[k]);
    
      const idRaw   = (g('course_id') || '').toString().trim();
      const titleRaw= (g('course_title') || '').toString().trim();
      if(!idRaw && !titleRaw) return null;
    
      const subject     = (g('subject') || '').toString().trim();
      const gradeText   = (g('grade_text') || '').toString().trim();
      const gradeFilter = (g('grade_filter') || '').toString().trim();
    
      // Scheduling now shows under the title
      const schedule    = (g('schedule_text') || '').toString().trim();
    
      const description = (g('description') || '').toString().trim();
      const combining   = (g('combining_placement') || '').toString().trim();
    
      const levelDisplay = gradeText || '';
      const levelTags = (gradeFilter && /G\s*\d+/i.test(gradeFilter))
        ? (gradeFilter.match(/G\s*\d+/gi) || []).map(s => 'G' + s.replace(/[^0-9]/g,''))
        : this.computeGradeTags(gradeText);
    
      const details = [];
      if (description) details.push({ label:'Description',            value: description });
      if (combining)   details.push({ label:'Combining & Placement', value: combining   });
    
      const hasInfo = !!(description || combining);
    
      return {
        id: idRaw || titleRaw,
        title: titleRaw || idRaw,
        subject,
    
        // used under the title
        summary: schedule,
    
        // info content
        details, description, combining, hasInfo,
    
        // filters
        levelDisplay, levelTags,
    
        // selection + topics
        checked: false,
        topics: [],
    
        // accordions (NEW/CONFIRMED)
        infoOpen: false,   // ℹ️ toggles this
        noteOpen: false    // ✏️ toggles this
      };
    },
    rowToTopic(row){
      const g=(k)=>this._getCI(row,this.topicFields[k]);
    
      const rawCourseIds = (g('course_id')||'').toString().trim();
      const topic_title  = (g('topic_title')||'').toString().trim();
      if(!rawCourseIds || !topic_title) return null;
    
      const topic_id     = (g('topic_id')||'').toString().trim() || (rawCourseIds+'::'+topic_title);
      const topic_desc   = (g('topic_description')||'').toString().trim();
      const combining    = (g('combining_placement')||'').toString().trim();
      const schedule_t   = (g('schedule_text')||'').toString().trim();
    
      const gradeText    = (g('grade_text')||'').toString().trim();
      const gradeFilter  = (g('grade_filter')||'').toString().trim();
      const levelDisplay = gradeText || '';
      const levelTags = (gradeFilter && /G\s*\d+/i.test(gradeFilter))
        ? (gradeFilter.match(/G\s*\d+/gi)||[]).map(s=>'G'+s.replace(/[^0-9]/g,''))
        : this.computeGradeTags(gradeText);
    
      const details=[]; if(topic_desc) details.push({label:'Description', value:topic_desc});
      if(combining) details.push({label:'Combining & Placement', value:combining});
    
      const hasInfo = !!(topic_desc || combining);
    
      return {
        topic_id,
        course_ids: rawCourseIds.split(',').map(s=>s.trim()).filter(Boolean),
        topic_title,
        summary: schedule_t,
        details,
        description: topic_desc,
        combining,
        levelDisplay, levelTags,
        checked:false,
    
        /* NEW: per-topic accordions */
        hasInfo,
        infoOpen:false,
        noteOpen:false
      };
    },

    /* ---------- storage & sync ---------- */
    persistChecked(){
      const ids=[]; this.courses.forEach(c=>{ if(c.checked) ids.push('c:'+c.id); (c.topics||[]).forEach(t=>{ if(t.checked) ids.push('t:'+t.topic_id); }); });
      localStorage.setItem('pf_courses', JSON.stringify(ids));
    },
    restoreChecked(){
      try{
        const saved=JSON.parse(localStorage.getItem('pf_courses')||'[]'); const set=new Set(saved);
        this.courses.forEach(c=>{ c.checked=set.has('c:'+c.id); (c.topics||[]).forEach(t=>{ t.checked=set.has('t:'+t.topic_id); }); });
      }catch{}
    },
    loadPlan(){ try{ this.plan=JSON.parse(localStorage.getItem('pf_plan_v1')||'{}'); }catch{ this.plan={}; } },
    persistPlan(){ localStorage.setItem('pf_plan_v1', JSON.stringify(this.plan)); },
    setUse(id, use) {
      const existing = this.plan[id]?.use || [];
      // Normalize to array
      const currentUses = Array.isArray(existing) ? existing : existing ? [existing] : [];
    
      // If already selected, remove it; otherwise add it
      const newUses = currentUses.includes(use)
        ? currentUses.filter(u => u !== use)
        : [...currentUses, use];
    
      this.plan[id] = { ...(this.plan[id] || {}), use: newUses, ts: Date.now() };
      this.persistPlan();
    },
    setTopicUse(tid, use){
      const existing = this.plan[tid]?.use || [];
      const uses = Array.isArray(existing) ? existing : (existing ? [existing] : []);
      const newUses = uses.includes(use) ? uses.filter(u=>u!==use) : [...uses, use];
      this.plan[tid] = { ...(this.plan[tid]||{}), use:newUses, ts:Date.now() };
      this.persistPlan();
    },
    topicHasUse(tid, val){
      const u = this.plan[tid]?.use || [];
      return Array.isArray(u) ? u.includes(val) : u===val;
    },

    iconMap:{
      'Core':'Core%20Subjects.png',
      'Family':'Family%20Subjects.png',
      'Combine':'Combine%20Subjects.png',
      'High Interest':'High%20Interest%20Subjects.png',
      'Additional':'Additional%20Subjects.png'
    },
    iconsFor(use){
      const uses = Array.isArray(use) ? use : (use ? [use] : []);
      return uses
        .map(u => this.iconMap[u])
        .filter(Boolean); // skip empty/unknown (e.g., Undecided)
    },

    getUses(id){
      const u = this.plan[id]?.use ?? [];
      return Array.isArray(u) ? u : (u ? [u] : []);
    },
    toggleUse(id, val){
      const cur = this.getUses(id);
      const next = cur.includes(val) ? cur.filter(v=>v!==val) : [...cur, val];
      this.plan[id] = { ...(this.plan[id]||{}), use: next, ts: Date.now() };
      this.persistPlan();
    },

    /* ---------- guidance open/close memory ---------- */
    isOpen(key){ return this.openGuidance[key] ?? (key==='core'); },
    toggleOpen(key,val){ this.openGuidance[key]=!!val; localStorage.setItem('pf_guidance_open', JSON.stringify(this.openGuidance)); },

    /* ---------- load ---------- */
    async loadDualCSVs(){
      const cacheKey='pf_csv_cache_v1', maxAgeMs=6*60*60*1000, now=Date.now();
      let cached; try{ cached=JSON.parse(localStorage.getItem(cacheKey)||'null'); }catch{}
      if(cached && (now - cached.ts) < maxAgeMs){
        const pc=Papa.parse(cached.courses,{header:true,skipEmptyLines:true});
        const pt=Papa.parse(cached.topics,{header:true,skipEmptyLines:true});
        return this.applyParsed(pc,pt);
      }
      const [cCSV,tCSV]=await Promise.all([
        fetch(this.dataSources.courses).then(r=>r.text()),
        fetch(this.dataSources.topics).then(r=>r.text())
      ]);
      localStorage.setItem(cacheKey, JSON.stringify({ts:now, courses:cCSV, topics:tCSV}));
      const pc=Papa.parse(cCSV,{header:true,skipEmptyLines:true});
      const pt=Papa.parse(tCSV,{header:true,skipEmptyLines:true});
      this.applyParsed(pc,pt);
    },
    applyParsed(pc,pt){
      this.courseIndex={};
      pc.data.forEach(row=>{ const c=this.rowToCourse(row); if(c) this.courseIndex[c.id]=c; });
      pt.data.forEach(row=>{ const t=this.rowToTopic(row); if(!t) return; t.course_ids.forEach(cid=>{ if(this.courseIndex[cid]) this.courseIndex[cid].topics.push(t); }); });
      this.courses=Object.values(this.courseIndex);
    },

    /* ---------- actions ---------- */
    clearAll(){
      this.courses.forEach(c=>{ c.checked=false; (c.topics||[]).forEach(t=>t.checked=false); });
      this.persistChecked();
      this.plan={}; this.persistPlan();
    },
    printSelected(){ window.print(); },

    async init(){
      // load guidance open state
      try{ this.openGuidance = JSON.parse(localStorage.getItem('pf_guidance_open')||'{}'); }catch{ this.openGuidance={}; }

      await this.loadDualCSVs();
      this.restoreChecked();
      this.loadPlan();
    }
  }
}
</script>
</body>
</html>
