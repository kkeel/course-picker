name: Render Course List PDFs

on:
  workflow_dispatch:
    inputs:
      master:
        description: "Include MASTER"
        type: boolean
        default: true

      g1:  { description: "Grade 1",  type: boolean, default: false }
      g2:  { description: "Grade 2",  type: boolean, default: false }
      g3:  { description: "Grade 3",  type: boolean, default: false }
      g4:  { description: "Grade 4",  type: boolean, default: false }
      g5:  { description: "Grade 5",  type: boolean, default: false }
      g6:  { description: "Grade 6",  type: boolean, default: false }
      g7:  { description: "Grade 7",  type: boolean, default: false }
      g8:  { description: "Grade 8",  type: boolean, default: false }
      g9:  { description: "Grade 9",  type: boolean, default: false }
      g10: { description: "Grade 10", type: boolean, default: false }
      g11: { description: "Grade 11", type: boolean, default: false }
      g12: { description: "Grade 12", type: boolean, default: false }

  schedule:
  - cron: "20 4 * * *"

jobs:
  render:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm i -D playwright
          npx playwright install --with-deps chromium

      - name: Build grade selection
        id: grades
        shell: bash
        run: |
          set -euo pipefail

          # If running on a schedule, render ALL grades automatically
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "Scheduled run: rendering ALL grades + MASTER"
            echo "grades=G1,G2,G3,G4,G5,G6,G7,G8,G9,G10,G11,G12" >> "$GITHUB_OUTPUT"
            echo "include_master=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Otherwise, manual run: use the checkboxes
          GRADES=""
          add() {
            if [ -z "$GRADES" ]; then GRADES="$1"; else GRADES="$GRADES,$1"; fi
          }

          if [ "${{ inputs.g1 }}" = "true" ]; then add "G1"; fi
          if [ "${{ inputs.g2 }}" = "true" ]; then add "G2"; fi
          if [ "${{ inputs.g3 }}" = "true" ]; then add "G3"; fi
          if [ "${{ inputs.g4 }}" = "true" ]; then add "G4"; fi
          if [ "${{ inputs.g5 }}" = "true" ]; then add "G5"; fi
          if [ "${{ inputs.g6 }}" = "true" ]; then add "G6"; fi
          if [ "${{ inputs.g7 }}" = "true" ]; then add "G7"; fi
          if [ "${{ inputs.g8 }}" = "true" ]; then add "G8"; fi
          if [ "${{ inputs.g9 }}" = "true" ]; then add "G9"; fi
          if [ "${{ inputs.g10 }}" = "true" ]; then add "G10"; fi
          if [ "${{ inputs.g11 }}" = "true" ]; then add "G11"; fi
          if [ "${{ inputs.g12 }}" = "true" ]; then add "G12"; fi

          echo "grades=$GRADES" >> "$GITHUB_OUTPUT"
          echo "include_master=${{ inputs.master }}" >> "$GITHUB_OUTPUT"

          echo "Selected grades: $GRADES"
          echo "Include MASTER: ${{ inputs.master }}"

      - name: Render Course List PDFs
        run: node scripts/render-course-list-all-grades.mjs
        env:
          GRADES: ${{ steps.grades.outputs.grades }}
          INCLUDE_MASTER: ${{ steps.grades.outputs.include_master }}

      - name: Commit PDFs (only if changed)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add pdf/course-list/*.pdf

          if git diff --cached --quiet; then
            echo "No PDF changes to commit."
            exit 0
          fi

          git commit -m "Nightly update: Course List PDFs"
          git push
