<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 1. Required basics -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary – Planner</title>

  <!-- 2. PWA / App metadata -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#596e5e">

  <!-- iOS support -->
  <link rel="apple-touch-icon" href="./img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- 2.5 MemberStack (must load early to read login state) -->
  <script>
    window.memberstackConfig = {
      useCookies: true,
      setCookieOnRootDomain: true
    };
  </script>
  
  <script
    data-memberstack-app="app_clbb9rspy00160ujl6tsxbsrj"
    src="https://static.memberstack.com/scripts/v1/memberstack.js"
    type="text/javascript">
  </script>

  <!-- 3. Fonts -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
  />

  <!-- 4. CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/print-course.css">
  <link rel="stylesheet" href="css/aag.css">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" type="image/png" href="img/Alveary%20Lt.%20Green.png">
</head>

<body x-data="coursePlanner()" x-init="init()">
  <!-- Auth refresh overlay -->
  <div
    x-show="authRefreshing"
    x-transition.opacity
    x-cloak
    class="fixed inset-0 z-[9999] flex items-center justify-center"
    style="background: rgba(0,0,0,0.25);"
  >
    <div class="bg-white rounded-2xl shadow-xl px-8 py-6 text-center">
      <div class="text-lg font-semibold mb-2">
        Sign in successful
      </div>
      <div class="text-sm opacity-70 mb-4">
        Gathering your At-a-Glance info…
      </div>
      <div class="animate-pulse text-sm">
        Loading…
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="app-header mb-8 px-6 md:px-16 py-4 md:py-6 flex flex-col md:flex-row md:items-center gap-4">
    <!-- Logo + wordmark -->
    <a href="https://www.alveary.org/alveary-2026-2027/dashboard" class="logo-link flex items-center gap-3" aria-label="Go to Alveary dashboard">
      <img
        src="img/Alveary%20Lt.%20Green.png"
        alt="Alveary logo"
        class="object-contain"
        style="height: 40px; width: 40px;"
      />
      <div class="logo-text-block">
        <span class="logo-title">Alveary</span>

        <!-- PRINT-ONLY: year under Alveary (left) -->
        <span class="print-year-left">2026–2027</span>
      </div>
    </a>

    <!-- Top-right: staff toggle + nav (screen only) -->
    <div class="mt-3 md:mt-0 md:ml-auto flex items-center justify-end gap-6 text-sm">
      <!-- Auth button: public + members -->
        <button
          id="auth-button"
          class="auth-button text-sm px-3 py-1.5 rounded border border-[#596e5e] text-[#596e5e] hover:bg-[#596e5e] hover:text-white transition"
          x-show="!isAuthed"
          @click="openAuth()"
        >
          Sign in
        </button>
    
      <!-- navigation (stepper + menu) -->
      <div id="app-step-nav" class="app-step-nav"></div>
    </div>

    <!-- PRINT-ONLY: Course List + grade/master label on the right -->
    <div class="print-header-title-block">
      <div class="print-header-title">Year At-A-Glance</div>
      <div class="print-header-grade" x-text="gradePrintLabel()"></div>
    </div>
    
  </header>

  <!-- PRINT-ONLY FOOTER -->
  <footer class="print-footer" aria-hidden="true">
    <div class="print-footer-left">Alveary Year At-A-Glance</div>
    <div class="print-footer-center">©2026 Charlotte Mason Institute® All rights reserved.</div>
    <div class="print-footer-right">
      <span class="print-footer-grade" x-text="gradePrintLabel()"></span>
      <span class="print-page-number"></span>
    </div>
  </footer>

  <!-- Main content -->
  <main class="main-content px-6 lg:px-16 pb-16 space-y-10">
    
    <!-- PUBLIC GATE MESSAGE (Course List) -->
    <section x-show="courseGate" x-cloak class="mt-6">
      <h2 class="section-title">Year At-A-Glance</h2>
    
      <div class="mt-6 p-6 rounded-lg border border-[#d2d6d2] bg-white max-w-2xl">
        <p class="text-sm text-[#596e5e] mb-4">
          The Year At-A-Glance is available to Alveary members.
        </p>
        <button
          class="auth-button text-sm px-4 py-2 rounded border border-[#596e5e] text-[#596e5e] hover:bg-[#596e5e] hover:text-white transition"
          @click="openAuth()"
        >
          Sign in to view
        </button>
      </div>
    </section>

    <div x-show="!courseGate" x-cloak>
    <!-- Yearly At-A-Glance -->
    <section>
      <h2 class="section-title">Yearly At-A-Glance</h2>
    
      <div class="av-intro-flex">
      <!-- Intro text (paragraphs) -->
      <div class="section-subtitle av-intro-text av-intro-paragraphs">
        <p>
          Use this tool to get a bird's eye view of your year and the key resources assigned for each term. Filter by grade or by your students or selected courses. Finish by printing your personalized overview!
        </p>
      </div>
        
      <div class="av-intro-side">

        <!-- Tutorial video box -->
        <div class="av-video-inline">
          <a id="avTutorialsInlineLink" class="av-video-row" href="#" target="_blank" rel="noopener">
            <img class="av-play-icon" src="img/icons/play-button.svg" alt="" aria-hidden="true" />
            <span class="av-video-text">Planning App Tutorials</span>
          </a>
        </div>
    </div>
    </section>

      <!-- Filter state + panel (both stick under header) -->
      <div class="filter-state-wrapper">
        <!-- Sticky bar -->
        <div class="flex justify-center">
          <div
            class="filter-state-bar"
            x-show="!isLoadingCourses && !loadError"
            x-cloak
            @click="toggleFiltersOpen()"
          >
            <div class="filter-state-main">
              <span class="filter-state-label">Filter by</span>
              <span class="filter-state-summary" x-text="filterSummary"></span>
            </div>
        
            <div class="filter-state-actions">
              <span
                class="filter-state-toggle-text"
                x-text="filtersOpen ? 'Hide' : 'Show'"
              ></span>
            </div>
          </div>
        </div>

        <!-- Sticky panel (only shown when filtersOpen === true) -->
        <div
          class="mt-0 flex justify-center"
          id="course-filters"
          x-show="filtersOpen"
          x-transition
        >
          <div class="filter-panel">
            <div class="filter-grid">
              <!-- Grade -->
              <div class="relative" @click.outside="gradeDropdownOpen = false">
                <button
                  type="button"
                  id="filter-grade"
                  class="filter-control"
                  aria-label="Filter by grade"
                  @click="gradeDropdownOpen = !gradeDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedGrades.length === 0">
                    <span class="filter-placeholder">Grade</span>
                  </template>

                  <!-- chips when grades are selected -->
                  <template x-if="selectedGrades.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="code in selectedGrades" :key="code">
                        <span class="filter-chip">
                          <span x-text="gradeLabelFromCode(code)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeGrade(code)"
                            aria-label="Remove grade"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>

                  <span
                    class="filter-chevron"
                    :class="gradeDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>

                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="gradeDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in gradeOptions" :key="opt.code">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleGrade(opt.code)"
                    >
                      <span x-text="opt.label"></span>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedGrades.includes(opt.code)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Students: manage + filter -->
              <!-- Student (multi-select, chip-style like other filters) -->
              <div class="relative" @click.outside="studentDropdownOpen = false">
                <button
                  type="button"
                  id="filter-student"
                  class="filter-control"
                  aria-label="Filter by student"
                  @click="studentDropdownOpen = !studentDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="!selectedStudents || selectedStudents.length === 0">
                    <span class="filter-placeholder">Students</span>
                  </template>
              
                  <!-- chips when students are selected -->
                  <template x-if="selectedStudents && selectedStudents.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="sid in selectedStudents" :key="sid">
                        <span
                            class="filter-chip"
                            :class="sid === '__any__' ? 'filter-chip--any-student' : 'filter-chip--student'"
                            :style="sid === '__any__' ? '' : `background-color:${studentColorFromId(sid)};`"
                          >
                          <span x-text="studentNameFromId(sid)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeStudentFilter(sid)"
                            aria-label="Remove student"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="studentDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div class="filter-dropdown" x-show="studentDropdownOpen" x-transition>
                  <button
                    type="button"
                    class="filter-dropdown-item"
                    @click="toggleStudentFilter('__any__')"
                  >
                    <span class="student-dd-row">
                      <span class="student-dd-swatch" style="background-color:#f4f6fa; border-color:#dde2d5" aria-hidden="true"></span>
                      <span>All Students</span>
                    </span>
                  
                    <span class="filter-dropdown-check" x-show="selectedStudents.includes('__any__')">✓</span>
                  </button>
                  <template x-for="s in students" :key="s.id">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleStudentFilter(s.id)"
                    >
                      <span class="student-dd-row">
                        <span
                          class="student-dd-swatch"
                          :style="`background-color:${s.color || '#596e5e'}`"
                          aria-hidden="true"
                        ></span>
                        <span x-text="s.name || 'Unnamed'"></span>
                      </span>
                  
                      <span class="filter-dropdown-check" x-show="selectedStudents.includes(s.id)">✓</span>
                    </button>
                  </template>
                </div>
              </div>

              <div class="manage-students-cell">
              <button
                type="button"
                class="manage-students-toggle"
                @click.stop="toggleStudentsOpen()"
                :aria-expanded="studentsOpen ? 'true' : 'false'"
              >
                Manage Students
              </button>

            <div
              class="student-manager student-manager--full"
              x-show="studentsOpen"
              x-transition
              x-cloak
              @click.stop
            >
              <p class="student-manager-help">
                Add up to 15 students. Click color buttons to change student colors.
              </p>

              <div class="student-list">
                <template x-for="s in students" :key="s.id">
                  <div>
                    <div class="student-row">
                      <!-- Color square (click to open swatches) -->
                      <button
                        type="button"
                        class="student-color-btn"
                        :style="{ backgroundColor: s.color }"
                        @click.stop="toggleStudentColorPicker(s.id)"
                        aria-label="Choose student color"
                        title="Choose color"
                      ></button>
                    
                      <input
                        class="student-name-input"
                        type="text"
                        placeholder="Student name"
                        :value="s.name"
                        @input="updateStudentName(s.id, $event.target.value)"
                      />
                    
                      <!-- Subtle X remove -->
                      <button
                        type="button"
                        class="student-remove-x"
                        @click.stop="removeStudent(s.id)"
                        aria-label="Remove student"
                        title="Remove"
                      >×</button>
                    </div>

                    <div class="student-swatches" x-show="colorPickerFor === s.id" x-transition>
                      <template x-for="c in studentColorPalette" :key="c">
                        <button
                          type="button"
                          class="student-swatch"
                          :class="s.color === c ? 'student-swatch--selected' : ''"
                          :style="{ backgroundColor: c }"
                          @click="setStudentColor(s.id, c)"
                          :aria-label="`Set color ${c}`"
                          title="Set color"
                        ></button>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="student-add-row">
                <input
                  class="student-name-input"
                  type="text"
                  placeholder="Add a student…"
                  x-model="newStudentName"
                  @keydown.enter.prevent="addStudent()"
                />
                <button
                  type="button"
                  class="student-row-btn"
                  @click="addStudent()"
                  :disabled="!canAddStudent"
                >Add</button>
              </div>
            </div>
            </div>

    
            </div>

            <div class="filter-actions">
              <!-- Left: clear + print buttons -->
              <div class="flex gap-2">
                <button
                  type="button"
                  class="btn-pill"
                  @click="clearAllFilters()"
                >
                  <span class="btn-pill-icon" aria-hidden="true">
                    <!-- Filter (funnel) icon -->
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M4 5h16l-6.5 7.5V19l-3-1.5v-5L4 5z"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                  <span>Clear filters</span>
                </button>

                <button
                  type="button"
                  class="btn-pill btn-secondary print-btn"
                  @click="openPrintTip()"
                >
                  <span class="btn-pill-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="9" width="14" height="9" rx="1.5" ry="1.5"
                            fill="none" stroke="currentColor" stroke-width="1.8" />
                      <path d="M8 9V5h8v4"
                            fill="none" stroke="currentColor" stroke-width="1.8" />
                      <rect x="9" y="13" width="6" height="4"
                            fill="none" stroke="currentColor" stroke-width="1.5" />
                      <circle cx="17" cy="12" r="0.9" fill="currentColor" />
                    </svg>
                  </span>
                  <span>Print</span>
                </button>
              </div>

              <!-- Right: toggles -->
              <div class="flex gap-4 justify-start md:justify-end flex-wrap">

                <div
                  class="toggle"
                  :class="myCoursesOnly ? 'toggle--on' : ''"
                  @click="toggleMyCoursesOnly()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>My Courses</span>
                </div>
              </div>
            </div>
          </div> <!-- .filter-panel -->
        </div>   <!-- #course-filters -->
      </div>     <!-- .filter-state-wrapper -->

      <!-- Grid -->
      <section class="aag-grid-section">
        <div class="yaga-card">
      
          <!-- Sticky column headers ONLY -->
          <div class="yaga-header-sticky" id="aagTableHeader">
            <div class="yaga-grid-header">
              <div class="yaga-hcell yaga-hcell-left">Program List</div>
              <div class="yaga-hcell yaga-hcell-center">Term 1</div>
              <div class="yaga-hcell yaga-hcell-center">Term 2</div>
              <div class="yaga-hcell yaga-hcell-center">Term 3</div>
            </div>
          </div>
      
          <!-- Scroll / body -->
          <div class="yaga-scroll">
            <div class="yaga-grid">
      
              <template x-for="(courseList, subject) in visibleCourseGroups()" :key="subject">
                <div>
                  <div class="yaga-subject" x-text="subject"></div>
      
                  <template x-for="course in courseList" :key="course.id || course.Course || course.title">
                    <div>
                      <!-- course row -->
                      <div class="yaga-row course-row">
                        <div class="yaga-cell">
                          <div class="yaga-title"
                            x-text="(course.shared ? '↔ ' : '') + (course.title || course.Course || '')"></div>
                          <template x-if="course.schedText && course.schedText.trim()">
                            <div class="yaga-sched" x-text="course.schedText"></div>
                          </template>
                        </div>
      
                        <div class="yaga-cell"><div class="yaga-term" x-text="course.term1 || ''"></div></div>
                        <div class="yaga-cell"><div class="yaga-term" x-text="course.term2 || ''"></div></div>
                        <div class="yaga-cell"><div class="yaga-term" x-text="course.term3 || ''"></div></div>
                      </div>
      
                      <!-- topic rows -->
                      <template x-if="course.topics && course.topics.length">
                        <template x-for="topic in visibleTopicsForCourse(course)" :key="topic.id || topic.Topic">
                          <div class="yaga-row topic-row">
                            <div class="yaga-cell">
                              <div class="yaga-title topic"
                                x-text="(topic.shared ? '↔ ' : '') + (topic.Topic || '')"></div>
                              <template x-if="topic.schedText && topic.schedText.trim()">
                                <div class="yaga-sched topic" x-text="topic.schedText"></div>
                              </template>
                            </div>
      
                            <div class="yaga-cell"><div class="yaga-term" x-text="topic.term1 || ''"></div></div>
                            <div class="yaga-cell"><div class="yaga-term" x-text="topic.term2 || ''"></div></div>
                            <div class="yaga-cell"><div class="yaga-term" x-text="topic.term3 || ''"></div></div>
                          </div>
                        </template>
                      </template>
      
                    </div>
                  </template>
                </div>
              </template>
      
            </div>
          </div>
      
        </div>
      </section>

    </div>
  </main>

  <!-- Print Tip Modal (screen-only) -->
  <div
    x-show="printTipOpen"
    x-cloak
    class="print-tip-overlay"
    @keydown.escape.window="closePrintTip()"
  >
    <div class="print-tip-backdrop" @click="closePrintTip()"></div>
  
    <div class="print-tip-modal" role="dialog" aria-modal="true" aria-label="Print tips" @click.stop>
      <div class="print-tip-title">Best print settings</div>
  
      <div class="print-tip-body">
        <p><strong>For the cleanest print/PDF:</strong></p>
        <ul>
          <li>Set <strong>Margins</strong> to <strong>Custom: 0.5"</strong> on all sides</li>
          <li>Turn <strong>Headers and footers</strong> <strong>OFF</strong></li>
        </ul>
      </div>
  
      <label class="print-tip-checkbox">
        <input type="checkbox" x-model="printTipDontShowAgain" />
        Don’t show this again
      </label>
  
      <div class="print-tip-actions">
        <button type="button" class="print-tip-btn" @click="closePrintTip()">Cancel</button>
        <button type="button" class="print-tip-btn print-tip-btn-primary" @click="confirmPrintTipAndPrint()">
          Continue to Print
        </button>
      </div>
    </div>
  </div>

  <script type="module" src="js/auth.js"></script>
  <script src="js/app.js"></script>
  <script src="js/agg.js"></script>

  <!-- ✅ Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Print-only page numbers (Paged.js loads only when printing) -->
  <script>
    // Tell Paged.js: do NOT auto-run on page load
    window.PagedConfig = { auto: false };
  
    function loadPagedJsOnce() {
      return new Promise((resolve, reject) => {
        if (window.PagedPolyfill) return resolve();
        const s = document.createElement("script");
        s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Paged.js"));
        document.head.appendChild(s);
      });
    }
  
    //Print with real page numbers WITHOUT breaking the live app
    // --- helpers ---
    function stripScripts(docEl) {
      docEl.querySelectorAll("script").forEach(s => s.remove());
    }
  
    function closeOpenUi(alpineRoot) {
      try {
        const data = window.Alpine && window.Alpine.$data ? window.Alpine.$data(alpineRoot) : null;
        if (data) {
          data.gradeDropdownOpen = false;
          data.subjectDropdownOpen = false;
          data.tagDropdownOpen = false;
          data.studentDropdownOpen = false;
          data.planningMenuOpen = false;
          data.studentAssignMenuOpen = false;
          data.prepOptionsModalOpen = false;
          data.printTipOpen = false;
        }
      } catch (e) {}
    }
  
    async function loadPagedInto(win) {
      return new Promise((resolve, reject) => {
        if (win.PagedPolyfill) return resolve();
        const s = win.document.createElement("script");
        s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load Paged.js"));
        win.document.head.appendChild(s);
      });
    }
  
    function makeImagesEagerForPrint(win) {
      const imgs = Array.from(win.document.querySelectorAll("img"));
      imgs.forEach(img => {
        img.setAttribute("loading", "eager");
        try { img.loading = "eager"; } catch(e) {}
        img.decoding = "sync";
        img.setAttribute("decoding", "sync");
        try { img.fetchPriority = "high"; } catch(e) {}
        img.setAttribute("fetchpriority", "high");
      });
    }
  
    async function preloadAllImages(win, opts = {}) {
      const timeoutMs = opts.timeoutMs ?? 120000;
      const concurrency = opts.concurrency ?? 8;
  
      const imgs = Array.from(win.document.images || []);
      const srcs = imgs.map(img => img.currentSrc || img.src).filter(Boolean);
      if (!srcs.length) return;
  
      let idx = 0, active = 0, done = 0;
  
      return await new Promise((resolve) => {
        const start = Date.now();
  
        function pump() {
          if (done >= srcs.length) return resolve();
          if (Date.now() - start > timeoutMs) return resolve();
  
          while (active < concurrency && idx < srcs.length) {
            const src = srcs[idx++];
            active++;
  
            const probe = new Image();
            probe.onload = probe.onerror = () => {
              active--;
              done++;
              pump();
            };
            probe.src = src;
          }
        }
  
        pump();
      });
    }
  
    function openPrintWindowWithLoading() {
      // IMPORTANT: must happen synchronously inside the click event (before any awaits)
      const w = window.open("", "_blank", "noopener,noreferrer");
      if (!w) return null;
  
      w.document.open();
      w.document.write(`<!doctype html>
  <html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Preparing print…</title>
    <style>
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fbfbf9;color:#262b26;}
      .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:24px;}
      .card{max-width:560px;width:100%;border:1px solid #e5e8e5;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
      .title{font-weight:650;font-size:16px;margin:0 0 8px}
      .sub{margin:0;opacity:.8;font-size:13px;line-height:1.4}
      .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#596e5e;margin-right:8px;vertical-align:middle}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <p class="title"><span class="dot"></span>Preparing your Book List print…</p>
        <p class="sub">Loading cover images and building page numbers. This window will close automatically after printing.</p>
      </div>
    </div>
  </body>
  </html>`);
      w.document.close();
  
      return w;
    }
  
    function installAutoCloseHandlers(w) {
      function tryClose() { try { w.close(); } catch (e) {} }
  
      // best-case
      try { w.addEventListener("afterprint", tryClose); } catch(e) {}
  
      // very common fallback
      try {
        w.addEventListener("focus", () => setTimeout(tryClose, 400));
      } catch(e) {}
  
      // never leave orphan tabs
      setTimeout(tryClose, 60000);
    };
  </script>

  <!-- =========================
       Floating Video Links (Tutorials only for Course List)
       Desktop: bottom-right box
       Mobile: top-right icon opens modal
  ========================== -->
  <div id="videoLinks" class="av-video-links" aria-live="polite">
  
    <!-- Desktop floating box -->
    <div class="av-video-box" role="region" aria-label="Video links">
      <a class="av-video-row" id="avTutorialsLink" href="#" target="_blank" rel="noopener">
        <span class="av-play-icon" aria-hidden="true">
          <img src="./img/icons/play-button.svg" alt="" />
        </span>
        <span class="av-video-text">Planning App Tutorials</span>
      </a>
    </div>
  
    <!-- Mobile icon launcher -->
    <button class="av-video-mobile-btn" id="avVideoMobileBtn" type="button" aria-label="Open video links">
      <span class="av-play-icon" aria-hidden="true">
        <img src="./img/icons/play-button.svg" alt="" />
      </span>
    </button>
  
    <!-- Mobile modal -->
    <div class="av-video-modal-backdrop" id="avVideoBackdrop" hidden></div>
  
    <div class="av-video-modal" id="avVideoModal" role="dialog" aria-modal="true" aria-label="Video links" hidden>
      <div class="av-video-modal-header">
        <div class="av-video-modal-title">Videos</div>
        <button class="av-video-close" id="avVideoClose" type="button" aria-label="Close videos">✕</button>
      </div>
  
      <div class="av-video-modal-body">
        <a class="av-video-row" id="avTutorialsLinkMobile" href="#" target="_blank" rel="noopener">
          <span class="av-play-icon" aria-hidden="true">
            <img src="./img/icons/play-button.svg" alt="" />
          </span>
          <span class="av-video-text">Planning App Tutorials</span>
        </a>
      </div>
    </div>
  </div>
  
</body>
</html>
