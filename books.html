<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 1. Required basics -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alveary – Book List</title>

  <!-- 2. PWA / App metadata -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#596e5e">

  <!-- iOS support -->
  <link rel="apple-touch-icon" href="./img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- 3. Fonts -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
  />
  
  <!-- 4. CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/books.css">
  <link rel="stylesheet" href="css/print-books.css">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" type="image/png" href="img/Alveary%20Lt.%20Green.png">

</head>

<body class="books-page" x-data="coursePlanner()" x-init="init()">

  <!-- Header -->
  <header class="app-header mb-8 px-6 md:px-16 py-4 md:py-6 flex flex-col md:flex-row md:items-center gap-4">
    <!-- Logo + wordmark -->
    <div class="flex items-center gap-3">
      <img
        src="img/Alveary%20Lt.%20Green.png"
        alt="Alveary logo"
        class="object-contain"
        style="height: 40px; width: 40px;"
      />
      <div class="logo-text-block">
        <span class="logo-title">Alveary</span>

        <!-- PRINT-ONLY: year under Alveary (left) -->
        <span class="print-year-left">2026–2027</span>
      </div>
    </div>

    <!-- Top-right: staff toggle + nav (screen only) -->
    <div class="mt-3 md:mt-0 md:ml-auto flex items-center justify-end gap-6 text-sm">
      <!-- Staff-only: Edit mode (inline, before nav) -->
      <div
        class="toggle"
        x-show="isStaff"
        style="display:none"
        :class="editMode ? 'toggle--on' : ''"
        @click="toggleEditMode()"
      >
        <div class="toggle-switch">
          <div class="toggle-switch-knob"></div>
        </div>
        <span x-text="editMode ? 'Edit Mode' : 'Published'"></span>
      </div>
    
      <!-- navigation tabs -->
      <nav class="flex items-center gap-x-6 text-sm">
        <a href="index.html" class="nav-tab">Course List</a>
        <a href="books.html" class="nav-tab nav-tab-active">Book List</a>
      </nav>
    </div>

    <!-- PRINT-ONLY: Course List + grade/master label on the right -->
    <div class="print-header-title-block">
      <div class="print-header-title">Book List</div>
      <div class="print-header-grade" x-text="gradePrintLabel()"></div>
    </div>
    
  </header>

  <!-- PRINT-ONLY FOOTER -->
  <footer class="print-footer" aria-hidden="true">
    <div class="print-footer-left">Alveary Book List</div>
    <div class="print-footer-center">©2026 Charlotte Mason Institute® All rights reserved.</div>
    <div class="print-footer-right">
      <span class="print-footer-grade" x-text="gradePrintLabel()"></span>
      <span class="print-page-number"></span>
    </div>
  </footer>

  <!-- Main content -->
  <main class="max-w-6xl mx-auto px-6 lg:px-16 pb-16 space-y-10">

    <!-- Book List -->
    <section>
      <h2 class="section-title">Book List</h2>
      <p class="section-subtitle">
        This is the Alveary Book List for Rotation 3.
        Browse books and resources by subject, view rationales for why they were chosen by curriculum experts, and easily tag, note,
        or save your selections for a personalized book list.
      </p>

      <!-- Filter state + panel (both stick under header) -->
      <div class="filter-state-wrapper">
        <!-- Sticky bar -->
        <div class="flex justify-center">
          <div
            class="filter-state-bar"
            x-show="!isLoadingCourses && !loadError"
            x-cloak
            @click="toggleFiltersOpen()"
          >
            <div class="filter-state-main">
              <span class="filter-state-label">Filter by</span>
              <span class="filter-state-summary" x-text="filterSummary"></span>
            </div>
        
            <div class="filter-state-actions">
              <span
                class="filter-state-toggle-text"
                x-text="filtersOpen ? 'Hide' : 'Show'"
              ></span>
            </div>
          </div>
        </div>

        <!-- Sticky panel (only shown when filtersOpen === true) -->
        <div
          class="mt-0 flex justify-center"
          id="course-filters"
          x-show="filtersOpen"
          x-transition
        >
          <div class="filter-panel">
            <div class="filter-grid">
              <!-- Grade -->
              <div class="relative" @click.outside="gradeDropdownOpen = false">
                <button
                  type="button"
                  id="filter-grade"
                  class="filter-control"
                  aria-label="Filter by grade"
                  @click="gradeDropdownOpen = !gradeDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedGrades.length === 0">
                    <span class="filter-placeholder">Grade</span>
                  </template>

                  <!-- chips when grades are selected -->
                  <template x-if="selectedGrades.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="code in selectedGrades" :key="code">
                        <span class="filter-chip">
                          <span x-text="gradeLabelFromCode(code)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeGrade(code)"
                            aria-label="Remove grade"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>

                  <span
                    class="filter-chevron"
                    :class="gradeDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>

                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="gradeDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in gradeOptions" :key="opt.code">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleGrade(opt.code)"
                    >
                      <span x-text="opt.label"></span>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedGrades.includes(opt.code)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Subject -->
              <div class="relative" @click.outside="subjectDropdownOpen = false">
                <button
                  type="button"
                  id="filter-subject"
                  class="filter-control"
                  aria-label="Filter by subject"
                  @click="subjectDropdownOpen = !subjectDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedSubjects.length === 0">
                    <span class="filter-placeholder">Subject</span>
                  </template>
              
                  <!-- chips when subjects are selected -->
                  <template x-if="selectedSubjects.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="subj in selectedSubjects" :key="subj">
                        <span
                          class="filter-chip"
                          :style="`background-color: ${subjectColor(subj)}4D;`"
                        >
                          <span x-text="subj"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeSubject(subj)"
                            aria-label="Remove subject"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="subjectDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="subjectDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in subjectOptions" :key="opt">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleSubject(opt)"
                    >
                      <span x-text="opt"></span>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedSubjects.includes(opt)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Tags -->
              <div class="relative" @click.outside="tagDropdownOpen = false">
                <button
                  type="button"
                  id="filter-tags"
                  class="filter-control"
                  aria-label="Filter by planning tag"
                  @click="tagDropdownOpen = !tagDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="selectedTags.length === 0">
                    <span class="filter-placeholder">Planning tag</span>
                  </template>
              
                  <!-- chips when tags are selected -->
                  <template x-if="selectedTags.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="tagId in selectedTags" :key="tagId">
                        <span class="filter-chip">
                          <span x-text="planningTagLabel(tagId)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeSelectedTag(tagId)"
                            aria-label="Remove tag"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="tagDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div
                  class="filter-dropdown"
                  x-show="tagDropdownOpen"
                  x-transition
                >
                  <template x-for="opt in planningTagOptions" :key="opt.id">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleSelectedTag(opt.id)"
                    >
                      <div class="planning-tag-option-main">
                        <img
                          :src="opt.img"
                          :alt="opt.label"
                        />
                        <span x-text="opt.label"></span>
                      </div>
                      <span
                        class="filter-dropdown-check"
                        x-show="selectedTags.includes(opt.id)"
                      >
                        ✓
                      </span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Search -->
              <div>
                <div class="filter-control" aria-label="Search courses or topics">
                  <input
                    id="filter-search"
                    type="search"
                    placeholder="Search"
                    autocomplete="off"
                    x-model="searchQuery"
                    @input="applyFilters()"
                  />
                  <span class="search-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <circle
                        cx="11"
                        cy="11"
                        r="6.5"
                        stroke="currentColor"
                        stroke-width="1.8"
                        fill="none"
                      />
                      <line
                        x1="15"
                        y1="15"
                        x2="20"
                        y2="20"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                      />
                    </svg>
                  </span>
                </div>
              </div>
            </div>


            <!-- Students: manage + filter -->
            <div class="student-tools-row" @click.stop>
              <!-- Student (multi-select, chip-style like other filters) -->
              <div class="relative" @click.outside="studentDropdownOpen = false">
                <button
                  type="button"
                  id="filter-student"
                  class="filter-control"
                  aria-label="Filter by student"
                  @click="studentDropdownOpen = !studentDropdownOpen"
                >
                  <!-- placeholder when nothing selected -->
                  <template x-if="!selectedStudents || selectedStudents.length === 0">
                    <span class="filter-placeholder">Students</span>
                  </template>
              
                  <!-- chips when students are selected -->
                  <template x-if="selectedStudents && selectedStudents.length > 0">
                    <div class="filter-control-chips">
                      <template x-for="sid in selectedStudents" :key="sid">
                        <span
                            class="filter-chip"
                            :class="sid === '__any__' ? 'filter-chip--any-student' : 'filter-chip--student'"
                            :style="sid === '__any__' ? '' : `background-color:${studentColorFromId(sid)};`"
                          >
                          <span x-text="studentNameFromId(sid)"></span>
                          <button
                            type="button"
                            class="filter-chip-remove"
                            @click.stop="removeStudentFilter(sid)"
                            aria-label="Remove student"
                          >
                            ×
                          </button>
                        </span>
                      </template>
                    </div>
                  </template>
              
                  <span
                    class="filter-chevron"
                    :class="studentDropdownOpen ? 'filter-chevron-open' : ''"
                    aria-hidden="true"
                  >
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M6 9l6 6 6-6"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
              
                <!-- dropdown menu -->
                <div class="filter-dropdown" x-show="studentDropdownOpen" x-transition>
                  <button
                    type="button"
                    class="filter-dropdown-item"
                    @click="toggleStudentFilter('__any__')"
                  >
                    <span class="student-dd-row">
                      <span class="student-dd-swatch" style="background-color:#f4f6fa; border-color:#dde2d5" aria-hidden="true"></span>
                      <span>All Students</span>
                    </span>
                  
                    <span class="filter-dropdown-check" x-show="selectedStudents.includes('__any__')">✓</span>
                  </button>
                  <template x-for="s in students" :key="s.id">
                    <button
                      type="button"
                      class="filter-dropdown-item"
                      @click="toggleStudentFilter(s.id)"
                    >
                      <span class="student-dd-row">
                        <span
                          class="student-dd-swatch"
                          :style="`background-color:${s.color || '#596e5e'}`"
                          aria-hidden="true"
                        ></span>
                        <span x-text="s.name || 'Unnamed'"></span>
                      </span>
                  
                      <span class="filter-dropdown-check" x-show="selectedStudents.includes(s.id)">✓</span>
                    </button>
                  </template>
                </div>
              </div>

              <button
                type="button"
                class="manage-students-toggle"
                @click.stop="toggleStudentsOpen()"
                :aria-expanded="studentsOpen ? 'true' : 'false'"
              >
                Manage Students
              </button>
            </div>

            <div
              class="student-manager"
              x-show="studentsOpen"
              x-transition
              x-cloak
              @click.stop
            >
              <p class="student-manager-help">
                Add up to 15 students. Click color buttons to change student colors.
              </p>

              <div class="student-list">
                <template x-for="s in students" :key="s.id">
                  <div>
                    <div class="student-row">
                      <!-- Color square (click to open swatches) -->
                      <button
                        type="button"
                        class="student-color-btn"
                        :style="{ backgroundColor: s.color }"
                        @click.stop="toggleStudentColorPicker(s.id)"
                        aria-label="Choose student color"
                        title="Choose color"
                      ></button>
                    
                      <input
                        class="student-name-input"
                        type="text"
                        placeholder="Student name"
                        :value="s.name"
                        @input="updateStudentName(s.id, $event.target.value)"
                      />
                    
                      <!-- Subtle X remove -->
                      <button
                        type="button"
                        class="student-remove-x"
                        @click.stop="removeStudent(s.id)"
                        aria-label="Remove student"
                        title="Remove"
                      >×</button>
                    </div>

                    <div class="student-swatches" x-show="colorPickerFor === s.id" x-transition>
                      <template x-for="c in studentColorPalette" :key="c">
                        <button
                          type="button"
                          class="student-swatch"
                          :class="s.color === c ? 'student-swatch--selected' : ''"
                          :style="{ backgroundColor: c }"
                          @click="setStudentColor(s.id, c)"
                          :aria-label="`Set color ${c}`"
                          title="Set color"
                        ></button>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="student-add-row">
                <input
                  class="student-name-input"
                  type="text"
                  placeholder="Add a student…"
                  x-model="newStudentName"
                  @keydown.enter.prevent="addStudent()"
                />
                <button
                  type="button"
                  class="student-row-btn"
                  @click="addStudent()"
                  :disabled="!canAddStudent"
                >Add</button>
              </div>
            </div>

            <div class="filter-actions">
              <!-- Left: clear + print buttons -->
              <div class="flex gap-2">
                <button
                  type="button"
                  class="btn-pill"
                  @click="clearAllBookmarks()"
                >
                  <span class="btn-pill-icon bookmark-reset" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <!-- bookmark outline -->
                      <path d="M7 5h10v14l-5-3-5 3V5z"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.8"
                            stroke-linejoin="round" />
                      <!-- X inside bookmark -->
                      <line x1="9" y1="9" x2="15" y2="15"
                            stroke="currentColor"
                            stroke-width="1.8"
                            stroke-linecap="round" />
                      <line x1="15" y1="9" x2="9" y2="15"
                            stroke="currentColor"
                            stroke-width="1.8"
                            stroke-linecap="round" />
                    </svg>
                  </span>
                  <span>Clear bookmarks</span>
                </button>

                <button
                  type="button"
                  class="btn-pill btn-secondary print-btn"
                  @click="openPrintTip()"
                >
                  <span class="btn-pill-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="9" width="14" height="9" rx="1.5" ry="1.5"
                            fill="none" stroke="currentColor" stroke-width="1.8" />
                      <path d="M8 9V5h8v4"
                            fill="none" stroke="currentColor" stroke-width="1.8" />
                      <rect x="9" y="13" width="6" height="4"
                            fill="none" stroke="currentColor" stroke-width="1.5" />
                      <circle cx="17" cy="12" r="0.9" fill="currentColor" />
                    </svg>
                  </span>
                  <span>Print</span>
                </button>
              </div>

              <!-- Right: toggles -->
              <div class="flex gap-4 justify-start md:justify-end flex-wrap">
                <div
                  class="toggle"
                  :class="showAllDetails ? 'toggle--on' : ''"
                  @click="toggleAllDetails()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>Descriptions &amp; Tips</span>
                </div>

                <div
                  class="toggle"
                  :class="myCoursesOnly ? 'toggle--on' : ''"
                  @click="toggleMyCoursesOnly()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>My Courses</span>
                </div>
                <div
                  class="toggle"
                  :class="myNotesOpen ? 'toggle--on' : ''"
                  @click="toggleMyNotes()"
                >
                  <div class="toggle-switch">
                    <div class="toggle-switch-knob"></div>
                  </div>
                  <span>My Notes</span>
                </div>
              </div>
            </div>
          </div> <!-- .filter-panel -->
        </div>   <!-- #course-filters -->
      </div>     <!-- .filter-state-wrapper -->

      <!-- Dynamic course list -->
      <div class="course-list-shell mt-10">
      
        <!-- Loading & error states -->
        <p x-show="isLoadingCourses" class="text-sm text-muted">Loading courses…</p>
        <p x-show="!isLoadingCourses && loadError" class="text-sm text-red-600" x-text="loadError"></p>
      
        <!-- Subjects, courses, and topics -->
        <template x-if="!isLoadingCourses && !loadError">
          <div>
            <template x-for="(courseGroup, subjectName) in visibleCourseGroups()" :key="subjectName">
              <section
                class="subject-block"
                :class="'subject--' + subjectName.toLowerCase().replace(/[^a-z0-9]+/g, '-')"
              >
                <h3 class="subject-title" x-text="subjectName"></h3>
      
                <div class="subject-courses">
                  <template x-for="course in courseGroup" :key="course.recordID || course.id">
                    <article class="course-card" :style="`border-color: ${subjectColor(course.subject)}`">
                      <!-- Title row with bookmark (for topic-less courses) + chevron -->
                      <div class="card-header">
                        <div class="title-with-edit">
                          <h4 class="course-title" x-text="course.course_title || course.title || course.Course || 'Untitled course'"></h4>
                            <a
                              class="edit-pill"
                              x-show="isStaff && editMode && (course.Edit_ResourceAssignmentsURL || _editUrlForTargetId(course.recordID || course.id))"
                              x-cloak
                              :href="course.Edit_ResourceAssignmentsURL || _editUrlForTargetId(course.recordID || course.id)"
                              target="_blank"
                              rel="noopener"
                              @click.stop
                            >Edit ↗</a>
                      
                        </div>
                      
                        <div class="card-header-actions">
                          <!-- Course notes (only for courses with NO topics) -->
                          <template x-if="!course.topics || course.topics.length === 0">
                              <button
                                type="button"
                                class="note-btn"
                                :class="{
                                  'note-btn--empty': !hasCourseNote(course),
                                  'note-btn--soft':  hasCourseNote(course) && !isCourseBookmarked(course),
                                  'note-btn--strong': hasCourseNote(course) && isCourseBookmarked(course),
                                }"
                                :style="hasCourseNote(course) && isCourseBookmarked(course)
                                  ? {
                                      backgroundColor: subjectColor(course.subject) + '4D',
                                      borderColor: subjectColor(course.subject),
                                      color: subjectColor(course.subject),
                                    }
                                  : {}"
                                @click.stop="toggleCourseNoteOpen(course)"
                                aria-label="Toggle course notes"
                              >
                              <!-- pencil icon -->
                              <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                  d="M4 17.5V20h2.5L17 9.5 14.5 7 4 17.5z"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                                <path
                                  d="M15.5 5.5L18 8"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                              </svg>
                            </button>
                          </template>
                          <!-- Course bookmark (Book List = show only when active) -->
                          <template x-if="(!course.topics || course.topics.length === 0) && isCourseBookmarked(course)">
                            <span class="bookmark-region">
                              <button
                                type="button"
                                class="bookmark-btn bookmark-btn--solid"
                                :style="{ backgroundColor: subjectColor(course.subject) }"
                                @click.stop
                                aria-label="Bookmarked"
                                title="Bookmarked (edit on Course List)"
                              >
                                <img src="img/icons/bookmark-active.svg" alt="" class="bookmark-icon" />
                              </button>
                            </span>
                          </template>

                          <!-- Quickmark: bookmark all topics in this course -->
                          <template x-if="course.topics && course.topics.length && allTopicsBookmarked(course)">
                            <div class="quick-enroll-wrapper">
                              
                              <!-- BUTTON -->
                              <button
                                type="button"
                                class="quick-enroll-btn"
                                :class="allTopicsBookmarked(course) ? 'quick-enroll-btn--active' : ''"
                                :style="allTopicsBookmarked(course)
                                  ? {
                                      backgroundColor: subjectColor(course.subject) + '4D',
                                      borderColor: subjectColor(course.subject),
                                      color: subjectColor(course.subject),
                                    }
                                  : {}"
                                @click.stop="toggleAllTopicsBookmark(course)"
                                aria-label="Enroll all topics in this course"
                              >
                                <!-- bookmark icon -->
                                <img
                                  :src="allTopicsBookmarked(course)
                                    ? 'img/icons/bookmark-active.svg'
                                    : 'img/icons/bookmark-muted.svg'"
                                  alt=""
                                  class="bookmark-icon"
                                />
                          
                                <!-- unselected chip -->
                                <template x-if="!allTopicsBookmarked(course)">
                                  <span class="quick-chip">+</span>
                                </template>
                              </button>
                          
                              <!-- LABEL BELOW BUTTON -->
                              <div
                                class="quick-enroll-label"
                                :class="allTopicsBookmarked(course) ? 'quick-enroll-label--active' : ''"
                                :style="allTopicsBookmarked(course)
                                  ? { backgroundColor: subjectColor(course.subject) }
                                  : {}"
                              >
                                <span x-text="allTopicsBookmarked(course) ? 'All' : '+All'"></span>
                              </div>
                          
                            </div>
                          </template>
                        
                          <!-- Chevron only if description or tips exist -->
                          <template x-if="(course.description && course.description.trim()) || (course.tips && course.tips.trim())">
                            <button
                              type="button"
                              class="card-toggle"
                              :class="course.detailsOpen ? '' : 'card-toggle--closed'"
                              @click="course.detailsOpen = !course.detailsOpen"
                              aria-label="Toggle course details"
                            >
                              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path
                                  d="M6 9l6 6 6-6"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="1.8"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                              </svg>
                            </button>
                          </template>
                        </div>
                      </div>
                    
                      <!-- grade + schedule line -->
                      <p
                        class="course-meta"
                        x-show="course.gradeText || course.schedText"
                      >
                        <!-- left: schedule (if any) -->
                        <template x-if="course.schedText">
                          <span
                            class="meta-schedule"
                            :class="course.gradeText ? 'meta-schedule--with-grade' : 'meta-schedule--solo'"
                            x-text="course.schedText"
                          ></span>
                        </template>
                      
                        <!-- middle: grade (if any) -->
                        <template x-if="course.gradeText">
                          <span
                            :class="course.schedText ? 'meta-grade meta-grade--with-sched' : 'meta-grade meta-grade--solo'"
                            x-text="course.gradeText"
                          ></span>
                        </template>
                      
                        <!-- spacer pushes planning tag area to far right -->
                        <span class="meta-flex-spacer"></span>

                        <!-- right: planning tag UI (courses *without* topics only) -->
                        <template x-if="!course.topics || course.topics.length === 0">
                          <span class="planning-tag-region">
                            <!-- If no tags yet: show "+ Planning tag" button -->
                            <template x-if="!course.planningTags || course.planningTags.length === 0">
                              <button
                                type="button"
                                class="planning-tag-button"
                                aria-label="Add planning tag to course"
                                @click.stop="openPlanningMenu($event, course)"
                              >
                                <span class="planning-tag-label">+ Planning tag</span>
                              </button>
                            </template>

                            <!-- If tags exist: show images + small "+" square -->
                            <template x-if="course.planningTags && course.planningTags.length > 0">
                              <div class="planning-tag-selected-row">
                                <template x-for="tag in course.planningTags" :key="tag.id">
                                  <div class="planning-tag-pill">
                                    <img
                                      class="planning-tag-img"
                                      :src="tag.img"
                                      :alt="tag.label"
                                    />
                                    <button
                                      type="button"
                                      class="planning-tag-remove"
                                      @click.stop="removePlanningTag(course, tag.id)"
                                      aria-label="Remove planning tag"
                                    >
                                      ×
                                    </button>
                                  </div>
                                </template>

                                <button
                                  type="button"
                                  class="planning-tag-add"
                                  aria-label="Add more planning tags"
                                  @click.stop="openPlanningMenu($event, course)"
                                >
                                  +
                                </button>
                              </div>
                            </template>
                          </span>
                        </template>
                      </p>
                    
                      <!-- Resource cards (course-level) -->
                      <div
                        class="resource-list"
                        x-show="(assignmentsByTargetId[(course.recordID || course.id)] || []).length"
                      >
                        <template
                          x-for="a in (assignmentsByTargetId[(course.recordID || course.id)] || [])"
                          :key="'rc-' + a.assignmentId"
                        >
                          <div class="resource-card">
                            <div class="resource-card-badges">
                              <span
                                class="resource-badge resource-badge--grade"
                                x-show="a.gradeLevelTag"
                                x-text="a.gradeLevelTag"
                                x-cloak
                              ></span>
                              <span class="resource-badge resource-badge--optional"
                                    x-show="isOptionalAssignment(a)" x-cloak>Optional</span>
                            
                              <span class="resource-badge resource-badge--choose-one"
                                    x-show="isChooseOneAssignment(a)" x-cloak>Choose one</span>
                            </div>
                            <!-- left: image -->
                            <div class="resource-media">
                              <div class="resource-img-wrap">
                                <img class="resource-img"
                                  :src="localCoverPath(a.resourceId)"
                                  :alt="resourcesById[a.resourceId]?.title || 'Resource image'"
                                  loading="lazy"
                                  @error="
                                    if ($event.target.dataset.fallback !== 'placeholder') {
                                      $event.target.dataset.fallback = 'placeholder';
                                      $event.target.src = 'img/placeholders/book.svg';
                                    } else {
                                      $event.target.style.display='none';
                                    }
                                  ">
                              </div>
                            
                              <template x-if="altFormatsForAssignment(a).length">
                                <div class="alt-formats" x-cloak>
                                  <div class="alt-formats-title">Alt. Format</div>
                                  <div class="alt-formats-pills">
                                    <template x-for="fmt in altFormatsForAssignment(a)" :key="fmt">
                                      <span class="alt-format-pill"
                                            :class="'alt-format-pill--' + fmt.toLowerCase()"
                                            x-text="fmt"></span>
                                    </template>
                                  </div>
                                </div>
                              </template>
                            </div>
                          
                            <!-- right: text -->
                            <div class="resource-body">
                              <div class="resource-top-row">

                              <!-- LEFT (wide): title + author/isbn/reference + section -->
                              <div class="resource-top-left">
                            
                                <div class="resource-title-row">
                                  <div
                                    class="resource-title"
                                    x-text="resourcesById[a.resourceId]?.title || 'Untitled resource'"
                                  ></div>
                            
                                  <a
                                    class="edit-pill resource-edit-pill"
                                    x-show="isStaff && editMode && resourcesById[a.resourceId]?.bookEditUrl"
                                    x-cloak
                                    :href="resourcesById[a.resourceId]?.bookEditUrl"
                                    target="_blank"
                                    rel="noopener"
                                    @click.stop
                                  >Edit ↗</a>
                                </div>
                            
                                <div class="resource-subline">
                                  <span
                                    class="resource-author"
                                    x-show="resourcesById[a.resourceId]?.author"
                                    x-text="resourcesById[a.resourceId]?.author ? ('by ' + resourcesById[a.resourceId].author) : ''"
                                  ></span>
                            
                                  <span
                                    class="resource-isbn"
                                    x-show="resourcesById[a.resourceId]?.isbnAsin"
                                    x-text="resourcesById[a.resourceId]?.isbnAsin ? ('ISBN/ASIN: ' + resourcesById[a.resourceId].isbnAsin) : ''"
                                  ></span>
                            
                                  <span
                                    class="resource-reference"
                                    x-show="resourcesById[a.resourceId]?.flags?.reference"
                                    x-cloak
                                  >✓REFERENCE</span>
                                </div>
                            
                              </div>
                            
                              <!-- invisible divider (keeps spacing aligned with bottom section) -->
                              <div class="resource-top-divider" aria-hidden="true"></div>
                            
                              <!-- RIGHT: purchase buttons (scope col) + planning buttons (shared col) -->
                              <div class="resource-top-right">
                            
                                <!-- Purchase buttons area (aligns above SCOPE column) -->
                                <div class="resource-top-scope">
                                  <!-- Placeholder for now -->
                                  <div class="resource-top-actions-label">Buy</div>
                                  <div class="resource-buy-row">
                                    <!-- buttons will go here later -->
                                  </div>
                                </div>
                            
                                <!-- Planning buttons area (aligns above SHARED column) -->
                                <div class="resource-top-shared">
                                  <!-- Placeholder for now -->
                                  <div class="resource-top-actions-label">Plan</div>
                                  <div class="resource-plan-row">
                                    <!-- buttons will go here later -->
                                  </div>
                                </div>
                            
                              </div>
                            </div>
                              
                              <div class="resource-info-row">
                              <!-- LEFT (wide): rationale + note/may sub -->
                              <div class="resource-info-left">
                            
                                <!-- RATIONALE -->
                                <div
                                  class="resource-rationale"
                                  x-show="resourcesById[a.resourceId]?.rationale || resourcesById[a.resourceId]?.RATIONALE"
                                  x-cloak
                                >
                                  <span class="resource-rationale-label">➜ RATIONALE:</span>
                                  <span
                                    class="resource-rationale-text"
                                    x-text="
                                      resourcesById[a.resourceId]?.rationale ||
                                      resourcesById[a.resourceId]?.RATIONALE
                                    "
                                  ></span>
                                </div>
                            
                                <!-- NOTE + May sub (single box; NOTE first) -->
                                <div
                                  class="resource-tipbox"
                                  x-show="resourcesById[a.resourceId]?.note || resourcesById[a.resourceId]?.maySub"
                                  x-cloak
                                >
                                  <template x-if="resourcesById[a.resourceId]?.note">
                                    <div class="resource-tipbox-item">
                                      <span class="resource-tipbox-label">NOTE:</span>
                                      <span class="resource-tipbox-text" x-text="resourcesById[a.resourceId]?.note"></span>
                                    </div>
                                  </template>
                            
                                  <template x-if="resourcesById[a.resourceId]?.maySub">
                                    <div class="resource-tipbox-item">
                                      <span class="resource-tipbox-label">➜ May sub:</span>
                                      <span class="resource-tipbox-text" x-text="resourcesById[a.resourceId]?.maySub"></span>
                                    </div>
                                  </template>
                                </div>
                            
                              </div>
                            
                              <!-- DIVIDER -->
                              <div class="resource-info-divider" aria-hidden="true"></div>
                            
                              <!-- RIGHT (narrow): shared + scope from assignment -->
                              <div class="resource-info-right">
                            
                                <div class="resource-meta-block" x-show="assignmentSharedR3Text(a)" x-cloak>
                                  <div class="resource-meta-label">↔ Shared</div>
                                  <div class="resource-meta-text" x-text="assignmentSharedR3Text(a)"></div>
                                </div>
                            
                                <div class="resource-meta-block" x-show="assignmentScopeText(a)" x-cloak>
                                  <div class="resource-meta-label">Scope</div>
                                  <div class="resource-meta-text" x-text="assignmentScopeText(a)"></div>
                                </div>
                            
                              </div>
                            </div>

                            </div>
                          </div>
                          
                        </template>
                      </div>
      
                      <!-- Nested topics (titles only for now) -->
                      <div class="topic-list" x-show="visibleTopicsForCourse(course).length">
                        <template x-for="topic in visibleTopicsForCourse(course)" :key="topic.recordID">
                          <article class="topic-card">
                            <!-- Title row with chevron -->
                            <div class="card-header">
                              <div class="title-with-edit">
                                <h5 class="topic-title" x-text="topic.Topic"></h5>
                                 <a
                                  class="edit-pill"
                                  x-show="isStaff && editMode && (topic.Edit_ResourceAssignmentsURL || _editUrlForTargetId(topic.recordID || topic.id))"
                                  x-cloak
                                  :href="topic.Edit_ResourceAssignmentsURL || _editUrlForTargetId(topic.recordID || topic.id)"
                                  target="_blank"
                                  rel="noopener"
                                  @click.stop
                                >Edit ↗</a>
 
                              </div>
                            
                              <div class="card-header-actions">
                                <!-- Topic notes button -->
                                <button
                                    type="button"
                                    class="note-btn"
                                    :class="{
                                      'note-btn--empty': !hasTopicNote(topic),
                                      'note-btn--soft':  hasTopicNote(topic) && !isTopicBookmarked(topic),
                                      'note-btn--strong': hasTopicNote(topic) && isTopicBookmarked(topic),
                                    }"
                                    :style="hasTopicNote(topic) && isTopicBookmarked(topic)
                                      ? {
                                          backgroundColor: subjectColor(course.subject) + '4D',
                                          borderColor: subjectColor(course.subject),
                                          color: subjectColor(course.subject),
                                        }
                                      : {}"
                                    @click.stop="toggleTopicNoteOpen(topic)"
                                    aria-label="Toggle topic notes"
                                  >
                                  <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path
                                      d="M4 17.5V20h2.5L17 9.5 14.5 7 4 17.5z"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.6"
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                    />
                                    <path
                                      d="M15.5 5.5L18 8"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="1.6"
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                    />
                                  </svg>
                                </button>
                                <!-- topic bookmark (My courses) -->
                                <span class="bookmark-region">
                                  <template x-if="isTopicBookmarked(topic)">
                                    <button
                                      type="button"
                                      class="bookmark-btn bookmark-btn--solid"
                                      :style="{ backgroundColor: subjectColor(course.subject) }"
                                      @click.stop
                                      aria-label="Bookmarked"
                                      title="Bookmarked (edit on Course List)"
                                    >
                                      <img src="img/icons/bookmark-active.svg" alt="" class="bookmark-icon" />
                                    </button>
                                  </template>
                                </span>
                            
                                <!-- Chevron only if description or tips exist -->
                                <template x-if="(topic.description && topic.description.trim()) || (topic.tips && topic.tips.trim())">
                                  <button
                                    type="button"
                                    class="card-toggle"
                                    :class="topic.detailsOpen ? '' : 'card-toggle--closed'"
                                    @click="topic.detailsOpen = !topic.detailsOpen"
                                    aria-label="Toggle topic details"
                                  >
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                      <path
                                        d="M6 9l6 6 6-6"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.8"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                      />
                                    </svg>
                                  </button>
                                </template>
                              </div>
                            </div>
                          
                              <p
                                class="course-meta topic-meta"
                                x-show="topic.gradeText || topic.schedText"
                              >
                                <!-- left: schedule -->
                                <template x-if="topic.schedText">
                                  <span
                                    class="meta-schedule"
                                    :class="topic.gradeText ? 'meta-schedule--with-grade' : 'meta-schedule--solo'"
                                    x-text="topic.schedText"
                                  ></span>
                                </template>
                              
                                <!-- middle: grade -->
                                <template x-if="topic.gradeText">
                                  <span
                                    :class="topic.schedText ? 'meta-grade meta-grade--with-sched' : 'meta-grade meta-grade--solo'"
                                    x-text="topic.gradeText"
                                  ></span>
                                </template>
                              
                                <!-- spacer pushes controls to the right -->
                                <span class="meta-flex-spacer"></span>
                              
                                <!-- right: planning tag UI (topics always can have tags) -->
                                <span class="planning-tag-region">
                                  <!-- No tags yet -->
                                  <template x-if="!topic.planningTags || topic.planningTags.length === 0">
                                    <button
                                      type="button"
                                      class="planning-tag-button"
                                      aria-label="Add planning tag to topic"
                                      @click.stop="openPlanningMenu($event, topic)"
                                    >
                                      <span class="planning-tag-label">+ Planning tag</span>
                                    </button>
                                  </template>
                              
                                  <!-- Tags selected -->
                                  <template x-if="topic.planningTags && topic.planningTags.length > 0">
                                    <div class="planning-tag-selected-row">
                                      <template x-for="tag in topic.planningTags" :key="tag.id">
                                        <div class="planning-tag-pill">
                                          <img
                                            class="planning-tag-img"
                                            :src="tag.img"
                                            :alt="tag.label"
                                          />
                                          <button
                                            type="button"
                                            class="planning-tag-remove"
                                            @click.stop="removePlanningTag(topic, tag.id)"
                                            aria-label="Remove planning tag"
                                          >
                                            ×
                                          </button>
                                        </div>
                                      </template>
                              
                                      <button
                                        type="button"
                                        class="planning-tag-add"
                                        aria-label="Add more planning tags"
                                        @click.stop="openPlanningMenu($event, topic)"
                                      >
                                        +
                                      </button>
                                    </div>
                                  </template>
                              
                                  <!-- Ghost tags from previous use of this topic elsewhere -->
                                  <template x-if="missingGlobalTagsForTopic(topic).length > 0">
                                    <div class="planning-tag-selected-row">
                                      <template
                                        x-for="tagId in missingGlobalTagsForTopic(topic)"
                                        :key="'ghost-' + tagId"
                                      >
                                        <div class="planning-tag-pill planning-tag-pill--ghost">
                                          <img
                                            class="planning-tag-img planning-tag-img-ghost"
                                            :src="planningTagImage(tagId)"
                                            :alt="planningTagLabel(tagId)"
                                          />
                                          <button
                                            type="button"
                                            class="planning-tag-apply"
                                            @click.stop="applyGlobalTagToTopic(topic, tagId)"
                                            :aria-label="`Apply ${planningTagLabel(tagId)} here`"
                                            title="Add previous tag"
                                          >
                                            +
                                          </button>
                                        </div>
                                      </template>
                                    </div>
                                  </template>
                                </span>
                              </p>

                            <!-- Resource cards (topic-level) -->
                            <div
                              class="resource-list"
                              x-show="(assignmentsByTargetId[(topic.recordID || topic.id)] || []).length"
                            >
                              <template
                                x-for="a in (assignmentsByTargetId[(topic.recordID || topic.id)] || [])"
                                :key="'rt-' + a.assignmentId"
                              >
                                <div class="resource-card">
                                  <div class="resource-card-badges">
                                    <span
                                      class="resource-badge resource-badge--grade"
                                      x-show="a.gradeLevelTag"
                                      x-text="a.gradeLevelTag"
                                      x-cloak
                                    ></span>
                                    <span class="resource-badge resource-badge--optional"
                                          x-show="isOptionalAssignment(a)" x-cloak>Optional</span>
                                  
                                    <span class="resource-badge resource-badge--choose-one"
                                          x-show="isChooseOneAssignment(a)" x-cloak>Choose one</span>
                                  </div>

                                  <!-- left: image -->
                                  <div class="resource-media">
                                    <div class="resource-img-wrap">
                                      <img class="resource-img"
                                        :src="localCoverPath(a.resourceId)"
                                        :alt="resourcesById[a.resourceId]?.title || 'Resource image'"
                                        loading="lazy"
                                        @error="
                                          if ($event.target.dataset.fallback !== 'placeholder') {
                                            $event.target.dataset.fallback = 'placeholder';
                                            $event.target.src = 'img/placeholders/book.svg';
                                          } else {
                                            $event.target.style.display='none';
                                          }
                                        ">
                                    </div>
                                  
                                    <template x-if="altFormatsForAssignment(a).length">
                                      <div class="alt-formats" x-cloak>
                                        <div class="alt-formats-title">Alt. Formats:</div>
                                        <div class="alt-formats-pills">
                                          <template x-for="fmt in altFormatsForAssignment(a)" :key="fmt">
                                            <span class="alt-format-pill"
                                                  :class="'alt-format-pill--' + fmt.toLowerCase()"
                                                  x-text="fmt"></span>
                                          </template>
                                        </div>
                                      </div>
                                    </template>
                                  </div>
                                
                                  <!-- right: text -->
                                  <div class="resource-body">
                                    <div class="resource-top-row">

                                    <!-- LEFT (wide): title + author/isbn/reference + section -->
                                    <div class="resource-top-left">
                                  
                                      <div class="resource-title-row">
                                        <div
                                          class="resource-title"
                                          x-text="resourcesById[a.resourceId]?.title || 'Untitled resource'"
                                        ></div>
                                  
                                        <a
                                          class="edit-pill resource-edit-pill"
                                          x-show="isStaff && editMode && resourcesById[a.resourceId]?.bookEditUrl"
                                          x-cloak
                                          :href="resourcesById[a.resourceId]?.bookEditUrl"
                                          target="_blank"
                                          rel="noopener"
                                          @click.stop
                                        >Edit ↗</a>
                                      </div>
                                  
                                      <div class="resource-subline">
                                        <span
                                          class="resource-author"
                                          x-show="resourcesById[a.resourceId]?.author"
                                          x-text="resourcesById[a.resourceId]?.author ? ('by ' + resourcesById[a.resourceId].author) : ''"
                                        ></span>
                                  
                                        <span
                                          class="resource-isbn"
                                          x-show="resourcesById[a.resourceId]?.isbnAsin"
                                          x-text="resourcesById[a.resourceId]?.isbnAsin ? ('ISBN/ASIN: ' + resourcesById[a.resourceId].isbnAsin) : ''"
                                        ></span>
                                  
                                        <span
                                          class="resource-reference"
                                          x-show="resourcesById[a.resourceId]?.flags?.reference"
                                          x-cloak
                                        >✓REFERENCE</span>
                                      </div>
                                  
                                    </div>
                                  
                                    <!-- invisible divider (keeps spacing aligned with bottom section) -->
                                    <div class="resource-top-divider" aria-hidden="true"></div>
                                  
                                    <!-- RIGHT: purchase buttons (scope col) + planning buttons (shared col) -->
                                    <div class="resource-top-right">
                                  
                                      <!-- Purchase buttons area (aligns above SCOPE column) -->
                                      <div class="resource-top-scope">
                                        <!-- Placeholder for now -->
                                        <div class="resource-top-actions-label">Buy</div>
                                        <div class="resource-buy-row">
                                          <!-- buttons will go here later -->
                                        </div>
                                      </div>
                                  
                                      <!-- Planning buttons area (aligns above SHARED column) -->
                                      <div class="resource-top-shared">
                                        <!-- Placeholder for now -->
                                        <div class="resource-top-actions-label">Plan</div>
                                        <div class="resource-plan-row">
                                          <!-- buttons will go here later -->
                                        </div>
                                      </div>
                                  
                                    </div>
                                  </div>

                                    <div class="resource-info-row">
                                    <!-- LEFT (wide): rationale + note/may sub -->
                                    <div class="resource-info-left">
                                  
                                      <!-- RATIONALE -->
                                      <div
                                        class="resource-rationale"
                                        x-show="resourcesById[a.resourceId]?.rationale || resourcesById[a.resourceId]?.RATIONALE"
                                        x-cloak
                                      >
                                        <span class="resource-rationale-label">➜ RATIONALE:</span>
                                        <span
                                          class="resource-rationale-text"
                                          x-text="
                                            resourcesById[a.resourceId]?.rationale ||
                                            resourcesById[a.resourceId]?.RATIONALE
                                          "
                                        ></span>
                                      </div>
                                  
                                      <!-- NOTE + May sub (single box; NOTE first) -->
                                      <div
                                        class="resource-tipbox"
                                        x-show="resourcesById[a.resourceId]?.note || resourcesById[a.resourceId]?.maySub"
                                        x-cloak
                                      >
                                        <template x-if="resourcesById[a.resourceId]?.note">
                                          <div class="resource-tipbox-item">
                                            <span class="resource-tipbox-label">NOTE:</span>
                                            <span class="resource-tipbox-text" x-text="resourcesById[a.resourceId]?.note"></span>
                                          </div>
                                        </template>
                                  
                                        <template x-if="resourcesById[a.resourceId]?.maySub">
                                          <div class="resource-tipbox-item">
                                            <span class="resource-tipbox-label">➜ May sub:</span>
                                            <span class="resource-tipbox-text" x-text="resourcesById[a.resourceId]?.maySub"></span>
                                          </div>
                                        </template>
                                      </div>
                                  
                                    </div>
                                  
                                    <!-- DIVIDER -->
                                    <div class="resource-info-divider" aria-hidden="true"></div>
                                  
                                    <!-- RIGHT (narrow): shared + scope from assignment -->
                                    <div class="resource-info-right">
                                  
                                      <div class="resource-meta-block" x-show="assignmentSharedR3Text(a)" x-cloak>
                                        <div class="resource-meta-label">↔ Shared</div>
                                        <div class="resource-meta-text" x-text="assignmentSharedR3Text(a)"></div>
                                      </div>
                                  
                                      <div class="resource-meta-block" x-show="assignmentScopeText(a)" x-cloak>
                                        <div class="resource-meta-label">Scope</div>
                                        <div class="resource-meta-text" x-text="assignmentScopeText(a)"></div>
                                      </div>
                                  
                                    </div>
                                  </div>

                                  </div>
                                </div>

                              </template>
                            </div>
                            <!-- Topic notes panel -->
                            <div
                              class="note-panel"
                              x-show="topic.noteOpen"
                              x-transition
                              :style="{ backgroundColor: subjectColor(course.subject) + '4D' }"
                            >
                              <label class="note-label">Notes</label>
                              <textarea
                                class="note-textarea"
                                placeholder="Add notes for this topic..."
                                :value="topicNoteText(topic)"
                                @input="updateTopicNoteText(topic, $event.target.value)"
                                :style="{ backgroundColor: subjectColor(course.subject) + '1A' }"
                              ></textarea>
                            </div>
                            <!-- Student rail toggle (topic) -->
                            <div
                                class="student-rail-toggle-row"
                                x-show="(course.studentCount != null ? course.studentCount : assignedStudentCount(course)) > 0"
                                x-cloak
                              >
                              <button
                                type="button"
                                class="student-rail-toggle"
                                :aria-expanded="!isStudentRailCollapsed(studentRailKeyForTopic(topic))"
                                @click.stop="toggleStudentRailCollapsed(studentRailKeyForTopic(topic))"
                                aria-label="Toggle student assignments"
                              >
                                <!-- PERSON ICON + BADGE (anchored together) -->
                                <span style="position:relative; display:inline-flex; align-items:center; justify-content:center;">
                                  <!-- person icon -->
                                  <svg class="student-rail-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <circle cx="12" cy="8" r="3.2" fill="currentColor"></circle>
                                    <path
                                      d="M4.5 20c0-3.9 3.7-6.8 7.5-6.8s7.5 2.9 7.5 6.8"
                                      fill="currentColor">
                                    </path>
                                  </svg>
                                
                                  <!-- count badge -->
                                  <span
                                    class="student-count-badge"
                                    style="position:absolute; right:-6px; bottom:-6px;"
                                    x-show="assignedStudentCount(topic) > 0"
                                    x-text="assignedStudentCount(topic)"
                                  ></span>
                                </span>
                                
                                <!-- CHEVRON -->
                                <svg class="student-rail-wedge" viewBox="0 0 24 24" aria-hidden="true">
                                  <path
                                    d="M7 10l5 5 5-5"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round">
                                  </path>
                                </svg>
                              </button>
                            
                              <!-- Add-students "+" (shows only when rail is OPEN) -->
                              <template x-if="!isStudentRailCollapsed(studentRailKeyForTopic(topic))">
                                <button
                                  type="button"
                                  class="planning-tag-add"
                                  aria-label="Assign students"
                                  @click.stop="openStudentAssignMenu($event, topic)"
                                >+</button>
                              </template>

                                <!-- Assigned-students chips (topic instance) -->
                                <template x-if="!isStudentRailCollapsed(studentRailKeyForTopic(topic))">
                                <div class="student-chip-row" aria-label="Assigned students">
                                  <!-- Active (this instance) -->
                                  <template x-for="sid in (topic.studentIds || [])" :key="'topic-stu-' + sid">
                                    <template x-if="getStudentById(sid)">
                                      <span
                                        class="student-chip"
                                        :title="getStudentById(sid).name"
                                        :aria-label="getStudentById(sid).name"
                                        :style="{ '--stu': (getStudentById(sid).color || '#9eaa99') }"
                                      >
                                        <span class="student-chip-text" x-text="getStudentById(sid).name"></span>
                                
                                        <!-- tiny remove X -->
                                        <button
                                          type="button"
                                          class="student-chip-remove"
                                          aria-label="Remove student"
                                          @click.stop="removeStudentAssignment(topic, sid)"
                                        >×</button>
                                      </span>
                                    </template>
                                  </template>
                                
                                  <!-- Ghosts (assigned on other instances of same Topic_ID) -->
                                  <template x-if="missingGlobalStudentsForItem(topic).some(sid => getStudentById(sid))">
                                    <span class="student-ghost-marker" title="Assigned elsewhere">↪</span>
                                  </template>
                                
                                  <template x-for="sid in missingGlobalStudentsForItem(topic)" :key="'topic-stu-ghost-' + sid">
                                    <template x-if="getStudentById(sid)">
                                      <span
                                        class="student-chip student-chip--ghost"
                                        :title="getStudentById(sid).name + ' (assigned elsewhere)'"
                                        :aria-label="getStudentById(sid).name + ' (assigned elsewhere)'"
                                      >
                                        <span class="student-chip-text" x-text="getStudentById(sid).name"></span>
                                  
                                        <!-- tiny "+" to apply this ghost student here -->
                                        <button
                                          type="button"
                                          class="student-chip-apply"
                                          @click.stop="applyGlobalStudentToItem(topic, sid)"
                                          aria-label="Assign student here"
                                          title="Assign here"
                                        >+</button>
                                      </span>
                                    </template>
                                  </template>
                                </div>
                                  
                              </template>
                            </div>
                          </article>

                        </template>
                      </div>

                      <!-- Course notes panel (topic-less courses only) -->
                      <template x-if="!course.topics || course.topics.length === 0">
                        <div
                          class="note-panel"
                          x-show="course.noteOpen"
                          x-transition
                          :style="{ backgroundColor: subjectColor(course.subject) + '4D' }"
                        >
                          <label class="note-label">Notes</label>
                          <textarea
                            class="note-textarea"
                            placeholder="Add notes for this course..."
                            :value="courseNoteText(course)"
                            @input="updateCourseNoteText(course, $event.target.value)"
                            :style="{ backgroundColor: subjectColor(course.subject) + '1A' }"
                          ></textarea>
                        </div>
                      </template>

                      <template x-if="!course.topics || course.topics.length === 0">
                      <!-- Student rail toggle (course - only when no topics) -->
                      <div
                          class="student-rail-toggle-row"
                          x-show="(course.studentCount != null ? course.studentCount : assignedStudentCount(course)) > 0"
                          x-cloak
                        >
                        <button
                          type="button"
                          class="student-rail-toggle"
                          :aria-expanded="!isStudentRailCollapsed(studentRailKeyForCourse(course))"
                          @click.stop="toggleStudentRailCollapsed(studentRailKeyForCourse(course))"
                          aria-label="Toggle student assignments"
                        >
                          <!-- PERSON ICON + BADGE (badge anchored to icon, not chevron) -->
                          <span style="position:relative; display:inline-flex; align-items:center; justify-content:center;">
                            <!-- solid filled person icon -->
                            <svg class="student-rail-icon" viewBox="0 0 24 24" aria-hidden="true">
                              <circle cx="12" cy="8" r="3.2" fill="currentColor"></circle>
                              <path
                                d="M4.5 20c0-3.9 3.7-6.8 7.5-6.8s7.5 2.9 7.5 6.8"
                                fill="currentColor">
                              </path>
                            </svg>
                          
                            <!-- badge anchored to the person icon -->
                            <span
                              class="student-count-badge"
                              style="position:absolute; right:-6px; bottom:-6px;"
                              x-show="((course.studentCount != null ? course.studentCount : assignedStudentCount(course)) > 0)"
                              x-text="(course.studentCount != null ? course.studentCount : assignedStudentCount(course))"
                            ></span>
                          </span>
                          
                          <!-- chevron / wedge -->
                          <svg class="student-rail-wedge" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                              d="M7 10l5 5 5-5"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round">
                            </path>
                          </svg>
                        </button>
                    
                        <!-- Add-students "+" (shows only when rail is OPEN) -->
                        <template x-if="!isStudentRailCollapsed(studentRailKeyForCourse(course))">
                          <button
                            type="button"
                            class="planning-tag-add"
                            aria-label="Assign students"
                            @click.stop="openStudentAssignMenu($event, course)"
                          >+</button>
                        </template>

                        <!-- Assigned-students chips (course) -->
                        <template x-if="!isStudentRailCollapsed(studentRailKeyForCourse(course))">
                          <div class="student-chip-row" aria-label="Assigned students">
                            <template x-for="sid in (course.studentIds || [])" :key="'course-stu-' + sid">
                              <template x-if="getStudentById(sid)">
                                <span
                                  class="student-chip"
                                  :title="getStudentById(sid).name"
                                  :aria-label="getStudentById(sid).name"
                                  :style="{ '--stu': (getStudentById(sid).color || '#9eaa99') }"
                                >
                                  <span class="student-chip-text" x-text="getStudentById(sid).name"></span>
                          
                                  <!-- tiny remove X -->
                                  <button
                                    type="button"
                                    class="student-chip-remove"
                                    aria-label="Remove student"
                                    @click.stop="removeStudentAssignment(course, sid)"
                                  >×</button>
                                </span>
                              </template>
                            </template>
                          </div>
                        </template> 
                          
                          <!-- TODO(cleanup): If we remove “ghost students”, delete student-chip--ghost and ghost logic in studentChipsForItem -->
                        
                      </div>
                    </template>
                      
                    </article>
                  </template>
                </div>
              </section>
              
            </template>
          </div>
        </template>
      </div>

      <!-- Global planning-tag menu (modal-style, for both courses & topics) -->
      <div
        x-show="planningMenuOpen"
        x-transition
        x-cloak
        class="fixed inset-0 z-50"
      >
        <!-- click-away backdrop -->
        <div class="absolute inset-0" @click="closePlanningMenu()"></div>

        <!-- floating menu positioned near the clicked button -->
        <div
          class="planning-tag-menu fixed"
          :style="`top:${planningMenuY}px; left:${planningMenuX}px;`"
          @click.stop
        >
          <template x-for="opt in planningTagOptions" :key="opt.id">
            <button
              type="button"
              class="planning-tag-option"
              @click="togglePlanningTag(planningMenuItem, opt)"
            >
              <span class="planning-tag-option-main">
                <img :src="opt.img" :alt="opt.label" />
                <span x-text="opt.label"></span>
              </span>
              <span
                class="filter-dropdown-check"
                x-show="
                  planningMenuItem &&
                  planningMenuItem.planningTags &&
                  planningMenuItem.planningTags.some(t => t.id === opt.id)
                "
              >
                ✓
              </span>
            </button>
          </template>
        </div>
      </div>

      <!-- Global student-assign menu (modal-style, for both courses & topics) -->
      <div
        x-show="studentAssignMenuOpen"
        x-transition
        x-cloak
        class="fixed inset-0 z-50"
      >
        <!-- click-away backdrop -->
        <div class="absolute inset-0" @click="closeStudentAssignMenu()"></div>

        <!-- floating menu positioned near the clicked "+" -->
        <div
          class="planning-tag-menu fixed"
          :style="`top:${studentAssignMenuY}px; left:${studentAssignMenuX}px;`"
          @click.stop
        >
          <template x-if="!students || students.length === 0">
            <div class="p-3 text-sm opacity-70">No students yet.</div>
          </template>

          <template x-for="st in (students || [])" :key="st.id">
            <button
              type="button"
              class="planning-tag-option"
              @click="
                toggleStudentAssignment(studentAssignMenuItem, st);
                closeStudentAssignMenu();
              "
            >
              <span class="student-dd-row">
                <span class="student-dd-swatch" :style="{ backgroundColor: (st.color || '#999') }"></span>
                <span x-text="st.name"></span>
              </span>
          
              <span
                class="filter-dropdown-check"
                x-show="isStudentAssigned(studentAssignMenuItem, st.id)"
              >
                ✓
              </span>
            </button>
          </template>
        </div>
      </div>

    </section>

  </main>

  <!-- Print Tip Modal (screen-only) -->
  <div
    x-show="printTipOpen"
    x-cloak
    class="print-tip-overlay"
    @keydown.escape.window="closePrintTip()"
  >
    <div class="print-tip-backdrop" @click="closePrintTip()"></div>
  
    <div class="print-tip-modal" role="dialog" aria-modal="true" aria-label="Print tips" @click.stop>
      <div class="print-tip-title">Best print settings</div>
  
      <div class="print-tip-body">
        <p><strong>For the cleanest print/PDF:</strong></p>
        <ul>
          <li>Set <strong>Margins</strong> to <strong>Custom: 0.5"</strong> on all sides</li>
          <li>Turn <strong>Headers and footers</strong> <strong>OFF</strong></li>
        </ul>
      </div>
  
      <label class="print-tip-checkbox">
        <input type="checkbox" x-model="printTipDontShowAgain" />
        Don’t show this again
      </label>
  
      <div class="print-tip-actions">
        <button type="button" class="print-tip-btn" @click="closePrintTip()">Cancel</button>
        <button type="button" class="print-tip-btn print-tip-btn-primary" @click="confirmPrintTipAndPrint()">
          Continue to Print
        </button>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  
  <!-- Authentication Bootstrapping (wrap the global coursePlanner() function) -->
  <script type="module">
    import { getCurrentUser } from "./js/auth.js";
  
    const originalCoursePlanner = window.coursePlanner;
  
    window.coursePlanner = function () {
      const original = originalCoursePlanner();
      const originalInit = original.init;
  
      return {
        ...original,
  
        user: { role: "anonymous" },
  
        get isStaff()  { return this.user?.role === "staff"; },
        get isMember() { return this.user?.role === "member"; },
        get isAnon()   { return !this.user?.role || this.user.role === "anonymous"; },
  
        async init() {
          this.user = await getCurrentUser();
        
          // ✅ DEV OVERRIDE (temporary): force staff when a local flag is set
          try {
            const devStaff = localStorage.getItem("ALVEARY_DEV_STAFF") === "1";
            if (devStaff) this.user = { role: "staff" };
          } catch (e) {}
        
          if (typeof originalInit === "function") {
            await originalInit.call(this);
          }
        },
      };
    };
  </script>

  <script src="js/books.js"></script>

  <!-- ✅ Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Print-only page numbers (Paged.js loads only when printing) -->
  <script>
    // Tell Paged.js: do NOT auto-run on page load
    window.PagedConfig = { auto: false };
  
    function loadPagedJsOnce() {
      return new Promise((resolve, reject) => {
        if (window.PagedPolyfill) return resolve();
        const s = document.createElement("script");
        s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Paged.js"));
        document.head.appendChild(s);
      });
    }
  
    //Print with real page numbers WITHOUT breaking the live app
    <script>
      function stripScripts(docEl) {
        docEl.querySelectorAll("script").forEach(s => s.remove());
      }
    
      function closeOpenUi(alpineRoot) {
        // optional: close the left Planning Tag menu if it’s open
        // (only runs if Alpine variables exist)
        try {
          const data = window.Alpine && window.Alpine.$data ? window.Alpine.$data(alpineRoot) : null;
          if (data) {
            data.gradeDropdownOpen = false;
            data.subjectDropdownOpen = false;
            data.tagDropdownOpen = false;
            data.planningMenuOpen = false;
          }
        } catch (e) {}
      }
    
      async function loadPagedInto(win) {
        return new Promise((resolve, reject) => {
          const s = win.document.createElement("script");
          s.src = "https://unpkg.com/pagedjs/dist/paged.polyfill.js";
          s.onload = resolve;
          s.onerror = () => reject(new Error("Failed to load Paged.js"));
          win.document.head.appendChild(s);
        });
      }
    
      window.alvearyPrintWithPaged = async function () {
        // 1) Ensure dropdowns/menus close in the LIVE UI before snapshot
        const root = document.querySelector("[x-data]");
        if (root) closeOpenUi(root);
    
        // Let Alpine finish DOM updates
        await new Promise(r => setTimeout(r, 50));
    
        // 2) Clone the current, already-rendered DOM
        const cloned = document.documentElement.cloneNode(true);
    
        // 3) Remove scripts so the print window doesn’t re-run the whole app
        stripScripts(cloned);
    
        // 4) Open a dedicated print window with the snapshot HTML
        const w = window.open("", "_blank", "noopener,noreferrer");
        if (!w) {
          // popup blocked → fall back
          window.print();
          return;
        }
    
        w.document.open();
        w.document.write("<!doctype html>" + cloned.outerHTML);
        w.document.close();
    
        // 5) In the print window, load Paged.js and print
        try {
          // Prevent auto-run
          w.PagedConfig = { auto: false };
    
          await loadPagedInto(w);
    
          // Wait a beat for styles/fonts
          await new Promise(r => setTimeout(r, 100));
    
          await w.PagedPolyfill.preview();
          w.focus();
          w.print();
    
          // Close the print window after printing
          w.addEventListener("afterprint", () => {
            try { w.close(); } catch (e) {}
          });
        } catch (e) {
          console.warn(e);
          w.focus();
          w.print();
          w.addEventListener("afterprint", () => {
            try { w.close(); } catch (e) {}
          });
        }
      };
    </script>
  
  </script>
  
</body>
</html>
